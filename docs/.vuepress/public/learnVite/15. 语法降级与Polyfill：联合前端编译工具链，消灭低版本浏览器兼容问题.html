<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<!--    <title>Title</title>-->
    <style>
        body {
    font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial !important;
}

.markdown-body {
    word-break: break-word;
    line-height: 1.75;
    font-weight: 400;
    font-size: 16px;
    overflow-x: hidden;
    color: #333
}

.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    line-height: 1.5;
    margin-top: 35px;
    margin-bottom: 10px;
    padding-bottom: 5px
}

.markdown-body h1 {
    font-size: 24px;
    margin-bottom: 5px
}

.markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    font-size: 20px
}

.markdown-body h2 {
    padding-bottom: 12px;
    border-bottom: 1px solid #ececec
}

.markdown-body h3 {
    font-size: 18px;
    padding-bottom: 0
}

.markdown-body h6 {
    margin-top: 5px
}

.markdown-body p {
    line-height: inherit;
    margin-top: 22px;
    margin-bottom: 22px
}

.markdown-body img {
    max-width: 100%
}

.markdown-body hr {
    border: none;
    border-top: 1px solid #ddd;
    margin-top: 32px;
    margin-bottom: 32px
}

.markdown-body code {
    word-break: break-word;
    border-radius: 2px;
    overflow-x: auto;
    background-color: #fff5f5;
    color: #ff502c;
    font-size: .87em;
    padding: .065em .4em
}

.markdown-body code, .markdown-body pre {
    font-family: Menlo, Monaco, Consolas, Courier New, monospace
}

.markdown-body pre {
    overflow: auto;
    position: relative;
    line-height: 1.75
}

.markdown-body pre > code {
    font-size: 12px;
    padding: 15px 12px;
    margin: 0;
    word-break: normal;
    display: block;
    overflow-x: auto;
    color: #333;
    background: #f8f8f8
}

.markdown-body a {
    text-decoration: none;
    color: #0269c8;
    border-bottom: 1px solid #d1e9ff
}

.markdown-body a:active, .markdown-body a:hover {
    color: #275b8c
}

.markdown-body table {
    display: inline-block !important;
    font-size: 12px;
    width: auto;
    max-width: 100%;
    overflow: auto;
    border: 1px solid #f6f6f6
}

.markdown-body thead {
    background: #f6f6f6;
    color: #000;
    text-align: left
}

.markdown-body tr:nth-child(2n) {
    background-color: #fcfcfc
}

.markdown-body td, .markdown-body th {
    padding: 12px 7px;
    line-height: 24px
}

.markdown-body td {
    min-width: 120px
}

.markdown-body blockquote {
    color: #666;
    padding: 1px 23px;
    margin: 22px 0;
    border-left: 4px solid #cbcbcb;
    background-color: #f8f8f8
}

.markdown-body blockquote:after {
    display: block;
    content: ""
}

.markdown-body blockquote > p {
    margin: 10px 0
}

.markdown-body ol, .markdown-body ul {
    padding-left: 28px
}

.markdown-body ol li, .markdown-body ul li {
    margin-bottom: 0;
    list-style: inherit
}

.markdown-body ol li .task-list-item, .markdown-body ul li .task-list-item {
    list-style: none
}

.markdown-body ol li .task-list-item ol, .markdown-body ol li .task-list-item ul, .markdown-body ul li .task-list-item ol, .markdown-body ul li .task-list-item ul {
    margin-top: 0
}

.markdown-body ol ol, .markdown-body ol ul, .markdown-body ul ol, .markdown-body ul ul {
    margin-top: 3px
}

.markdown-body ol li {
    padding-left: 6px
}

.markdown-body .contains-task-list {
    padding-left: 0
}

.markdown-body .task-list-item {
    list-style: none
}

@media (max-width: 720px) {
    .markdown-body h1 {
        font-size: 24px
    }

    .markdown-body h2 {
        font-size: 20px
    }

    .markdown-body h3 {
        font-size: 18px
    }
}
    </style>
</head>
<body>
<div class="markdown-body">
    <p>è°ˆåˆ° Viteï¼Œå¯èƒ½å¾ˆå¤šäººéƒ½è§‰å¾—è¿™æ˜¯ä¸€ä¸ªç°ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼Œåº”è¯¥åœ¨ç°ä»£æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œæ”¾åˆ°å„ç§è¯­æ³•ç‰¹æ€§éƒ½ç¼ºå¤±çš„ä½ç‰ˆæœ¬æµè§ˆå™¨(å¦‚ <code>ie 11</code>)å°±ä¸é€‚ç”¨äº†ã€‚è¿™ç§è§‚å¿µå¯¹ä¸å¯¹å‘¢ï¼Ÿé¦–å…ˆè·Ÿå¤§å®¶æŠ›å‡ºç»“è®º:</p>
<blockquote>
<p>é€šè¿‡ Vite æ„å»ºæˆ‘ä»¬å®Œå…¨å¯ä»¥å…¼å®¹å„ç§ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œæ‰“åŒ…å‡ºæ—¢æ”¯æŒç°ä»£(<code>Modern</code>)æµè§ˆå™¨åˆæ”¯æŒæ—§ç‰ˆ(<code>Legacy</code>)æµè§ˆå™¨çš„äº§ç‰©ã€‚</p>
</blockquote>
<p>æ¥ä¸‹é‡Œçš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘å°±æ¥ä¸ä½ åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨ Vite ä¸­èƒ½å¤Ÿå½»åº•è§£å†³ä½ç‰ˆæœ¬æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä»¥åŠé€šè¿‡ä»€ä¹ˆæ‰‹æ®µè§£å†³ï¼Œéœ€è¦å€ŸåŠ©å“ªäº› JS çš„å·¥å…·å’Œç”Ÿæ€ã€‚ä½ ä¼šé¢†ç•¥åˆ°è¯¸å¤šå‰ç«¯ç¼–è¯‘å·¥å…·é“¾åº•å±‚çš„é£å…‰ï¼Œæ¯”å¦‚<code>@babel/preset-env</code>ã€<code>core-js</code>ã€<code>regenerator-runtime</code>ç­‰ç­‰å·¥å…·å’ŒåŸºç¡€åº“æ˜¯å¦‚ä½•å¼ºå¼ºè”åˆçš„ï¼Œå½“ç„¶ï¼Œæˆ‘ä¹Ÿä¼šä»¥å®˜æ–¹çš„ Vite æ’ä»¶<code>@vitejs/plugin-legacy</code>ä¸ºä¾‹å‘Šè¯‰ä½ å¦‚ä½•å°†è¿™äº›åº•å±‚çš„å·¥å…·é“¾æ¥å…¥åˆ° Vite ä¸­ï¼Œå¹¶å®ç°å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h2>åœºæ™¯å¤ç°</h2>
<p>é¦–å…ˆæˆ‘ä»¬æ¥å¤ç°ä¸€ä¸‹é—®é¢˜åœºæ™¯ï¼Œä¸‹é¢ä¸¤å¼ å›¾ä»£è¡¨äº†ä¹‹å‰æˆ‘åœ¨çº¿ä¸Šç¯å¢ƒçœŸå®é‡åˆ°çš„æŠ¥é”™æ¡ˆä¾‹:</p>
<p><img src="img\c1ecdf45-ae61-11ed-b9d5-342eb7027b95.jpg" alt="image.png"></p>
<p><img src="img\c20b93d2-ae61-11ed-a59d-342eb7027b95.jpg" alt="image.png"></p>
<p>æŸäº›ä½ç‰ˆæœ¬æµè§ˆå™¨å¹¶æ²¡æœ‰æä¾› <code>Promise</code> è¯­æ³•ç¯å¢ƒä»¥åŠå¯¹è±¡å’Œæ•°ç»„çš„å„ç§ APIï¼Œç”šè‡³ä¸æ”¯æŒç®­å¤´å‡½æ•°è¯­æ³•ï¼Œä»£ç ç›´æ¥æŠ¥é”™ï¼Œä»è€Œå¯¼è‡´çº¿ä¸Šç™½å±äº‹æ•…çš„å‘ç”Ÿï¼Œå°¤å…¶æ˜¯éœ€è¦å…¼å®¹åˆ°<code>IE 11</code>ã€<code>iOS 9</code>ä»¥åŠ<code>Android 4.4</code>çš„åœºæ™¯ä¸­å¾ˆå®¹æ˜“ä¼šé‡åˆ°ã€‚</p>
<p>æ—§ç‰ˆæµè§ˆå™¨çš„è¯­æ³•å…¼å®¹é—®é¢˜ä¸»è¦åˆ†ä¸¤ç±»: <strong>è¯­æ³•é™çº§é—®é¢˜</strong>å’Œ <strong>Polyfill ç¼ºå¤±é—®é¢˜</strong>ã€‚å‰è€…æ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯”å¦‚æŸäº›æµè§ˆå™¨ä¸æ”¯æŒç®­å¤´å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†å…¶è½¬æ¢ä¸º<code>function(){}</code>è¯­æ³•ï¼›è€Œå¯¹åè€…æ¥è¯´ï¼Œ<code>Polyfill</code>æœ¬èº«å¯ä»¥ç¿»è¯‘ä¸º<code>å«ç‰‡</code>ï¼Œä¹Ÿå°±æ˜¯ä¸ºæµè§ˆå™¨æå‰æ³¨å…¥ä¸€äº› API çš„å®ç°ä»£ç ï¼Œå¦‚<code>Object.entries</code>æ–¹æ³•çš„å®ç°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº§ç‰©å¯ä»¥æ­£å¸¸ä½¿ç”¨è¿™äº› APIï¼Œé˜²æ­¢æŠ¥é”™ã€‚</p>
<p>è¿™ä¸¤ç±»é—®é¢˜æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å‰ç«¯çš„ç¼–è¯‘å·¥å…·é“¾(å¦‚<code>Babel</code>)åŠ JS çš„åŸºç¡€ Polyfill åº“(å¦‚<code>corejs</code>)æ¥è§£å†³çš„ï¼Œä¸ä¼šè·Ÿå…·ä½“çš„æ„å»ºå·¥å…·æ‰€ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºè¿™äº›æœ¬è´¨çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨å…¶å®ƒçš„æ„å»ºå·¥å…·(å¦‚ Webpack)èƒ½ä½¿ç”¨ï¼Œåœ¨ Vite å½“ä¸­ä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>æ„å»ºå·¥å…·è€ƒè™‘çš„ä»…ä»…æ˜¯å¦‚ä½•å°†è¿™äº›åº•å±‚åŸºç¡€è®¾æ–½æ¥å…¥åˆ°æ„å»ºè¿‡ç¨‹çš„é—®é¢˜ï¼Œè‡ªå·±å¹¶ä¸éœ€è¦æä¾›åº•å±‚çš„è§£å†³æ–¹æ¡ˆï¼Œæ­£æ‰€è°“<code>æœ¯ä¸šæœ‰ä¸“æ”»</code>ï¼ŒæŠŠä¸“ä¸šçš„äº‹æƒ…äº¤ç»™ä¸“ä¸šçš„å·¥å…·å»åšã€‚æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘å°±æ¥å¸¦ä½ ç†Ÿæ‚‰ä¸€ä¸‹æ‰€è°“<code>ä¸“ä¸šçš„å·¥å…·</code>åˆ°åº•æœ‰å“ªäº›ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·ã€‚</p>
<h2>åº•å±‚å·¥å…·é“¾</h2>
<h3>1. å·¥å…·æ¦‚è§ˆ</h3>
<p>è§£å†³ä¸Šè¿°æåˆ°çš„ä¸¤ç±»è¯­æ³•å…¼å®¹é—®é¢˜ï¼Œä¸»è¦éœ€è¦ç”¨åˆ°ä¸¤æ–¹é¢çš„å·¥å…·ï¼Œåˆ†åˆ«åŒ…æ‹¬:</p>
<ul>
<li>
<p><strong>ç¼–è¯‘æ—¶å·¥å…·</strong>ã€‚ä»£è¡¨å·¥å…·æœ‰<code>@babel/preset-env</code>å’Œ<code>@babel/plugin-transform-runtime</code>ã€‚</p>
</li>
<li>
<p><strong>è¿è¡Œæ—¶åŸºç¡€åº“</strong>ã€‚ä»£è¡¨åº“åŒ…æ‹¬<code>core-js</code>å’Œ<code>regenerator-runtime</code>ã€‚</p>
</li>
</ul>
<p><strong>ç¼–è¯‘æ—¶å·¥å…·</strong>çš„ä½œç”¨æ˜¯åœ¨ä»£ç ç¼–è¯‘é˜¶æ®µè¿›è¡Œ<strong>è¯­æ³•é™çº§</strong>åŠ<strong>æ·»åŠ  <code>polyfill</code> ä»£ç çš„å¼•ç”¨è¯­å¥</strong>ï¼Œå¦‚:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/modules/es6.set.js"</span>
</code></pre>
<p>ç”±äºè¿™äº›å·¥å…·åªæ˜¯ç¼–è¯‘é˜¶æ®µç”¨åˆ°ï¼Œè¿è¡Œæ—¶å¹¶ä¸éœ€è¦ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ”¾å…¥<code>package.json</code>ä¸­çš„<code>devDependencies</code>ä¸­ã€‚</p>
<p>è€Œ<strong>è¿è¡Œæ—¶åŸºç¡€åº“</strong>æ˜¯æ ¹æ® <code>ESMAScript</code>å®˜æ–¹è¯­è¨€è§„èŒƒæä¾›å„ç§<code>Polyfill</code>å®ç°ä»£ç ï¼Œä¸»è¦åŒ…æ‹¬<code>core-js</code>å’Œ<code>regenerator-runtime</code>ä¸¤ä¸ªåŸºç¡€åº“ï¼Œä¸è¿‡åœ¨ babel ä¸­ä¹Ÿä¼šæœ‰ä¸€äº›ä¸Šå±‚çš„å°è£…ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><a href="https://babeljs.io/docs/en/babel-polyfill" target="_blank" rel="nofollow noopener noreferrer">@babel/polyfill</a></li>
<li><a href="https://babeljs.io/docs/en/babel-runtime" target="_blank" rel="nofollow noopener noreferrer">@babel/runtime</a></li>
<li><a href="https://babeljs.io/docs/en/babel-runtime-corejs2" target="_blank" rel="nofollow noopener noreferrer">@babel/runtime-corejs2</a></li>
<li><a href="https://babeljs.io/docs/en/babel-runtime-corejs3" target="_blank" rel="nofollow noopener noreferrer">@babel/runtime-corejs3</a></li>
</ul>
<p>çœ‹ä¼¼å„ç§è¿è¡Œæ—¶åº“çœ¼èŠ±ç¼­ä¹±ï¼Œå…¶å®éƒ½æ˜¯<code>core-js</code>å’Œ<code>regenerator-runtime</code>ä¸åŒç‰ˆæœ¬çš„å°è£…ç½¢äº†(<code>@babel/runtime</code>æ˜¯ä¸ªç‰¹ä¾‹ï¼Œä¸åŒ…å« core-js çš„ Polyfill)ã€‚è¿™ç±»åº“æ˜¯é¡¹ç›®è¿è¡Œæ—¶å¿…é¡»è¦ä½¿ç”¨åˆ°çš„ï¼Œå› æ­¤ä¸€å®šè¦æ”¾åˆ°<code>package.json</code>ä¸­çš„<code>dependencies</code>ä¸­ï¼</p>
<h3>2. å®é™…ä½¿ç”¨</h3>
<p>äº†è§£äº†åŸºæœ¬æ¦‚å¿µåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥é€šè¿‡ä»£ç å®æ“çš„æ–¹å¼æ¥å­¦ä¹ è¿™äº›å·¥å…·ï¼Œä»£ç æˆ‘ä¹Ÿå·²ç»æ”¾åˆ°äº†<a href="https://github.com/sanyuan0704/juejin-book-vite/tree/main/polyfill/babel-test" target="_blank" rel="nofollow noopener noreferrer">ä»“åº“</a>ä¸­ï¼Œä½ å¯ä»¥å¯¹ç…§å­¦ä¹ ã€‚</p>
<p>å¦‚æœä½ æ²¡æ‹‰å–ä»“åº“çš„ä»£ç ï¼Œå¯ä»¥å…ˆæŒ‰ç…§å¦‚ä¸‹çš„å‘½ä»¤åˆå§‹åŒ–é¡¹ç›®:</p>
<pre><code>mkdir babel-test
npm init -y
</code></pre>
<p>ç„¶åå®‰è£…ä¸€äº›å¿…è¦çš„ä¾èµ–:</p>
<pre><code class="hljs language-bash">pnpm i @babel/cli @babel/core @babel/preset-env
</code></pre>
<p>æˆ‘è§£é‡Šä¸€ä¸‹å„ä¸ªä¾èµ–çš„ä½œç”¨:</p>
<ul>
<li><code>@babel/cli</code>: ä¸º babel å®˜æ–¹çš„è„šæ‰‹æ¶å·¥å…·ï¼Œå¾ˆé€‚åˆæˆ‘ä»¬ç»ƒä¹ ç”¨ã€‚</li>
<li><code>@babel/core</code>: babel æ ¸å¿ƒç¼–è¯‘åº“ã€‚</li>
<li><code>@babel/preset-env</code>: babel çš„é¢„è®¾å·¥å…·é›†ï¼ŒåŸºæœ¬ä¸º babel å¿…è£…çš„åº“ã€‚</li>
</ul>
<p>æ¥ç€æ–°å»º <code>src</code> ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹å¢åŠ <code>index.js</code>æ–‡ä»¶:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> func = <span class="hljs-keyword">async</span> () => {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">12123</span>)
}

<span class="hljs-built_in">Promise</span>.resolve().finally();
</code></pre>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œç¤ºä¾‹ä»£ç ä¸­æ—¢åŒ…å«äº†<code>é«˜çº§è¯­æ³•</code>ä¹ŸåŒ…å«ç°ä»£æµè§ˆå™¨çš„<code>API</code>ï¼Œæ­£å¥½å¯ä»¥é’ˆå¯¹è¯­æ³•é™çº§å’Œ Polyfill æ³¨å…¥ä¸¤ä¸ªåŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æ¥ä¸‹æ¥æ–°å»º<code>.babelrc.json</code>å³ babel çš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-string">"presets"</span>: [
    [
      <span class="hljs-string">"@babel/preset-env"</span>, 
      {
        <span class="hljs-comment">// æŒ‡å®šå…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬</span>
        <span class="hljs-string">"targets"</span>: {
          <span class="hljs-string">"ie"</span>: <span class="hljs-string">"11"</span>
        },
        <span class="hljs-comment">// åŸºç¡€åº“ core-js çš„ç‰ˆæœ¬ï¼Œä¸€èˆ¬æŒ‡å®šä¸ºæœ€æ–°çš„å¤§ç‰ˆæœ¬</span>
        <span class="hljs-string">"corejs"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-comment">// Polyfill æ³¨å…¥ç­–ç•¥ï¼Œåæ–‡è¯¦ç»†ä»‹ç»</span>
        <span class="hljs-string">"useBuiltIns"</span>: <span class="hljs-string">"usage"</span>,
        <span class="hljs-comment">// ä¸å°† ES æ¨¡å—è¯­æ³•è½¬æ¢ä¸ºå…¶ä»–æ¨¡å—è¯­æ³•</span>
        <span class="hljs-string">"modules"</span>: <span class="hljs-literal">false</span>
      }
    ]
  ]
}
</code></pre>
<p>å…¶ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„é…ç½®: <code>targets</code>å’Œ<code>usage</code>ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>targets</code> å‚æ•°æŒ‡å®šè¦å…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œä½ æ—¢å¯ä»¥å¡«å¦‚ä¸Šé…ç½®æ‰€ç¤ºçš„ä¸€ä¸ªå¯¹è±¡:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-string">"targets"</span>: {
    <span class="hljs-string">"ie"</span>: <span class="hljs-string">"11"</span>
  }
}
</code></pre>
<p>ä¹Ÿå¯ä»¥ç”¨ <a href="https://github.com/browserslist/browserslist" target="_blank" rel="nofollow noopener noreferrer">Browserslist</a> é…ç½®è¯­æ³•:</p>
<pre><code class="hljs language-ts">{ 
  <span class="hljs-comment">// ie ä¸ä½äº 11 ç‰ˆæœ¬ï¼Œå…¨çƒè¶…è¿‡ 0.5% ä½¿ç”¨ï¼Œä¸”è¿˜åœ¨ç»´æŠ¤æ›´æ–°çš„æµè§ˆå™¨</span>
  <span class="hljs-string">"targets"</span>: <span class="hljs-string">"ie >= 11, > 0.5%, not dead"</span>
}
</code></pre>
<p>Browserslist æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬è®¾ç½®ç›®æ ‡æµè§ˆå™¨çš„å·¥å…·ï¼Œä¸å…‰æ˜¯ Babel ç”¨åˆ°ï¼Œå…¶ä»–çš„ç¼–è¯‘å·¥å…·å¦‚<code>postcss-preset-env</code>ã€<code>autoprefix</code>ä¸­éƒ½æœ‰æ‰€åº”ç”¨ã€‚å¯¹äº<code>Browserslist</code>çš„é…ç½®å†…å®¹ï¼Œä½ æ—¢å¯ä»¥æ”¾åˆ° Babel è¿™ç§ç‰¹å®šå·¥å…·å½“ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨<code>package.json</code>ä¸­é€šè¿‡<code>browserslist</code>å£°æ˜:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// package.json</span>
{ 
  <span class="hljs-string">"browserslist"</span>: <span class="hljs-string">"ie >= 11"</span>
}
</code></pre>
<p>æˆ–è€…é€šè¿‡<code>.browserslistrc</code>è¿›è¡Œå£°æ˜:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// .browserslistrc</span>
ie >= <span class="hljs-number">11</span>
</code></pre>
<p>åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥å°†ä½¿ç”¨ä¸‹é¢è¿™äº›<strong>æœ€ä½³å®è·µé›†åˆ</strong>æ¥æè¿°ä¸åŒçš„æµè§ˆå™¨ç±»å‹ï¼Œå‡è½»é…ç½®è´Ÿæ‹…:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// ç°ä»£æµè§ˆå™¨</span>
last <span class="hljs-number">2</span> versions and since <span class="hljs-number">2018</span> and > <span class="hljs-number">0.5</span>%
<span class="hljs-comment">// å…¼å®¹ä½ç‰ˆæœ¬ PC æµè§ˆå™¨</span>
IE >= <span class="hljs-number">11</span>, > <span class="hljs-number">0.5</span>%, not dead
<span class="hljs-comment">// å…¼å®¹ä½ç‰ˆæœ¬ç§»åŠ¨ç«¯æµè§ˆå™¨</span>
iOS >= <span class="hljs-number">9</span>, Android >= <span class="hljs-number">4.4</span>, last <span class="hljs-number">2</span> versions, > <span class="hljs-number">0.2</span>%, not dead
</code></pre>
<p>å¯¹äºè¿™äº›é…ç½®å¯¹åº”çš„å…·ä½“æµè§ˆå™¨åˆ—è¡¨ï¼Œå¤§å®¶å¯ä»¥å» <a href="https://browserslist.dev" target="_blank" rel="nofollow noopener noreferrer">https://browserslist.dev</a> ç«™ç‚¹æŸ¥çœ‹:</p>
<p><img src="img\c24497be-ae61-11ed-b21b-342eb7027b95.jpg" alt="image.png"></p>
<p>å¥½ï¼Œåœ¨è¯´æ˜äº†ç›®æ ‡æµè§ˆå™¨çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å¦å¤–ä¸€ä¸ªé‡è¦çš„é…ç½®â€”â€”<code>useBuiltIns</code>ï¼Œå®ƒå†³å®šäº†æ·»åŠ  Polyfill ç­–ç•¥ï¼Œé»˜è®¤æ˜¯ <code>false</code>ï¼Œå³ä¸æ·»åŠ ä»»ä½•çš„ Polyfillã€‚ä½ å¯ä»¥æ‰‹åŠ¨å°†<code>useBuiltIns</code>é…ç½®ä¸º<code>entry</code>æˆ–è€…<code>usage</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¤ä¸ªé…ç½®ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>
<p>é¦–å…ˆä½ å¯ä»¥å°†è¿™ä¸ªå­—æ®µé…ç½®ä¸º<code>entry</code>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>entry</code>é…ç½®è§„å®šä½ å¿…é¡»åœ¨å…¥å£æ–‡ä»¶æ‰‹åŠ¨æ·»åŠ ä¸€è¡Œè¿™æ ·çš„ä»£ç :</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// index.js å¼€å¤´åŠ ä¸Š</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js'</span>;
</code></pre>
<p>æ¥ç€åœ¨ç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œ Babel ç¼–è¯‘:</p>
<pre><code class="hljs language-bash">npx babel src --out-dir dist
</code></pre>
<p>äº§ç‰©è¾“å‡ºåœ¨<code>dist</code>ç›®å½•ä¸­ï¼Œä½ å¯ä»¥å»è§‚å¯Ÿä¸€ä¸‹äº§ç‰©çš„ä»£ç :</p>
<p><img src="img\c2660073-ae61-11ed-9f92-342eb7027b95.jpg" alt="image.png"></p>
<p>Babel å·²ç»æ ¹æ®<code>ç›®æ ‡æµè§ˆå™¨</code>çš„é…ç½®ä¸ºæˆ‘ä»¬æ·»åŠ äº†å¤§é‡çš„ Polyfill ä»£ç ï¼Œ<code>index.js</code>æ–‡ä»¶ç®€å•çš„å‡ è¡Œä»£ç è¢«ç¼–è¯‘æˆè¿‘ 300 è¡Œã€‚å®é™…ä¸Šï¼ŒBabel æ‰€åšçš„äº‹æƒ…å°±æ˜¯å°†ä½ çš„<code>import "core-js"</code>ä»£ç æ›¿æ¢æˆäº†äº§ç‰©ä¸­çš„è¿™äº›å…·ä½“æ¨¡å—çš„å¯¼å…¥ä»£ç ã€‚</p>
<p>ä½†è¿™ä¸ªé…ç½®æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå³æ— æ³•åšåˆ°æŒ‰éœ€å¯¼å…¥ï¼Œä¸Šé¢çš„äº§ç‰©ä»£ç å…¶å®æœ‰å¤§éƒ¨åˆ†çš„ Polyfill çš„ä»£ç æˆ‘ä»¬å¹¶æ²¡æœ‰ç”¨åˆ°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯•è¯•<code>useBuiltIns: usage</code>è¿™ä¸ªæŒ‰éœ€å¯¼å…¥çš„é…ç½®ï¼Œæ”¹åŠ¨é…ç½®åæ‰§è¡Œç¼–è¯‘å‘½ä»¤:</p>
<pre><code class="hljs language-ts">npx babel src --out-dir dist
</code></pre>
<p>åŒæ ·å¯ä»¥çœ‹åˆ°äº§ç‰©è¾“å‡ºåœ¨äº†<code>dist/index.js</code>ä¸­ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="img\c2900fc5-ae61-11ed-bdab-342eb7027b95.jpg" alt="image.png"></p>
<blockquote>
<p>Polyfill ä»£ç ä¸»è¦æ¥è‡ª <code>corejs</code> å’Œ <code>regenerator-runtime</code>ï¼Œå› æ­¤å¦‚æœè¦è¿è¡Œèµ·æ¥ï¼Œå¿…é¡»è¦è£…è¿™ä¸¤ä¸ªåº“ã€‚</p>
</blockquote>
<p>å¯ä»¥å‘ç° Polyfill çš„ä»£ç ç²¾ç®€äº†è®¸å¤šï¼ŒçœŸæ­£åœ°å®ç°äº†æŒ‰éœ€ Polyfill å¯¼å…¥ã€‚å› æ­¤ï¼Œåœ¨å®é™…çš„ä½¿ç”¨å½“ä¸­ï¼Œè¿˜æ˜¯æ¨èå¤§å®¶å°½é‡ä½¿ç”¨<code>useBuiltIns: "usage"</code>ï¼Œè¿›è¡ŒæŒ‰éœ€çš„ Polyfill æ³¨å…¥ã€‚</p>
<p>æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ï¼Œä¸Šé¢æˆ‘ä»¬åˆ©ç”¨<code>@babel/preset-env</code>è¿›è¡Œäº†ç›®æ ‡æµè§ˆå™¨è¯­æ³•çš„é™çº§å’Œ<code>Polyfill</code>æ³¨å…¥ï¼ŒåŒæ—¶ç”¨åˆ°äº†<code>core-js</code>å’Œ<code>regenerator-runtime</code>ä¸¤ä¸ªæ ¸å¿ƒçš„è¿è¡Œæ—¶åº“ã€‚ä½†<code>@babel/preset-env</code> çš„æ–¹æ¡ˆä¹Ÿå­˜åœ¨ä¸€å®šå±€é™æ€§:</p>
<ul>
<li>
<ol>
<li>å¦‚æœä½¿ç”¨æ–°ç‰¹æ€§ï¼Œå¾€å¾€æ˜¯é€šè¿‡åŸºç¡€åº“(å¦‚ core-js)å¾€å…¨å±€ç¯å¢ƒæ·»åŠ  Polyfillï¼Œå¦‚æœæ˜¯å¼€å‘åº”ç”¨æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¦‚æœæ˜¯å¼€å‘ç¬¬ä¸‰æ–¹å·¥å…·åº“ï¼Œåˆ™å¾ˆå¯èƒ½ä¼šå¯¹<strong>å…¨å±€ç©ºé—´é€ æˆæ±¡æŸ“</strong>ã€‚</li>
</ol>
</li>
<li>
<ol start="2">
<li>å¾ˆå¤šå·¥å…·å‡½æ•°çš„å®ç°ä»£ç (å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„<code>_defineProperty</code>æ–¹æ³•)ï¼Œä¼šåœ¨è®¸å¤šæ–‡ä»¶ä¸­é‡ç°å‡ºç°ï¼Œé€ æˆ<strong>æ–‡ä»¶ä½“ç§¯å†—ä½™</strong>ã€‚</li>
</ol>
</li>
</ul>
<h3>3. æ›´ä¼˜çš„ Polyfill æ³¨å…¥æ–¹æ¡ˆ: transform-runtime</h3>
<p>æ¥ä¸‹æ¥è¦ä»‹ç»çš„<code>transform-runtime</code>æ–¹æ¡ˆï¼Œå°±æ˜¯ä¸ºäº†è§£å†³<code>@babel/preset-env</code>çš„ç§ç§å±€é™æ€§ã€‚</p>
<blockquote>
<p>éœ€è¦æå‰è¯´æ˜çš„æ˜¯ï¼Œ<code>transform-runtime</code>æ–¹æ¡ˆå¯ä»¥ä½œä¸º<code>@babel/preset-env</code>ä¸­<code>useBuiltIns</code>é…ç½®çš„æ›¿ä»£å“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ä½¿ç”¨<code>transform-runtime</code>æ–¹æ¡ˆï¼Œä½ åº”è¯¥æŠŠ<code>useBuiltIns</code>å±æ€§è®¾ä¸º <code>false</code>ã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼Œé¦–å…ˆå®‰è£…å¿…è¦çš„ä¾èµ–:</p>
<pre><code class="hljs language-ts">pnpm i <span class="hljs-meta">@babel</span>/plugin-transform-runtime -D
pnpm i <span class="hljs-meta">@babel</span>/runtime-corejs3 -S
</code></pre>
<p>æˆ‘è§£é‡Šä¸€ä¸‹è¿™ä¸¤ä¸ªä¾èµ–çš„ä½œç”¨: å‰è€…æ˜¯ç¼–è¯‘æ—¶å·¥å…·ï¼Œç”¨æ¥è½¬æ¢è¯­æ³•å’Œæ·»åŠ  Polyfillï¼Œåè€…æ˜¯è¿è¡Œæ—¶åŸºç¡€åº“ï¼Œå°è£…äº†<code>core-js</code>ã€<code>regenerator-runtime</code>å’Œå„ç§è¯­æ³•è½¬æ¢ç”¨åˆ°çš„<code>å·¥å…·å‡½æ•°</code>ã€‚</p>
<blockquote>
<p>core-js æœ‰ä¸‰ç§äº§ç‰©ï¼Œåˆ†åˆ«æ˜¯<code>core-js</code>ã€<code>core-js-pure</code>å’Œ<code>core-js-bundle</code>ã€‚ç¬¬ä¸€ç§æ˜¯å…¨å±€ Polyfill çš„åšæ³•ï¼Œ@babel/preset-env å°±æ˜¯ç”¨çš„è¿™ç§äº§ç‰©ï¼›ç¬¬äºŒç§ä¸ä¼šæŠŠ Polyfill æ³¨å…¥åˆ°å…¨å±€ç¯å¢ƒï¼Œå¯ä»¥æŒ‰éœ€å¼•å…¥ï¼›ç¬¬ä¸‰ç§æ˜¯æ‰“åŒ…å¥½çš„ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰çš„ Polyfillï¼Œä¸å¤ªå¸¸ç”¨ã€‚<code>@babel/runtime-corejs3</code> ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§äº§ç‰©ã€‚</p>
</blockquote>
<p>æ¥ç€æˆ‘ä»¬å¯¹<code>.babelrc.json</code>ä½œå¦‚ä¸‹çš„é…ç½®:</p>
<pre><code class="hljs language-json">{
  <span class="hljs-attr">"plugins"</span>: [
    <span class="hljs-comment">// æ·»åŠ  transform-runtime æ’ä»¶</span>
    [
      <span class="hljs-string">"@babel/plugin-transform-runtime"</span>, 
      {
        <span class="hljs-attr">"corejs"</span>: <span class="hljs-number">3</span>
      }
    ]
  ],
  <span class="hljs-attr">"presets"</span>: [
    [
      <span class="hljs-string">"@babel/preset-env"</span>, 
      {
        <span class="hljs-attr">"targets"</span>: {
          <span class="hljs-attr">"ie"</span>: <span class="hljs-string">"11"</span>
        },
        <span class="hljs-attr">"corejs"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-comment">// å…³é—­ @babel/preset-env é»˜è®¤çš„ Polyfill æ³¨å…¥</span>
        <span class="hljs-attr">"useBuiltIns"</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">"modules"</span>: <span class="hljs-literal">false</span>
      }
    ]
  ]
}
</code></pre>
<p>æ‰§è¡Œç»ˆç«¯å‘½ä»¤:</p>
<pre><code class="hljs language-ts">npx babel src --out-dir dist
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ <code>@babel/preset-env</code>ä¸‹çš„äº§ç‰©ç»“æœ:</p>
<p><img src="img\c2be000c-ae61-11ed-9e1e-342eb7027b95.jpg" alt="image.png"></p>
<p>ç»è¿‡å¯¹æ¯”æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œ<code>transform-runtime</code> ä¸€æ–¹é¢èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨<code>éå…¨å±€ç‰ˆæœ¬</code>çš„ Polyfillï¼Œè¿™æ ·å°±é¿å…å…¨å±€ç©ºé—´çš„æ±¡æŸ“ï¼Œè¿™ä¹Ÿå¾—ç›Šäº <code>core-js</code> çš„ pure ç‰ˆæœ¬äº§ç‰©ç‰¹æ€§ï¼›å¦ä¸€æ–¹é¢å¯¹äº<code>asyncToGeneator</code>è¿™ç±»çš„å·¥å…·å‡½æ•°ï¼Œå®ƒä¹Ÿå°†å…¶è½¬æ¢æˆäº†ä¸€æ®µå¼•å…¥è¯­å¥ï¼Œä¸å†å°†å®Œæ•´çš„å®ç°æ”¾åˆ°æ–‡ä»¶ä¸­ï¼ŒèŠ‚çœäº†ç¼–è¯‘åæ–‡ä»¶çš„ä½“ç§¯ã€‚</p>
<p>å¦å¤–ï¼Œ<code>transform-runtime</code>æ–¹æ¡ˆå¼•ç”¨çš„åŸºç¡€åº“ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ˜¯ç›´æ¥å¼•å…¥<code>core-js</code>å’Œ<code>regenerator-runtime</code>ï¼Œè€Œæ˜¯å¼•å…¥<code>@babel/runtime-corejs3</code>ã€‚</p>
<p>å¥½ï¼Œä»‹ç»å®Œäº† Babel è¯­æ³•é™çº§ä¸ Polyfill æ³¨å…¥çš„åº•å±‚æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ Vite ä¸­åˆ©ç”¨è¿™äº›æ–¹æ¡ˆæ¥è§£å†³ä½ç‰ˆæœ¬æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ã€‚</p>
<h2>Vite è¯­æ³•é™çº§ä¸ Polyfill æ³¨å…¥</h2>
<p>Vite å®˜æ–¹å·²ç»ä¸ºæˆ‘ä»¬å°è£…å¥½äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„æ–¹æ¡ˆ: <code>@vitejs/plugin-legacy</code>ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºå®ƒæ¥è§£å†³é¡¹ç›®è¯­æ³•çš„æµè§ˆå™¨å…¼å®¹é—®é¢˜ã€‚è¿™ä¸ªæ’ä»¶å†…éƒ¨åŒæ ·ä½¿ç”¨ <code>@babel/preset-env</code> ä»¥åŠ <code>core-js</code>ç­‰ä¸€ç³»åˆ—åŸºç¡€åº“æ¥è¿›è¡Œè¯­æ³•é™çº§å’Œ Polyfill æ³¨å…¥ï¼Œå› æ­¤æˆ‘è§‰å¾—å¯¹äºä¸Šæ–‡æ‰€ä»‹ç»çš„åº•å±‚å·¥å…·é“¾çš„æŒæ¡æ˜¯å¿…è¦çš„ï¼Œå¦åˆ™æ— æ³•ç†è§£æ’ä»¶å†…éƒ¨æ‰€åšçš„äº‹æƒ…ï¼ŒçœŸæ­£é‡åˆ°é—®é¢˜æ—¶å¾€å¾€ä¼šä¸çŸ¥æ‰€æªã€‚</p>
<h3>æ’ä»¶ä½¿ç”¨</h3>
<p>é¦–å…ˆè®©æˆ‘ä»¬æ¥å®‰è£…ä¸€ä¸‹å®˜æ–¹çš„æ’ä»¶:</p>
<pre><code class="hljs language-ts">pnpm i <span class="hljs-meta">@vitejs</span>/plugin-legacy -D
</code></pre>
<p>éšååœ¨é¡¹ç›®ä¸­ä½¿ç”¨å®ƒ:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">import</span> legacy <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-legacy'</span>;
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> defineConfig({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// çœç•¥å…¶å®ƒæ’ä»¶</span>
    legacy({
      <span class="hljs-comment">// è®¾ç½®ç›®æ ‡æµè§ˆå™¨ï¼Œbrowserslist é…ç½®è¯­æ³•</span>
      <span class="hljs-attr">targets</span>: [<span class="hljs-string">'ie >= 11'</span>],
    })
  ]
})
</code></pre>
<p>æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡<code>targets</code>æŒ‡å®šç›®æ ‡æµè§ˆå™¨ï¼Œè¿™ä¸ªå‚æ•°åœ¨æ’ä»¶å†…éƒ¨ä¼šé€ä¼ ç»™<code>@babel/preset-env</code>ã€‚</p>
<p>åœ¨å¼•å…¥æ’ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•æ‰§è¡Œ<code>npm run build</code>å¯¹é¡¹ç›®è¿›è¡Œæ‰“åŒ…ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„äº§ç‰©ä¿¡æ¯:</p>
<p><img src="img\c2e23a6d-ae61-11ed-9340-342eb7027b95.jpg" alt="image.png"></p>
<p>ç›¸æ¯”ä¸€èˆ¬çš„æ‰“åŒ…è¿‡ç¨‹ï¼Œå¤šå‡ºäº†<code>index-legacy.js</code>ã€<code>vendor-legacy.js</code>ä»¥åŠ<code>polyfills-legacy.js</code>ä¸‰ä»½äº§ç‰©æ–‡ä»¶ã€‚è®©æˆ‘ä»¬ç»§ç»­è§‚å¯Ÿä¸€ä¸‹<code>index.html</code>çš„äº§ç‰©å†…å®¹:</p>
<pre><code class="hljs language-html"><span class="hljs-meta">&#x3C;!DOCTYPE <span class="hljs-meta-keyword">html</span>></span>
<span class="hljs-tag">&#x3C;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">head</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/svg+xml"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/favicon.17e50649.svg"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">title</span>></span>Vite App<span class="hljs-tag">&#x3C;/<span class="hljs-name">title</span>></span>
    <span class="hljs-comment">&#x3C;!-- 1. Modern æ¨¡å¼äº§ç‰© --></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">crossorigin</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/index.c1383506.js"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"modulepreload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/vendor.0f99bfcc.js"</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/assets/index.91183920.css"</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">head</span>></span>
  <span class="hljs-tag">&#x3C;<span class="hljs-name">body</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"root"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">div</span>></span>
    <span class="hljs-comment">&#x3C;!-- 2. Legacy æ¨¡å¼äº§ç‰© --></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span>></span>å…¼å®¹ iOS nomodule ç‰¹æ€§çš„ polyfillï¼Œçœç•¥å…·ä½“ä»£ç <span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"vite-legacy-polyfill"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/polyfills-legacy.36fe2f9e.js"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
    <span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"vite-legacy-entry"</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">"/assets/index-legacy.c3d3f501.js"</span>></span><span class="javascript">System.import(<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">'vite-legacy-entry'</span>).getAttribute(<span class="hljs-string">'data-src'</span>))</span><span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
  <span class="hljs-tag">&#x3C;/<span class="hljs-name">body</span>></span>
<span class="hljs-tag">&#x3C;/<span class="hljs-name">html</span>></span>
</code></pre>
<p>é€šè¿‡å®˜æ–¹çš„<code>legacy</code>æ’ä»¶ï¼Œ Vite ä¼šåˆ†åˆ«æ‰“åŒ…å‡º<code>Modern</code>æ¨¡å¼å’Œ<code>Legacy</code>æ¨¡å¼çš„äº§ç‰©ï¼Œç„¶åå°†ä¸¤ç§äº§ç‰©æ’å…¥åŒä¸€ä¸ª HTML é‡Œé¢ï¼Œ<code>Modern</code>äº§ç‰©è¢«æ”¾åˆ° <code>type="module"</code>çš„ script æ ‡ç­¾ä¸­ï¼Œè€Œ<code>Legacy</code>äº§ç‰©åˆ™è¢«æ”¾åˆ°å¸¦æœ‰ <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-nomodule" target="_blank" rel="nofollow noopener noreferrer">nomodule</a> çš„ script æ ‡ç­¾ä¸­ã€‚æµè§ˆå™¨çš„åŠ è½½ç­–ç•¥å¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="img\c302bf99-ae61-11ed-97b6-342eb7027b95.jpg" alt="image.png"></p>
<p>è¿™æ ·äº§ç‰©ä¾¿å°±èƒ½å¤ŸåŒæ—¶æ”¾åˆ°ç°ä»£æµè§ˆå™¨å’Œä¸æ”¯æŒ<code>type="module"</code>çš„ä½ç‰ˆæœ¬æµè§ˆå™¨å½“ä¸­æ‰§è¡Œã€‚å½“ç„¶ï¼Œåœ¨å…·ä½“çš„ä»£ç è¯­æ³•å±‚é¢ï¼Œæ’ä»¶è¿˜éœ€è¦è€ƒè™‘è¯­æ³•é™çº§å’Œ Polyfill æŒ‰éœ€æ³¨å…¥çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ Vite çš„å®˜æ–¹<code>legacy</code>æ’ä»¶æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p>
<h3>æ’ä»¶æ‰§è¡ŒåŸç†</h3>
<p>å®˜æ–¹çš„<code>legacy</code>æ’ä»¶æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚åº¦æ¯”è¾ƒé«˜çš„æ’ä»¶ï¼Œç›´æ¥çœ‹æºç å¯èƒ½ä¼šå¾ˆéš¾ç†è§£ï¼Œè¿™é‡Œæˆ‘æ¢³ç†äº†ç”»äº†ä¸€å¼ ç®€åŒ–åçš„æµç¨‹å›¾ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®è¿™å¼ æµç¨‹å›¾æ¥ä¸€ä¸€æ‹†è§£è¿™ä¸ªæ’ä»¶åœ¨å„ä¸ªé’©å­é˜¶æ®µåˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚</p>
<p><img src="img\c31e7295-ae61-11ed-beaf-342eb7027b95.jpg" alt="image.png"></p>
<p>é¦–å…ˆæ˜¯åœ¨<code>configResolved</code>é’©å­ä¸­è°ƒæ•´äº†<code>output</code>å±æ€§ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯è®© Vite åº•å±‚ä½¿ç”¨çš„æ‰“åŒ…å¼•æ“ Rollup èƒ½å¦å¤–æ‰“åŒ…å‡ºä¸€ä»½<code>Legacy æ¨¡å¼</code>çš„äº§ç‰©ï¼Œå®ç°ä»£ç å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> createLegacyOutput = <span class="hljs-function">(<span class="hljs-params">options = {}</span>) =></span> {
  <span class="hljs-keyword">return</span> {
    ...options,
    <span class="hljs-comment">// system æ ¼å¼äº§ç‰©</span>
    <span class="hljs-attr">format</span>: <span class="hljs-string">'system'</span>,
    <span class="hljs-comment">// è½¬æ¢æ•ˆæœ: index.[hash].js -> index-legacy.[hash].js</span>
    <span class="hljs-attr">entryFileNames</span>: getLegacyOutputFileName(options.entryFileNames),
    <span class="hljs-attr">chunkFileNames</span>: getLegacyOutputFileName(options.chunkFileNames)
  }
}

<span class="hljs-keyword">const</span> { rollupOptions } = config.build
<span class="hljs-keyword">const</span> { output } = rollupOptions
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(output)) {
  rollupOptions.output = [...output.map(createLegacyOutput), ...output]
} <span class="hljs-keyword">else</span> {
  rollupOptions.output = [createLegacyOutput(output), output || {}]
}
</code></pre>
<p>æ¥ç€ï¼Œåœ¨<code>renderChunk</code>é˜¶æ®µï¼Œæ’ä»¶ä¼šå¯¹ Legacy æ¨¡å¼äº§ç‰©è¿›è¡Œè¯­æ³•è½¬è¯‘å’Œ Polyfill æ”¶é›†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶ä¸ä¼šçœŸæ­£æ³¨å…¥<code>Polyfill</code>ï¼Œè€Œä»…ä»…åªæ˜¯æ”¶é›†<code>Polyfill</code>ï¼Œ:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-function"><span class="hljs-title">renderChunk</span>(<span class="hljs-params">raw, chunk, opts</span>)</span> {
    <span class="hljs-comment">// 1. ä½¿ç”¨ babel + @babel/preset-env è¿›è¡Œè¯­æ³•è½¬æ¢ä¸ Polyfill æ³¨å…¥</span>
    <span class="hljs-comment">// 2. ç”±äºæ­¤æ—¶å·²ç»æ‰“åŒ…åçš„ Chunk å·²ç»ç”Ÿæˆ</span>
    <span class="hljs-comment">//   è¿™é‡Œéœ€è¦å»æ‰ babel æ³¨å…¥çš„ import è¯­å¥ï¼Œå¹¶è®°å½•æ‰€éœ€çš„ Polyfill</span>
    <span class="hljs-comment">// 3. æœ€åçš„ Polyfill ä»£ç å°†ä¼šåœ¨ generateBundle é˜¶æ®µç”Ÿæˆ</span>
  }
}
</code></pre>
<p>ç”±äºåœºæ™¯æ˜¯åº”ç”¨æ‰“åŒ…ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ @babel/preset-env çš„<code>useBuiltIns: 'usage'</code>æ¥è¿›è¡Œå…¨å±€ Polyfill çš„æ”¶é›†æ˜¯æ¯”è¾ƒæ ‡å‡†çš„åšæ³•ã€‚</p>
<p>å›åˆ° Vite æ„å»ºçš„ä¸»æµç¨‹ä¸­ï¼Œæ¥ä¸‹æ¥ä¼šè¿›å…¥<code>generateChunk</code>é’©å­é˜¶æ®µï¼Œç°åœ¨ Vite ä¼šå¯¹ä¹‹å‰æ”¶é›†åˆ°çš„<code>Polyfill</code>è¿›è¡Œç»Ÿä¸€çš„æ‰“åŒ…ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç²¾å¦™ï¼Œä¸»è¦é€»è¾‘é›†ä¸­åœ¨<code>buildPolyfillChunk</code>å‡½æ•°ä¸­:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// æ‰“åŒ… Polyfill ä»£ç </span>
<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">buildPolyfillChunk</span>(<span class="hljs-params">
  name,
  imports
  bundle,
  facadeToChunkMap,
  buildOptions,
  externalSystemJS
</span>) </span>{
  <span class="hljs-keyword">let</span> { minify, assetsDir } = buildOptions
  minify = minify ? <span class="hljs-string">'terser'</span> : <span class="hljs-literal">false</span>
  <span class="hljs-comment">// è°ƒç”¨ Vite çš„ build API è¿›è¡Œæ‰“åŒ…</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> build({
    <span class="hljs-comment">// æ ¹è·¯å¾„è®¾ç½®ä¸ºæ’ä»¶æ‰€åœ¨ç›®å½•</span>
    <span class="hljs-comment">// ç”±äºæ’ä»¶çš„ä¾èµ–åŒ…å«`core-js`ã€`regenerator-runtime`è¿™äº›è¿è¡Œæ—¶åŸºç¡€åº“</span>
    <span class="hljs-comment">// å› æ­¤è¿™é‡Œ Vite å¯ä»¥æ­£å¸¸è§£æåˆ°åŸºç¡€ Polyfill åº“çš„è·¯å¾„</span>
    <span class="hljs-attr">root</span>: __dirname,
    <span class="hljs-attr">write</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// è¿™é‡Œçš„æ’ä»¶å®ç°äº†ä¸€ä¸ªè™šæ‹Ÿæ¨¡å—</span>
    <span class="hljs-comment">// Vite å¯¹äº polyfillId ä¼šè¿”å›æ‰€æœ‰ Polyfill çš„å¼•å…¥è¯­å¥</span>
    <span class="hljs-attr">plugins</span>: [polyfillsPlugin(imports, externalSystemJS)],
    <span class="hljs-attr">build</span>: {
      <span class="hljs-attr">rollupOptions</span>: {
        <span class="hljs-comment">// è®¿é—® polyfillId</span>
        <span class="hljs-attr">input</span>: {
          <span class="hljs-comment">// name æš‚å¯è§†ä½œ`polyfills-legacy`</span>
          <span class="hljs-comment">// pofyfillId ä¸ºä¸€ä¸ªè™šæ‹Ÿæ¨¡å—ï¼Œç»è¿‡æ’ä»¶å¤„ç†åä¼šæ‹¿åˆ°æ‰€æœ‰ Polyfill çš„å¼•å…¥è¯­å¥</span>
          [name]: polyfillId
        },
      }
    }
  });
  <span class="hljs-comment">// æ‹¿åˆ° polyfill äº§ç‰© chunk</span>
  <span class="hljs-keyword">const</span> _polyfillChunk = <span class="hljs-built_in">Array</span>.isArray(res) ? res[<span class="hljs-number">0</span>] : res
  <span class="hljs-keyword">if</span> (!(<span class="hljs-string">'output'</span> <span class="hljs-keyword">in</span> _polyfillChunk)) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> polyfillChunk = _polyfillChunk.output[<span class="hljs-number">0</span>]
  <span class="hljs-comment">// åç»­åšä¸¤ä»¶äº‹æƒ…:</span>
  <span class="hljs-comment">// 1. è®°å½• polyfill chunk çš„æ–‡ä»¶åï¼Œæ–¹ä¾¿åç»­æ’å…¥åˆ° Modern æ¨¡å¼äº§ç‰©çš„ HTML ä¸­ï¼›</span>
  <span class="hljs-comment">// 2. åœ¨ bundle å¯¹è±¡ä¸Šæ‰‹åŠ¨æ·»åŠ  polyfill çš„ chunkï¼Œä¿è¯äº§ç‰©å†™åˆ°ç£ç›˜ä¸­</span>
}
</code></pre>
<p>å› æ­¤ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å³é€šè¿‡ <code>vite build</code> å¯¹<code>renderChunk</code>ä¸­æ”¶é›†åˆ° polyfill ä»£ç è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ chunk:</p>
<p><img src="img\c3428640-ae61-11ed-a371-342eb7027b95.jpg" alt="image.png"></p>
<blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpolyfill chunk ä¸­é™¤äº†åŒ…å«ä¸€äº› core-js å’Œ regenerator-runtime çš„ç›¸å…³ä»£ç ï¼Œä¹ŸåŒ…å«äº† <code>SystemJS</code> çš„å®ç°ä»£ç ï¼Œä½ å¯ä»¥å°†å…¶ç†è§£ä¸º ESM çš„åŠ è½½å™¨ï¼Œå®ç°äº†åœ¨æ—§ç‰ˆæµè§ˆå™¨ä¸‹çš„æ¨¡å—åŠ è½½èƒ½åŠ›ã€‚</p>
</blockquote>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»èƒ½å¤Ÿæ‹¿åˆ° Legacy æ¨¡å¼çš„äº§ç‰©æ–‡ä»¶ååŠ Polyfill Chunk çš„æ–‡ä»¶åï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡<code>transformIndexHtml</code>é’©å­æ¥å°†è¿™äº›äº§ç‰©æ’å…¥åˆ° HTML çš„ç»“æ„ä¸­:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-function"><span class="hljs-title">transformIndexHtml</span>(<span class="hljs-params">html</span>)</span> {
    <span class="hljs-comment">// 1. æ’å…¥ Polyfill chunk å¯¹åº”çš„ &#x3C;script nomodule> æ ‡ç­¾</span>
    <span class="hljs-comment">// 2. æ’å…¥ Legacy äº§ç‰©å…¥å£æ–‡ä»¶å¯¹åº”çš„ &#x3C;script nomodule> æ ‡ç­¾</span>
  }
}
</code></pre>
<p>OKï¼ŒVite å®˜æ–¹çš„ legacy æ’ä»¶çš„ä¸»è¦åŸç†å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè®²è§£çš„è¿‡ç¨‹ä¸­å¿½ç•¥äº†ä¸€äº›ä¸ä¸»æµç¨‹å…³è”ä¸å¤§çš„ç»†èŠ‚ï¼Œæœ€åç»™å¤§å®¶è¡¥å……ä¸€ä¸‹ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ :</p>
<ul>
<li>
<p>å½“æ’ä»¶å‚æ•°ä¸­å¼€å¯äº†<code>modernPolyfills</code>é€‰é¡¹æ—¶ï¼ŒVite ä¹Ÿä¼šè‡ªåŠ¨å¯¹ Modern æ¨¡å¼çš„äº§ç‰©è¿›è¡Œ Polyfill æ”¶é›†ï¼Œå¹¶å•ç‹¬æ‰“åŒ…æˆ<code>polyfills-modern.js</code>çš„ chunkï¼ŒåŸç†å’Œ Legacy æ¨¡å¼ä¸‹å¤„ç† Polyfill ä¸€æ ·ã€‚</p>
</li>
<li>
<p>Sarari 10.1 ç‰ˆæœ¬ä¸æ”¯æŒ <code>nomodule</code>ï¼Œä¸ºæ­¤éœ€è¦å•ç‹¬å¼•å…¥ä¸€äº›è¡¥ä¸ä»£ç ï¼Œ<a href="https://gist.github.com/samthor/64b114e4a4f539915a95b91ffd340acc" target="_blank" rel="nofollow noopener noreferrer">ç‚¹å‡»æŸ¥çœ‹</a>ã€‚</p>
</li>
<li>
<p>éƒ¨åˆ†ä½ç‰ˆæœ¬ Edge æµè§ˆå™¨è™½ç„¶æ”¯æŒ type="module"ï¼Œä½†ä¸æ”¯æŒåŠ¨æ€ importï¼Œä¸ºæ­¤ä¹Ÿéœ€è¦æ’å…¥ä¸€äº›<a href="https://github.com/vitejs/vite/pull/3885" target="_blank" rel="nofollow noopener noreferrer">è¡¥ä¸ä»£ç </a>ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µä¸‹é™çº§ä½¿ç”¨ Legacy æ¨¡å¼çš„äº§ç‰©ã€‚</p>
</li>
</ul>
<h2>å°ç»“</h2>
<p>æ­å–œä½ ï¼Œå­¦ä¹ å®Œäº†æœ¬èŠ‚çš„å†…å®¹ï¼æœ¬èŠ‚ä¸»è¦è®²è§£äº† Vite ä¸­è¯­æ³•é™çº§ä¸ Polyfill ç›¸å…³çš„å†…å®¹ï¼Œæ¶‰åŠçš„æ¦‚å¿µæ¯”è¾ƒå¤šï¼Œç¯‡å¹…ä¹Ÿæ¯”è¾ƒé•¿ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡ä»¥ä¸‹å†…å®¹:</p>
<ol>
<li><code>@babel/preset-env</code> çš„ä½¿ç”¨ã€‚</li>
<li><code>useBuiltIns</code> ä¸ <code>transformRuntime</code> ä¸¤ç§ Polyfill æ–¹æ¡ˆçš„åŒºåˆ«ã€‚</li>
<li>Vite é™çº§æ’ä»¶<code>@vitejs/plugin-legacy</code> çš„ä½¿ç”¨åŠåŸç†ã€‚</li>
</ol>
<p>é¦–å…ˆæˆ‘ç»™ä½ å¤ç°äº†çº¿ä¸Šçš„ä½ç‰ˆæœ¬æµè§ˆå™¨è¯­æ³•æŠ¥é”™æƒ…æ™¯ï¼Œä¸»è¦åˆ†ä¸º <strong>è¯­æ³•æŠ¥é”™</strong>
å’Œ <strong>Polyfill ç¼ºå¤±</strong> çš„é—®é¢˜ï¼Œç”±æ­¤å¼•å‡ºäº†åº•å±‚çš„è§£å†³æ–¹æ¡ˆâ€”â€”ä½¿ç”¨ <code>Babel ç¼–è¯‘å·¥å…·é“¾</code> å’Œ JS è¿è¡Œæ—¶åŸºç¡€åº“æ¥å®Œæˆã€‚æ¥ç€æˆ‘è·Ÿä½ å…·ä½“ä»‹ç»äº† <code>@babel/preset-env</code>çš„ä½¿ç”¨ï¼Œé€šè¿‡å®é™…çš„ä»£ç æ¡ˆä¾‹è®©ä½ ä½“éªŒäº†å®ƒçš„è¯­æ³•é™çº§å’Œè‡ªåŠ¨ Polyfill æ³¨å…¥çš„èƒ½åŠ›ï¼Œæ¥ç€ï¼Œæˆ‘åˆç»™ä½ ä»‹ç»äº†ä¸€ä¸ªæ›´ä¼˜çš„ Polyfill æ–¹æ¡ˆâ€”â€”<code>transform-runtime</code>æ–¹æ¡ˆï¼Œå¹¶ä¸<code>@babel/preset-env</code>çš„<code>useBuiltIns</code>æ–¹æ¡ˆè¿›è¡Œäº†å¯¹æ¯”ï¼Œåˆ†æäº†<code>transform-runtime</code>æ–¹æ¡ˆçš„ä¸¤ä¸ªä¼˜åŒ–ç‚¹: <strong>ä¸å½±å“å…¨å±€ç©ºé—´</strong>å’Œ<strong>ä¼˜åŒ–æ–‡ä»¶ä½“ç§¯</strong>ã€‚</p>
<p>åœ¨ä»‹ç»äº†åº•å±‚çš„è§£å†³æ–¹æ¡ˆä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ åœ¨ Vite ä¸­çš„è§£å†³æ–¹æ¡ˆâ€”â€”<code>@vitejs/plugin-legacy</code>ï¼Œåˆ†æäº†å®ƒå¦‚ä½•è®©äº§ç‰©èƒ½å¤ŸåŒæ—¶å…¼å®¹ç°ä»£æµè§ˆå™¨å’Œä¸æ”¯æŒ <code>type="module"</code>çš„ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œæ¥ç€æ·±å…¥åœ°è®²è§£äº†è¿™ä¸ªæ’ä»¶çš„å®ç°åŸç†ï¼Œä½ å¯ä»¥å‘ç°åº•å±‚ä¹Ÿæ˜¯é€šè¿‡<code>@babel/preset-env</code>æ¥å®Œæˆå…¼å®¹æ–¹æ¡ˆçš„ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯æœ¬èŠ‚çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›å¯¹ä½ èƒ½æœ‰æ‰€å¯å‘ï¼Œä¹Ÿæ¬¢è¿å°†ä½ çš„å­¦ä¹ å¿ƒå¾—å’Œå›°æƒ‘æ‰“åœ¨è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸‹ä¸€å°èŠ‚å†è§ğŸ‘‹ğŸ»</p>
</div>
</body>
</html>