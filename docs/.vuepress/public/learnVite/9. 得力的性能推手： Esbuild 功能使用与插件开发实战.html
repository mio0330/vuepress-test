<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<!--    <title>Title</title>-->
    <style>
        body {
    font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial !important;
}

.markdown-body {
    word-break: break-word;
    line-height: 1.75;
    font-weight: 400;
    font-size: 16px;
    overflow-x: hidden;
    color: #333
}

.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    line-height: 1.5;
    margin-top: 35px;
    margin-bottom: 10px;
    padding-bottom: 5px
}

.markdown-body h1 {
    font-size: 24px;
    margin-bottom: 5px
}

.markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    font-size: 20px
}

.markdown-body h2 {
    padding-bottom: 12px;
    border-bottom: 1px solid #ececec
}

.markdown-body h3 {
    font-size: 18px;
    padding-bottom: 0
}

.markdown-body h6 {
    margin-top: 5px
}

.markdown-body p {
    line-height: inherit;
    margin-top: 22px;
    margin-bottom: 22px
}

.markdown-body img {
    max-width: 100%
}

.markdown-body hr {
    border: none;
    border-top: 1px solid #ddd;
    margin-top: 32px;
    margin-bottom: 32px
}

.markdown-body code {
    word-break: break-word;
    border-radius: 2px;
    overflow-x: auto;
    background-color: #fff5f5;
    color: #ff502c;
    font-size: .87em;
    padding: .065em .4em
}

.markdown-body code, .markdown-body pre {
    font-family: Menlo, Monaco, Consolas, Courier New, monospace
}

.markdown-body pre {
    overflow: auto;
    position: relative;
    line-height: 1.75
}

.markdown-body pre > code {
    font-size: 12px;
    padding: 15px 12px;
    margin: 0;
    word-break: normal;
    display: block;
    overflow-x: auto;
    color: #333;
    background: #f8f8f8
}

.markdown-body a {
    text-decoration: none;
    color: #0269c8;
    border-bottom: 1px solid #d1e9ff
}

.markdown-body a:active, .markdown-body a:hover {
    color: #275b8c
}

.markdown-body table {
    display: inline-block !important;
    font-size: 12px;
    width: auto;
    max-width: 100%;
    overflow: auto;
    border: 1px solid #f6f6f6
}

.markdown-body thead {
    background: #f6f6f6;
    color: #000;
    text-align: left
}

.markdown-body tr:nth-child(2n) {
    background-color: #fcfcfc
}

.markdown-body td, .markdown-body th {
    padding: 12px 7px;
    line-height: 24px
}

.markdown-body td {
    min-width: 120px
}

.markdown-body blockquote {
    color: #666;
    padding: 1px 23px;
    margin: 22px 0;
    border-left: 4px solid #cbcbcb;
    background-color: #f8f8f8
}

.markdown-body blockquote:after {
    display: block;
    content: ""
}

.markdown-body blockquote > p {
    margin: 10px 0
}

.markdown-body ol, .markdown-body ul {
    padding-left: 28px
}

.markdown-body ol li, .markdown-body ul li {
    margin-bottom: 0;
    list-style: inherit
}

.markdown-body ol li .task-list-item, .markdown-body ul li .task-list-item {
    list-style: none
}

.markdown-body ol li .task-list-item ol, .markdown-body ol li .task-list-item ul, .markdown-body ul li .task-list-item ol, .markdown-body ul li .task-list-item ul {
    margin-top: 0
}

.markdown-body ol ol, .markdown-body ol ul, .markdown-body ul ol, .markdown-body ul ul {
    margin-top: 3px
}

.markdown-body ol li {
    padding-left: 6px
}

.markdown-body .contains-task-list {
    padding-left: 0
}

.markdown-body .task-list-item {
    list-style: none
}

@media (max-width: 720px) {
    .markdown-body h1 {
        font-size: 24px
    }

    .markdown-body h2 {
        font-size: 20px
    }

    .markdown-body h3 {
        font-size: 18px
    }
}
    </style>
</head>
<body>
<div class="markdown-body">
    <p>ä¸Šä¸€å°èŠ‚ï¼Œæˆ‘ä»¬ä»‹ç»äº† Vite çš„åŒå¼•æ“æ¶æ„ã€‚ä¸å¯å¦è®¤ï¼Œä½œä¸º Vite çš„åŒå¼•æ“ä¹‹ä¸€ï¼ŒEsbuild åœ¨å¾ˆå¤šå…³é”®çš„æ„å»ºé˜¶æ®µ(å¦‚<code>ä¾èµ–é¢„ç¼–è¯‘</code>ã€<code>TS è¯­æ³•è½¬è¯‘</code>ã€<code>ä»£ç å‹ç¼©</code>)è®© Vite è·å¾—äº†ç›¸å½“ä¼˜å¼‚çš„æ€§èƒ½ï¼Œæ˜¯ Vite é«˜æ€§èƒ½çš„å¾—åŠ›åŠ©æ‰‹ã€‚æ— è®ºæ˜¯åœ¨ Vite çš„é…ç½®é¡¹è¿˜æ˜¯æºç å®ç°ä¸­ï¼Œéƒ½åŒ…å«äº†ä¸å°‘ Esbuild æœ¬èº«çš„åŸºæœ¬æ¦‚å¿µå’Œé«˜é˜¶ç”¨æ³•ã€‚å› æ­¤ï¼Œè¦æ·±å…¥æŒæ¡ Viteï¼Œå­¦ä¹  Esbuild å¿…ä¸å¯å°‘ã€‚</p>
<p>æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äº Esbuild æœ¬èº«ï¼Œä¸€èµ·å­¦ä¹ å®ƒçš„åŸºæœ¬æ¦‚å¿µå’ŒåŠŸèƒ½ä½¿ç”¨ï¼ŒåŒæ—¶å®æˆ˜å¼€å‘ä¸€ä¸ªå®Œæ•´çš„ Esbuild æ’ä»¶ã€‚</p>
<h2>ä¸ºä»€ä¹ˆ Esbuild æ€§èƒ½æé«˜ï¼Ÿ</h2>
<p>Esbuild æ˜¯ç”± Figma çš„ CTO ã€ŒEvan Wallaceã€åŸºäº Golang å¼€å‘çš„ä¸€æ¬¾æ‰“åŒ…å·¥å…·ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„æ‰“åŒ…å·¥å…·ï¼Œä¸»æ‰“æ€§èƒ½ä¼˜åŠ¿ï¼Œåœ¨æ„å»ºé€Ÿåº¦ä¸Šå¯ä»¥æ¯”ä¼ ç»Ÿå·¥å…·å¿« <code>10~100</code> å€ã€‚é‚£ä¹ˆï¼Œå®ƒæ˜¯å¦‚ä½•è¾¾åˆ°è¿™æ ·è¶…é«˜çš„æ„å»ºæ€§èƒ½çš„å‘¢ï¼Ÿä¸»è¦åŸå› å¯ä»¥æ¦‚æ‹¬ä¸º 4 ç‚¹ã€‚</p>
<ol>
<li>
<p><strong>ä½¿ç”¨ Golang å¼€å‘</strong>ï¼Œæ„å»ºé€»è¾‘ä»£ç ç›´æ¥è¢«ç¼–è¯‘ä¸ºåŸç”Ÿæœºå™¨ç ï¼Œè€Œä¸ç”¨åƒ JS ä¸€æ ·å…ˆä»£ç è§£æä¸ºå­—èŠ‚ç ï¼Œç„¶åè½¬æ¢ä¸ºæœºå™¨ç ï¼Œå¤§å¤§èŠ‚çœäº†ç¨‹åºè¿è¡Œæ—¶é—´ã€‚</p>
</li>
<li>
<p><strong>å¤šæ ¸å¹¶è¡Œ</strong>ã€‚å†…éƒ¨æ‰“åŒ…ç®—æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU ä¼˜åŠ¿ï¼Œæ‰€æœ‰çš„æ­¥éª¤å°½å¯èƒ½å¹¶è¡Œï¼Œè¿™ä¹Ÿæ˜¯å¾—ç›Šäº Go å½“ä¸­å¤šçº¿ç¨‹å…±äº«å†…å­˜çš„ä¼˜åŠ¿ã€‚</p>
</li>
<li>
<p><strong>ä»é›¶é€ è½®å­</strong>ã€‚ å‡ ä¹æ²¡æœ‰ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰€æœ‰é€»è¾‘è‡ªå·±ç¼–å†™ï¼Œå¤§åˆ° AST è§£æï¼Œå°åˆ°å­—ç¬¦ä¸²çš„æ“ä½œï¼Œä¿è¯æè‡´çš„ä»£ç æ€§èƒ½ã€‚</p>
</li>
<li>
<p><strong>é«˜æ•ˆçš„å†…å­˜åˆ©ç”¨</strong>ã€‚Esbuild ä¸­ä»å¤´åˆ°å°¾å°½å¯èƒ½åœ°å¤ç”¨ä¸€ä»½ AST èŠ‚ç‚¹æ•°æ®ï¼Œè€Œä¸ç”¨åƒ JS æ‰“åŒ…å·¥å…·ä¸­é¢‘ç¹åœ°è§£æå’Œä¼ é€’ AST æ•°æ®ï¼ˆå¦‚ string -> TS -> JS -> string)ï¼Œé€ æˆå†…å­˜çš„å¤§é‡æµªè´¹ã€‚</p>
</li>
</ol>
<h2>Esbuild åŠŸèƒ½ä½¿ç”¨</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ­£å¼å­¦ä¹  Esbuild çš„åŠŸèƒ½ä½¿ç”¨ã€‚é¦–å…ˆæˆ‘ä»¬æ‰§è¡Œ<code>pnpm init -y</code>æ–°å»ºä¸€ä¸ªé¡¹ç›®, ç„¶åé€šè¿‡å¦‚ä¸‹çš„å‘½ä»¤å®Œæˆ Esbuild çš„å®‰è£…:</p>
<pre><code class="hljs language-ts">pnpm i esbuild
</code></pre>
<p>ä½¿ç”¨ Esbuild æœ‰ 2 ç§æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ <strong>å‘½ä»¤è¡Œè°ƒç”¨</strong>å’Œ<strong>ä»£ç è°ƒç”¨</strong>ã€‚</p>
<h3>1. å‘½ä»¤è¡Œè°ƒç”¨</h3>
<p>å‘½ä»¤è¡Œæ–¹å¼è°ƒç”¨ä¹Ÿæ˜¯æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ã€‚æˆ‘ä»¬å…ˆæ¥å†™ä¸€äº›ç¤ºä¾‹ä»£ç ï¼Œæ–°å»º<code>src/index.jsx</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/index.jsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Server</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom/server"</span>;

<span class="hljs-keyword">let</span> <span class="hljs-title function_">Greet</span> = (<span class="hljs-params"></span>) => <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>Hello, juejin!<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span></span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Server</span>.<span class="hljs-title function_">renderToString</span>(<span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Greet</span> /></span></span>));
</code></pre>
<p>æ³¨æ„å®‰è£…ä¸€ä¸‹æ‰€éœ€çš„ä¾èµ–ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤:</p>
<pre><code class="hljs language-ts">pnpm install react react-dom
</code></pre>
<p>æ¥ç€åˆ°<code>package.json</code>ä¸­æ·»åŠ <code>build</code>è„šæœ¬:</p>
<pre><code class="hljs language-json"> <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./node_modules/.bin/esbuild src/index.jsx --bundle --outfile=dist/out.js"</span>
 <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨ç»ˆç«¯æ‰§è¡Œ<code>pnpm run build</code>ï¼Œå¯ä»¥å‘ç°å¦‚ä¸‹çš„æ—¥å¿—ä¿¡æ¯:</p>
<p><img src="img\b861a6c3-ae61-11ed-9254-342eb7027b95.jpg" alt="image.png"></p>
<p>è¯´æ˜æˆ‘ä»¬å·²ç»æˆåŠŸé€šè¿‡å‘½ä»¤è¡Œå®Œæˆäº† Esbuild æ‰“åŒ…ï¼ä½†å‘½ä»¤è¡Œçš„ä½¿ç”¨æ–¹å¼ä¸å¤Ÿçµæ´»ï¼Œåªèƒ½ä¼ å…¥ä¸€äº›ç®€å•çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œç¨å¾®å¤æ‚çš„åœºæ™¯å°±ä¸é€‚ç”¨äº†ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬è¿˜æ˜¯ä¼šç”¨ä»£ç è°ƒç”¨çš„æ–¹å¼ã€‚</p>
<h3>2. ä»£ç è°ƒç”¨</h3>
<p>Esbuild å¯¹å¤–æš´éœ²äº†ä¸€ç³»åˆ—çš„ APIï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ç±»: <code>Build API</code>å’Œ<code>Transform API</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Nodejs ä»£ç ä¸­é€šè¿‡è°ƒç”¨è¿™äº› API æ¥ä½¿ç”¨ Esbuild çš„å„ç§åŠŸèƒ½ã€‚</p>
<h4>é¡¹ç›®æ‰“åŒ…â€”â€”Build API</h4>
<p><code>Build API</code>ä¸»è¦ç”¨æ¥è¿›è¡Œé¡¹ç›®æ‰“åŒ…ï¼ŒåŒ…æ‹¬<code>build</code>ã€<code>buildSync</code>å’Œ<code>serve</code>ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ¥è¯•ç€åœ¨ Node.js ä¸­ä½¿ç”¨<code>build</code> æ–¹æ³•ã€‚ä½ å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º<code>build.js</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> { build, buildSync, serve } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"esbuild"</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runBuild</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// å¼‚æ­¥æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ª Promise</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">build</span>({
    <span class="hljs-comment">// ----  å¦‚ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„é…ç½®  --- </span>
    <span class="hljs-comment">// å½“å‰é¡¹ç›®æ ¹ç›®å½•</span>
    <span class="hljs-attr">absWorkingDir</span>: process.<span class="hljs-title function_">cwd</span>(),
    <span class="hljs-comment">// å…¥å£æ–‡ä»¶åˆ—è¡¨ï¼Œä¸ºä¸€ä¸ªæ•°ç»„</span>
    <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">"./src/index.jsx"</span>],
    <span class="hljs-comment">// æ‰“åŒ…äº§ç‰©ç›®å½•</span>
    <span class="hljs-attr">outdir</span>: <span class="hljs-string">"dist"</span>,
    <span class="hljs-comment">// æ˜¯å¦éœ€è¦æ‰“åŒ…ï¼Œä¸€èˆ¬è®¾ä¸º true</span>
    <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// æ¨¡å—æ ¼å¼ï¼ŒåŒ…æ‹¬`esm`ã€`commonjs`å’Œ`iife`</span>
    <span class="hljs-attr">format</span>: <span class="hljs-string">"esm"</span>,
    <span class="hljs-comment">// éœ€è¦æ’é™¤æ‰“åŒ…çš„ä¾èµ–åˆ—è¡¨</span>
    <span class="hljs-attr">external</span>: [],
    <span class="hljs-comment">// æ˜¯å¦å¼€å¯è‡ªåŠ¨æ‹†åŒ…</span>
    <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// æ˜¯å¦ç”Ÿæˆ SourceMap æ–‡ä»¶</span>
    <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// æ˜¯å¦ç”Ÿæˆæ‰“åŒ…çš„å…ƒä¿¡æ¯æ–‡ä»¶</span>
    <span class="hljs-attr">metafile</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// æ˜¯å¦è¿›è¡Œä»£ç å‹ç¼©</span>
    <span class="hljs-attr">minify</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// æ˜¯å¦å¼€å¯ watch æ¨¡å¼ï¼Œåœ¨ watch æ¨¡å¼ä¸‹ä»£ç å˜åŠ¨åˆ™ä¼šè§¦å‘é‡æ–°æ‰“åŒ…</span>
    <span class="hljs-attr">watch</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// æ˜¯å¦å°†äº§ç‰©å†™å…¥ç£ç›˜</span>
    <span class="hljs-attr">write</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// Esbuild å†…ç½®äº†ä¸€ç³»åˆ—çš„ loaderï¼ŒåŒ…æ‹¬ base64ã€binaryã€cssã€dataurlã€fileã€js(x)ã€ts(x)ã€textã€json</span>
    <span class="hljs-comment">// é’ˆå¯¹ä¸€äº›ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œè°ƒç”¨ä¸åŒçš„ loader è¿›è¡ŒåŠ è½½</span>
    <span class="hljs-attr">loader</span>: {
      <span class="hljs-string">'.png'</span>: <span class="hljs-string">'base64'</span>,
    }
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
}

<span class="hljs-title function_">runBuild</span>();
</code></pre>
<p>éšåï¼Œä½ åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ<code>node build.js</code>ï¼Œå°±èƒ½åœ¨æ§åˆ¶å°å‘ç°å¦‚ä¸‹æ—¥å¿—ä¿¡æ¯:</p>
<p><img src="img\b881a37b-ae61-11ed-8678-342eb7027b95.jpg" alt="image.png"></p>
<p>ä»¥ä¸Šå°±æ˜¯ Esbuild æ‰“åŒ…çš„å…ƒä¿¡æ¯ï¼Œè¿™å¯¹æˆ‘ä»¬ç¼–å†™æ’ä»¶æ‰©å±• Esbuild èƒ½åŠ›éå¸¸æœ‰ç”¨ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬å†è§‚å¯Ÿä¸€ä¸‹ dist ç›®å½•ï¼Œå‘ç°æ‰“åŒ…äº§ç‰©å’Œç›¸åº”çš„ SourceMap æ–‡ä»¶ä¹Ÿå·²ç»æˆåŠŸå†™å…¥ç£ç›˜:</p>
<p><img src="img\b89869f7-ae61-11ed-80ca-342eb7027b95.jpg" alt="image.png"></p>
<p>å…¶å®<code>buildSync</code>æ–¹æ³•çš„ä½¿ç”¨å‡ ä¹ç›¸åŒï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">runBuild</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// åŒæ­¥æ–¹æ³•</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">buildSync</span>({
    <span class="hljs-comment">// çœç•¥ä¸€ç³»åˆ—çš„é…ç½®</span>
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);
}

<span class="hljs-title function_">runBuild</span>();
</code></pre>
<p>ä½†æˆ‘å¹¶ä¸æ¨èå¤§å®¶ä½¿ç”¨ <code>buildSync</code> è¿™ç§åŒæ­¥çš„ APIï¼Œå®ƒä»¬ä¼šå¯¼è‡´ä¸¤æ–¹é¢ä¸è‰¯åæœã€‚ä¸€æ–¹é¢å®¹æ˜“ä½¿ Esbuild åœ¨å½“å‰çº¿ç¨‹é˜»å¡ï¼Œä¸§å¤±<code>å¹¶å‘ä»»åŠ¡å¤„ç†</code>çš„ä¼˜åŠ¿ã€‚å¦ä¸€æ–¹é¢ï¼ŒEsbuild æ‰€æœ‰æ’ä»¶ä¸­éƒ½ä¸èƒ½ä½¿ç”¨ä»»ä½•å¼‚æ­¥æ“ä½œï¼Œè¿™ç»™<code>æ’ä»¶å¼€å‘</code>å¢åŠ äº†é™åˆ¶ã€‚</p>
<p>å› æ­¤æˆ‘æ›´æ¨èå¤§å®¶ä½¿ç”¨<code>build</code>è¿™ä¸ªå¼‚æ­¥ APIï¼Œå®ƒå¯ä»¥å¾ˆå¥½åœ°é¿å…ä¸Šè¿°é—®é¢˜ã€‚</p>
<p>åœ¨é¡¹ç›®æ‰“åŒ…æ–¹é¢ï¼Œé™¤äº†<code>build</code>å’Œ<code>buildSync</code>ï¼ŒEsbuild è¿˜æä¾›äº†å¦å¤–ä¸€ä¸ªæ¯”è¾ƒå¼ºå¤§çš„ APIâ€”â€”<code>serve</code>ã€‚è¿™ä¸ª API æœ‰ 3 ä¸ªç‰¹ç‚¹ã€‚</p>
<ol>
<li>å¼€å¯ serve æ¨¡å¼åï¼Œå°†åœ¨æŒ‡å®šçš„ç«¯å£å’Œç›®å½•ä¸Šæ­å»ºä¸€ä¸ª<code>é™æ€æ–‡ä»¶æœåŠ¡</code>ï¼Œè¿™ä¸ªæœåŠ¡å™¨ç”¨åŸç”Ÿ Go è¯­è¨€å®ç°ï¼Œæ€§èƒ½æ¯” Nodejs æ›´é«˜ã€‚</li>
<li>ç±»ä¼¼ webpack-dev-serverï¼Œæ‰€æœ‰çš„äº§ç‰©æ–‡ä»¶éƒ½é»˜è®¤ä¸ä¼šå†™åˆ°ç£ç›˜ï¼Œè€Œæ˜¯æ”¾åœ¨å†…å­˜ä¸­ï¼Œé€šè¿‡è¯·æ±‚æœåŠ¡æ¥è®¿é—®ã€‚</li>
<li><strong>æ¯æ¬¡è¯·æ±‚</strong>åˆ°æ¥æ—¶ï¼Œéƒ½ä¼šè¿›è¡Œé‡æ–°æ„å»º(<code>rebuild</code>)ï¼Œæ°¸è¿œè¿”å›æ–°çš„äº§ç‰©ã€‚</li>
</ol>
<blockquote>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè§¦å‘ rebuild çš„æ¡ä»¶å¹¶ä¸æ˜¯ä»£ç æ”¹åŠ¨ï¼Œè€Œæ˜¯æ–°çš„è¯·æ±‚åˆ°æ¥ã€‚</p>
</blockquote>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå…·ä½“ä¾‹å­æ¥æ„Ÿå—ä¸€ä¸‹ã€‚</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// build.js</span>
<span class="hljs-keyword">const</span> { build, buildSync, serve } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"esbuild"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">runBuild</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">serve</span>(
    {
      <span class="hljs-attr">port</span>: <span class="hljs-number">8000</span>,
      <span class="hljs-comment">// é™æ€èµ„æºç›®å½•</span>
      <span class="hljs-attr">servedir</span>: <span class="hljs-string">'./dist'</span>
    },
    {
      <span class="hljs-attr">absWorkingDir</span>: process.<span class="hljs-title function_">cwd</span>(),
      <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">"./src/index.jsx"</span>],
      <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">"esm"</span>,
      <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">ignoreAnnotations</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">metafile</span>: <span class="hljs-literal">true</span>,
    }
  ).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">server</span>) =></span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HTTP Server starts at port"</span>, server.<span class="hljs-property">port</span>);
  });
}

<span class="hljs-title function_">runBuild</span>();
</code></pre>
<p>æˆ‘ä»¬åœ¨æµè§ˆå™¨è®¿é—®<code>localhost:8000</code>å¯ä»¥çœ‹åˆ° Esbuild æœåŠ¡å™¨è¿”å›çš„ç¼–è¯‘äº§ç‰©å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="img\b8b387ea-ae61-11ed-8e49-342eb7027b95.jpg" alt="image.png"></p>
<p>åç»­æ¯æ¬¡åœ¨æµè§ˆå™¨è¯·æ±‚éƒ½ä¼šè§¦å‘ Esbuild é‡æ–°æ„å»ºï¼Œè€Œæ¯æ¬¡é‡æ–°æ„å»ºéƒ½æ˜¯ä¸€ä¸ªå¢é‡æ„å»ºçš„è¿‡ç¨‹ï¼Œè€—æ—¶ä¹Ÿä¼šæ¯”é¦–æ¬¡æ„å»ºå°‘å¾ˆå¤š(ä¸€èˆ¬èƒ½å‡å°‘ 70% å·¦å³)ã€‚</p>
<blockquote>
<p>Serve API åªé€‚åˆåœ¨å¼€å‘é˜¶æ®µä½¿ç”¨ï¼Œä¸é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p>
</blockquote>
<h4>å•æ–‡ä»¶è½¬è¯‘â€”â€”Transform API</h4>
<p>é™¤äº†é¡¹ç›®çš„æ‰“åŒ…åŠŸèƒ½ä¹‹åï¼ŒEsbuild è¿˜ä¸“é—¨æä¾›äº†å•æ–‡ä»¶ç¼–è¯‘çš„èƒ½åŠ›ï¼Œå³<code>Transform API</code>ï¼Œä¸ <code>Build API</code> ç±»ä¼¼ï¼Œå®ƒä¹ŸåŒ…å«äº†åŒæ­¥å’Œå¼‚æ­¥çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>transformSync</code>å’Œ<code>transform</code>ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å…·ä½“ä½¿ç”¨ä¸‹è¿™äº›æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º<code>transform.js</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// transform.js</span>
<span class="hljs-keyword">const</span> { transform, transformSync } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"esbuild"</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runTransform</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»£ç å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç¼–è¯‘é…ç½®</span>
  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">transform</span>(
    <span class="hljs-string">"const isNull = (str: string): boolean => str.length > 0;"</span>,
    {
      <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">loader</span>: <span class="hljs-string">"tsx"</span>,
    }
  );
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);
}

<span class="hljs-title function_">runTransform</span>();
</code></pre>
<p><code>transformSync</code> çš„ç”¨æ³•ç±»ä¼¼ï¼Œæ¢æˆåŒæ­¥çš„è°ƒç”¨æ–¹å¼å³å¯ã€‚</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">function</span> runTransform {
  <span class="hljs-keyword">const</span> content = <span class="hljs-keyword">await</span> <span class="hljs-title function_">transformSync</span>(<span class="hljs-comment">/* å‚æ•°å’Œ transform ç›¸åŒ */</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);
}
</code></pre>
<p>ä¸è¿‡ç”±äºåŒæ­¥çš„ API ä¼šä½¿ Esbuild ä¸§å¤±<code>å¹¶å‘ä»»åŠ¡å¤„ç†</code>çš„ä¼˜åŠ¿ï¼ˆ<code>Build API</code>çš„éƒ¨åˆ†å·²ç»åˆ†æè¿‡ï¼‰ï¼Œæˆ‘åŒæ ·ä¹Ÿä¸æ¨èå¤§å®¶ä½¿ç”¨<code>transformSync</code>ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ï¼ŒVite çš„åº•å±‚å®ç°ä¹Ÿæ˜¯é‡‡ç”¨ <code>transform</code>è¿™ä¸ªå¼‚æ­¥çš„ API è¿›è¡Œ TS åŠ JSX çš„å•æ–‡ä»¶è½¬è¯‘çš„ã€‚</p>
<h2>Esbuild æ’ä»¶å¼€å‘</h2>
<p>æˆ‘ä»¬åœ¨ä½¿ç”¨ Esbuild çš„æ—¶å€™éš¾å…ä¼šé‡åˆ°ä¸€äº›éœ€è¦åŠ ä¸Šè‡ªå®šä¹‰æ’ä»¶çš„åœºæ™¯ï¼Œå¹¶ä¸” Vite ä¾èµ–é¢„ç¼–è¯‘çš„å®ç°ä¸­å¤§é‡åº”ç”¨äº† Esbuild æ’ä»¶çš„é€»è¾‘ã€‚å› æ­¤ï¼Œæ’ä»¶å¼€å‘æ˜¯ Esbuild ä¸­éå¸¸é‡è¦çš„å†…å®¹ï¼Œ</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä¸€èµ·æ¥å®Œæˆ Esbuild çš„æ’ä»¶å¼€å‘ï¼Œå¸¦ä½ æŒæ¡è‹¥å¹²ä¸ªå…³é”®çš„é’©å­ä½¿ç”¨ã€‚</p>
<h3>åŸºæœ¬æ¦‚å¿µ</h3>
<p>æ’ä»¶å¼€å‘å…¶å®å°±æ˜¯åŸºäºåŸæœ‰çš„ä½“ç³»ç»“æ„ä¸­è¿›è¡Œ<code>æ‰©å±•</code>å’Œ<code>è‡ªå®šä¹‰</code>ã€‚ Esbuild æ’ä»¶ä¹Ÿä¸ä¾‹å¤–ï¼Œé€šè¿‡ Esbuild æ’ä»¶æˆ‘ä»¬å¯ä»¥æ‰©å±• Esbuild åŸæœ‰çš„è·¯å¾„è§£æã€æ¨¡å—åŠ è½½ç­‰æ–¹é¢çš„èƒ½åŠ›ï¼Œå¹¶åœ¨ Esbuild çš„æ„å»ºè¿‡ç¨‹ä¸­æ‰§è¡Œä¸€ç³»åˆ—è‡ªå®šä¹‰çš„é€»è¾‘ã€‚</p>
<p><code>Esbuild</code>Â æ’ä»¶ç»“æ„è¢«è®¾è®¡ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰<code>name</code>å’Œ<code>setup</code>ä¸¤ä¸ªå±æ€§ï¼Œ<code>name</code>æ˜¯æ’ä»¶çš„åç§°ï¼Œ<code>setup</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ä¸­å…¥å‚æ˜¯ä¸€ä¸ª <code>build</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸ŠæŒ‚è½½äº†ä¸€äº›é’©å­å¯ä¾›æˆ‘ä»¬è‡ªå®šä¹‰ä¸€äº›é’©å­å‡½æ•°é€»è¾‘ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„<code>Esbuild</code>æ’ä»¶ç¤ºä¾‹:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">let</span> envPlugin = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'env'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
    build.<span class="hljs-title function_">onResolve</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/^env$/</span> }, <span class="hljs-function"><span class="hljs-params">args</span> =></span> ({
      <span class="hljs-attr">path</span>: args.<span class="hljs-property">path</span>,
      <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span>,
    }))

    build.<span class="hljs-title function_">onLoad</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span> }, <span class="hljs-function">() =></span> ({
      <span class="hljs-attr">contents</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>),
      <span class="hljs-attr">loader</span>: <span class="hljs-string">'json'</span>,
    }))
  },
}

<span class="hljs-built_in">require</span>(<span class="hljs-string">'esbuild'</span>).<span class="hljs-title function_">build</span>({
  <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">'src/index.jsx'</span>],
  <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">outfile</span>: <span class="hljs-string">'out.js'</span>,
  <span class="hljs-comment">// åº”ç”¨æ’ä»¶</span>
  <span class="hljs-attr">plugins</span>: [envPlugin],
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =></span> process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>))

</code></pre>
<p>ä½¿ç”¨æ’ä»¶åæ•ˆæœå¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// åº”ç”¨äº† env æ’ä»¶åï¼Œæ„å»ºæ—¶å°†ä¼šè¢«æ›¿æ¢æˆ process.env å¯¹è±¡</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PATH</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'env'</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`PATH is <span class="hljs-subst">${PATH}</span>`</span>)
</code></pre>
<p>é‚£ä¹ˆï¼Œ<code>build</code>å¯¹è±¡ä¸Šçš„å„ç§é’©å­å‡½æ•°æ˜¯å¦‚ä½•ä½¿ç”¨çš„å‘¢ï¼Ÿ</p>
<h3>é’©å­å‡½æ•°çš„ä½¿ç”¨</h3>
<h4>1. <code>onResolve</code> é’©å­ å’Œ <code>onLoad</code>é’©å­</h4>
<p>åœ¨ Esbuild æ’ä»¶ä¸­ï¼Œ<code>onResolve</code> å’Œ <code>onload</code>æ˜¯ä¸¤ä¸ªéå¸¸é‡è¦çš„é’©å­ï¼Œåˆ†åˆ«æ§åˆ¶è·¯å¾„è§£æå’Œæ¨¡å—å†…å®¹åŠ è½½çš„è¿‡ç¨‹ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è¯´è¯´ä¸Šé¢æ’ä»¶ç¤ºä¾‹ä¸­çš„ä¸¤ä¸ªé’©å­è¯¥å¦‚ä½•ä½¿ç”¨ã€‚</p>
<pre><code class="hljs language-js">build.<span class="hljs-title function_">onResolve</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/^env$/</span> }, <span class="hljs-function"><span class="hljs-params">args</span> =></span> ({
  <span class="hljs-attr">path</span>: args.<span class="hljs-property">path</span>,
  <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span>,
}));
build.<span class="hljs-title function_">onLoad</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span> }, <span class="hljs-function">() =></span> ({
  <span class="hljs-attr">contents</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>),
  <span class="hljs-attr">loader</span>: <span class="hljs-string">'json'</span>,
}));
</code></pre>
<p>å¯ä»¥å‘ç°è¿™ä¸¤ä¸ªé’©å­å‡½æ•°ä¸­éƒ½éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°: <code>Options</code>  å’Œ <code>Callback</code>ã€‚</p>
<p>å…ˆè¯´è¯´<code>Options</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹äº<code>onResolve</code> å’Œ <code>onload</code> éƒ½ä¸€æ ·ï¼ŒåŒ…å«<code>filter</code>å’Œ<code>namespace</code>ä¸¤ä¸ªå±æ€§ï¼Œç±»å‹å®šä¹‰å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Options</span> {
  <span class="hljs-attr">filter</span>: <span class="hljs-title class_">RegExp</span>;
  <span class="hljs-keyword">namespace</span>?: string;
}
</code></pre>
<p><code>filter</code> ä¸ºå¿…ä¼ å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒå†³å®šäº†è¦è¿‡æ»¤å‡ºçš„ç‰¹å¾æ–‡ä»¶ã€‚</p>
<blockquote>
<p>ğŸ“¢ æ³¨æ„: æ’ä»¶ä¸­çš„Â <code>filter</code>Â æ­£åˆ™æ˜¯ä½¿ç”¨ Go åŸç”Ÿæ­£åˆ™å®ç°çš„ï¼Œä¸ºäº†ä¸ä½¿æ€§èƒ½è¿‡äºåŠ£åŒ–ï¼Œè§„åˆ™åº”è¯¥å°½å¯èƒ½ä¸¥æ ¼ã€‚åŒæ—¶å®ƒæœ¬èº«å’Œ JS çš„æ­£åˆ™ä¹Ÿæœ‰æ‰€åŒºåˆ«ï¼Œä¸æ”¯æŒå‰ç»(?&#x3C;=)ã€åé¡¾(?=)å’Œåå‘å¼•ç”¨(\1)è¿™ä¸‰ç§è§„åˆ™ã€‚</p>
</blockquote>
<p><code>namespace</code> ä¸ºé€‰å¡«å‚æ•°ï¼Œä¸€èˆ¬åœ¨ <code>onResolve</code> é’©å­ä¸­çš„å›è°ƒå‚æ•°è¿”å›<code>namespace</code>å±æ€§ä½œä¸ºæ ‡è¯†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨<code>onLoad</code>é’©å­ä¸­é€šè¿‡ <code>namespace</code> å°†æ¨¡å—è¿‡æ»¤å‡ºæ¥ã€‚å¦‚ä¸Šè¿°æ’ä»¶ç¤ºä¾‹å°±åœ¨<code>onLoad</code>é’©å­é€šè¿‡<code>env-ns</code>è¿™ä¸ª namespace æ ‡è¯†è¿‡æ»¤å‡ºäº†è¦å¤„ç†çš„<code>env</code>æ¨¡å—ã€‚</p>
<p>é™¤äº† Options å‚æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªå›è°ƒå‚æ•° <code>Callback</code>ï¼Œå®ƒçš„ç±»å‹æ ¹æ®ä¸åŒçš„é’©å­ä¼šæœ‰æ‰€ä¸åŒã€‚ç›¸æ¯”äº Optionsï¼ŒCallback å‡½æ•°å…¥å‚å’Œè¿”å›å€¼çš„ç»“æ„å¤æ‚å¾—å¤šï¼Œæ¶‰åŠå¾ˆå¤šå±æ€§ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦çœ‹æ‡‚æ¯ä¸ªå±æ€§çš„ç»†èŠ‚ï¼Œå…ˆäº†è§£ä¸€éå³å¯ï¼Œå¸¸ç”¨çš„ä¸€äº›å±æ€§ä¼šåœ¨æ’ä»¶å®æˆ˜éƒ¨åˆ†è®²è§£æ¥è®²ã€‚</p>
<p>åœ¨ onResolve é’©å­ä¸­å‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ¢³ç†å¦‚ä¸‹:</p>
<pre><code class="hljs language-js">build.<span class="hljs-title function_">onResolve</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/^env$/</span> }, (<span class="hljs-attr">args</span>: onResolveArgs): <span class="hljs-function"><span class="hljs-params">onResolveResult</span> =></span> {
  <span class="hljs-comment">// æ¨¡å—è·¯å¾„</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">path</span>)
  <span class="hljs-comment">// çˆ¶æ¨¡å—è·¯å¾„</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">importer</span>)
  <span class="hljs-comment">// namespace æ ‡è¯†</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">namespace</span>)
  <span class="hljs-comment">// åŸºå‡†è·¯å¾„</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">resolveDir</span>)
  <span class="hljs-comment">// å¯¼å…¥æ–¹å¼ï¼Œå¦‚ importã€require</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">kind</span>)
  <span class="hljs-comment">// é¢å¤–ç»‘å®šçš„æ’ä»¶æ•°æ®</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">pluginData</span>)
  
  <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯</span>
      <span class="hljs-attr">errors</span>: [],
      <span class="hljs-comment">// æ˜¯å¦éœ€è¦ external</span>
      <span class="hljs-attr">external</span>: <span class="hljs-literal">false</span>;
      <span class="hljs-comment">// namespace æ ‡è¯†</span>
      <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span>;
      <span class="hljs-comment">// æ¨¡å—è·¯å¾„</span>
      <span class="hljs-attr">path</span>: args.<span class="hljs-property">path</span>,
      <span class="hljs-comment">// é¢å¤–ç»‘å®šçš„æ’ä»¶æ•°æ®</span>
      <span class="hljs-attr">pluginData</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-comment">// æ’ä»¶åç§°</span>
      <span class="hljs-attr">pluginName</span>: <span class="hljs-string">'xxx'</span>,
      <span class="hljs-comment">// è®¾ç½®ä¸º falseï¼Œå¦‚æœæ¨¡å—æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œæ¨¡å—ä»£ç å°†ä¼šåœ¨äº§ç‰©ä¸­ä¼šåˆ é™¤ã€‚å¦åˆ™ä¸ä¼šè¿™ä¹ˆåš</span>
      <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-comment">// æ·»åŠ ä¸€äº›è·¯å¾„åç¼€ï¼Œå¦‚`?xxx`</span>
      <span class="hljs-attr">suffix</span>: <span class="hljs-string">'?xxx'</span>,
      <span class="hljs-comment">// è­¦å‘Šä¿¡æ¯</span>
      <span class="hljs-attr">warnings</span>: [],
      <span class="hljs-comment">// ä»…ä»…åœ¨ Esbuild å¼€å¯ watch æ¨¡å¼ä¸‹ç”Ÿæ•ˆ</span>
      <span class="hljs-comment">// å‘Šè¯‰ Esbuild éœ€è¦é¢å¤–ç›‘å¬å“ªäº›æ–‡ä»¶/ç›®å½•çš„å˜åŒ–</span>
      <span class="hljs-attr">watchDirs</span>: [],
      <span class="hljs-attr">watchFiles</span>: []
  }
}
</code></pre>
<p>åœ¨ onLoad é’©å­ä¸­å‡½æ•°å‚æ•°å’Œè¿”å›å€¼æ¢³ç†å¦‚ä¸‹:</p>
<pre><code class="hljs language-js">build.<span class="hljs-title function_">onLoad</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">'env-ns'</span> }, (<span class="hljs-attr">args</span>: <span class="hljs-title class_">OnLoadArgs</span>): <span class="hljs-function"><span class="hljs-params">OnLoadResult</span> =></span> {
  <span class="hljs-comment">// æ¨¡å—è·¯å¾„</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">path</span>);
  <span class="hljs-comment">// namespace æ ‡è¯†</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">namespace</span>);
  <span class="hljs-comment">// åç¼€ä¿¡æ¯</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">suffix</span>);
  <span class="hljs-comment">// é¢å¤–çš„æ’ä»¶æ•°æ®</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args.<span class="hljs-property">pluginData</span>);
  
  <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// æ¨¡å—å…·ä½“å†…å®¹</span>
      <span class="hljs-attr">contents</span>: <span class="hljs-string">'çœç•¥å†…å®¹'</span>,
      <span class="hljs-comment">// é”™è¯¯ä¿¡æ¯</span>
      <span class="hljs-attr">errors</span>: [],
      <span class="hljs-comment">// æŒ‡å®š loaderï¼Œå¦‚`js`ã€`ts`ã€`jsx`ã€`tsx`ã€`json`ç­‰ç­‰</span>
      <span class="hljs-attr">loader</span>: <span class="hljs-string">'json'</span>,
      <span class="hljs-comment">// é¢å¤–çš„æ’ä»¶æ•°æ®</span>
      <span class="hljs-attr">pluginData</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-comment">// æ’ä»¶åç§°</span>
      <span class="hljs-attr">pluginName</span>: <span class="hljs-string">'xxx'</span>,
      <span class="hljs-comment">// åŸºå‡†è·¯å¾„</span>
      <span class="hljs-attr">resolveDir</span>: <span class="hljs-string">'./dir'</span>,
      <span class="hljs-comment">// è­¦å‘Šä¿¡æ¯</span>
      <span class="hljs-attr">warnings</span>: [],
      <span class="hljs-comment">// åŒä¸Š</span>
      <span class="hljs-attr">watchDirs</span>: [],
      <span class="hljs-attr">watchFiles</span>: []
  }
});
</code></pre>
<h4>2. å…¶ä»–é’©å­</h4>
<p>åœ¨ build å¯¹è±¡ä¸­ï¼Œé™¤äº†<code>onResolve</code>å’Œ<code>onLoad</code>ï¼Œè¿˜æœ‰<code>onStart</code>å’Œ<code>onEnd</code>ä¸¤ä¸ªé’©å­ç”¨æ¥åœ¨æ„å»ºå¼€å¯å’Œç»“æŸæ—¶æ‰§è¡Œä¸€äº›è‡ªå®šä¹‰çš„é€»è¾‘ï¼Œä½¿ç”¨ä¸Šæ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­æ‰€ç¤º:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">let</span> examplePlugin = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'example'</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
    build.<span class="hljs-title function_">onStart</span>(<span class="hljs-function">() =></span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'build started'</span>)
    });
    build.<span class="hljs-title function_">onEnd</span>(<span class="hljs-function">(<span class="hljs-params">buildResult</span>) =></span> {
      <span class="hljs-keyword">if</span> (buildResult.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-comment">// æ„å»ºå…ƒä¿¡æ¯</span>
      <span class="hljs-comment">// è·å–å…ƒä¿¡æ¯ååšä¸€äº›è‡ªå®šä¹‰çš„äº‹æƒ…ï¼Œæ¯”å¦‚ç”Ÿæˆ HTML</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buildResult.<span class="hljs-property">metafile</span>)
    })
  },
}
</code></pre>
<p>åœ¨ä½¿ç”¨è¿™äº›é’©å­çš„æ—¶å€™ï¼Œæœ‰ 2 ç‚¹éœ€è¦æ³¨æ„ã€‚</p>
<ol>
<li>onStart çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨æ¯æ¬¡ build çš„æ—¶å€™ï¼ŒåŒ…æ‹¬è§¦å‘ <code>watch</code> æˆ–è€… <code>serve</code>æ¨¡å¼ä¸‹çš„é‡æ–°æ„å»ºã€‚</li>
<li>onEnd é’©å­ä¸­å¦‚æœè¦æ‹¿åˆ° <code>metafile</code>ï¼Œå¿…é¡»å°† Esbuild çš„æ„å»ºé…ç½®ä¸­<code>metafile</code>å±æ€§è®¾ä¸º <code>true</code>ã€‚</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥æ’ä»¶å®æˆ˜ï¼Œé€šè¿‡ç¼–å†™ä¸€äº›ç‰¹å®šåŠŸèƒ½çš„æ’ä»¶æ¥ç†Ÿæ‚‰ Esbuild æ’ä»¶çš„å¼€å‘æµç¨‹å’ŒæŠ€å·§ã€‚</p>
<h3>å®æˆ˜ 1: CDN ä¾èµ–æ‹‰å–æ’ä»¶</h3>
<p>Esbuild åŸç”Ÿä¸æ”¯æŒé€šè¿‡ HTTP ä» CDN æœåŠ¡ä¸Šæ‹‰å–å¯¹åº”çš„ç¬¬ä¸‰æ–¹ä¾èµ–èµ„æºï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// src/index.jsx</span>
<span class="hljs-comment">// react-dom çš„å†…å®¹å…¨éƒ¨ä» CDN æ‹‰å–</span>
<span class="hljs-comment">// è¿™æ®µä»£ç ç›®å‰æ˜¯æ— æ³•è¿è¡Œçš„</span>
<span class="hljs-keyword">import</span> { render } <span class="hljs-keyword">from</span> <span class="hljs-string">"https://cdn.skypack.dev/react-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://cdn.skypack.dev/react'</span>

<span class="hljs-keyword">let</span> <span class="hljs-title function_">Greet</span> = (<span class="hljs-params"></span>) => <span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">h1</span>></span>Hello, juejin!<span class="hljs-tag">&#x3C;/<span class="hljs-name">h1</span>></span></span>;

<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">Greet</span> /></span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>));
</code></pre>
<p>ç¤ºä¾‹ä»£ç ä¸­æˆ‘ä»¬ç”¨åˆ°äº† <code>Skypack</code> è¿™ä¸ªæä¾› npm ç¬¬ä¸‰æ–¹åŒ… ESM äº§ç‰©çš„ <code>CDN æœåŠ¡</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ url è®¿é—®ç¬¬ä¸‰æ–¹åŒ…çš„èµ„æºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p>
<p><img src="img\b8dde9ce-ae61-11ed-8521-342eb7027b95.jpg" alt="image.png"></p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦é€šè¿‡ Esbuild æ’ä»¶æ¥è¯†åˆ«è¿™æ ·çš„ url è·¯å¾„ï¼Œç„¶åä»ç½‘ç»œè·å–æ¨¡å—å†…å®¹å¹¶è®© Esbuild è¿›è¡ŒåŠ è½½ï¼Œç”šè‡³ä¸å†éœ€è¦<code>npm install</code>å®‰è£…ä¾èµ–äº†ï¼Œè¿™çœ‹ä¸Šå»æ˜¯ä¸æ˜¯å¾ˆé…·å‘¢ï¼Ÿ</p>
<blockquote>
<p>é¡ºä¾¿æä¸€å¥ï¼ŒESM CDN ä½œä¸ºé¢å‘æœªæ¥çš„å‰ç«¯åŸºç¡€è®¾æ–½ï¼Œå¯¹ Vite çš„å½±å“ä¹Ÿè‡³å…³é‡å¤§ï¼Œå¯ä»¥æå¤§æå‡ Vite åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹çš„æ„å»ºæ€§èƒ½ã€‚è¿™éƒ¨åˆ†å†…å®¹æˆ‘ä»¬å°†åœ¨<strong>é«˜çº§åº”ç”¨</strong>è¿™ä¸€ç« å±•å¼€ä»‹ç»ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å…ˆä»æœ€ç®€å•çš„ç‰ˆæœ¬å¼€å§‹å†™èµ·:</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// http-import-plugin.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =></span> ({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"esbuild:http"</span>,
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
    <span class="hljs-keyword">let</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">"https"</span>);
    <span class="hljs-keyword">let</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>);

    <span class="hljs-comment">// 1. æ‹¦æˆª CDN è¯·æ±‚</span>
    build.<span class="hljs-title function_">onResolve</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/^https?:\/\//</span> }, <span class="hljs-function">(<span class="hljs-params">args</span>) =></span> ({
      <span class="hljs-attr">path</span>: args.<span class="hljs-property">path</span>,
      <span class="hljs-attr">namespace</span>: <span class="hljs-string">"http-url"</span>,
    }));

    <span class="hljs-comment">// 2. é€šè¿‡ fetch è¯·æ±‚åŠ è½½ CDN èµ„æº</span>
    build.<span class="hljs-title function_">onLoad</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">"http-url"</span> }, <span class="hljs-keyword">async</span> (args) => {
      <span class="hljs-keyword">let</span> contents = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =></span> {
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Downloading: <span class="hljs-subst">${url}</span>`</span>);
          <span class="hljs-keyword">let</span> lib = url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"https"</span>) ? https : http;
          <span class="hljs-keyword">let</span> req = lib
            .<span class="hljs-title function_">get</span>(url, <span class="hljs-function">(<span class="hljs-params">res</span>) =></span> {
              <span class="hljs-keyword">if</span> ([<span class="hljs-number">301</span>, <span class="hljs-number">302</span>, <span class="hljs-number">307</span>].<span class="hljs-title function_">includes</span>(res.<span class="hljs-property">statusCode</span>)) {
                <span class="hljs-comment">// é‡å®šå‘</span>
                <span class="hljs-title function_">fetch</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(res.<span class="hljs-property">headers</span>.<span class="hljs-property">location</span>, url).<span class="hljs-title function_">toString</span>());
                req.<span class="hljs-title function_">abort</span>();
              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-comment">// å“åº”æˆåŠŸ</span>
                <span class="hljs-keyword">let</span> chunks = [];
                res.<span class="hljs-title function_">on</span>(<span class="hljs-string">"data"</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =></span> chunks.<span class="hljs-title function_">push</span>(chunk));
                res.<span class="hljs-title function_">on</span>(<span class="hljs-string">"end"</span>, <span class="hljs-function">() =></span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">concat</span>(chunks)));
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">reject</span>(
                  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`GET <span class="hljs-subst">${url}</span> failed: status <span class="hljs-subst">${res.statusCode}</span>`</span>)
                );
              }
            })
            .<span class="hljs-title function_">on</span>(<span class="hljs-string">"error"</span>, reject);
        }
        <span class="hljs-title function_">fetch</span>(args.<span class="hljs-property">path</span>);
      });
      <span class="hljs-keyword">return</span> { contents };
    });
  },
});
</code></pre>
<p>ç„¶åæˆ‘ä»¬æ–°å»º<code>build.js</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> { build } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"esbuild"</span>);
<span class="hljs-keyword">const</span> httpImport = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./http-import-plugin"</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runBuild</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">build</span>({
    <span class="hljs-attr">absWorkingDir</span>: process.<span class="hljs-title function_">cwd</span>(),
    <span class="hljs-attr">entryPoints</span>: [<span class="hljs-string">"./src/index.jsx"</span>],
    <span class="hljs-attr">outdir</span>: <span class="hljs-string">"dist"</span>,
    <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">format</span>: <span class="hljs-string">"esm"</span>,
    <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">metafile</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">httpImport</span>()],
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =></span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"ğŸš€ Build Finished!"</span>);
  });
}

<span class="hljs-title function_">runBuild</span>();
</code></pre>
<p>é€šè¿‡<code>node build.js</code>æ‰§è¡Œæ‰“åŒ…è„šæœ¬ï¼Œå‘ç°æ’ä»¶ä¸èƒ½ workï¼ŒæŠ›å‡ºäº†è¿™æ ·ä¸€ä¸ªé”™è¯¯:</p>
<p><img src="img\b90b2e71-ae61-11ed-8607-342eb7027b95.jpg" alt="image.png"></p>
<p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä½ å¯ä»¥å›è¿‡å¤´è§‚å¯Ÿä¸€ä¸‹ç¬¬ä¸‰æ–¹åŒ…çš„å“åº”å†…å®¹:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js'</span>;
<span class="hljs-keyword">export</span> {<span class="hljs-keyword">default</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js'</span>;
</code></pre>
<p>è¿›ä¸€æ­¥æŸ¥çœ‹è¿˜æœ‰æ›´å¤šçš„æ¨¡å—å†…å®¹:</p>
<p><img src="img\b92a942f-ae61-11ed-bd00-342eb7027b95.jpg" alt="image.png"></p>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šé™¤äº†è¦è§£æ react-dom è¿™ç§ç›´æ¥ä¾èµ–çš„è·¯å¾„ï¼Œè¿˜è¦è§£æå®ƒä¾èµ–çš„è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯é—´æ¥ä¾èµ–çš„è·¯å¾„ã€‚</p>
<p>é‚£å¦‚ä½•æ¥å®ç°è¿™ä¸ªæ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨åŠ å…¥è¿™æ ·ä¸€æ®µ<code>onResolve</code>é’©å­é€»è¾‘:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// æ‹¦æˆªé—´æ¥ä¾èµ–çš„è·¯å¾„ï¼Œå¹¶é‡å†™è·¯å¾„</span>
<span class="hljs-comment">// tip: é—´æ¥ä¾èµ–åŒæ ·ä¼šè¢«è‡ªåŠ¨å¸¦ä¸Š `http-url`çš„ namespace</span>
build.<span class="hljs-title function_">onResolve</span>({ <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>, <span class="hljs-attr">namespace</span>: <span class="hljs-string">"http-url"</span> }, <span class="hljs-function">(<span class="hljs-params">args</span>) =></span> ({
  <span class="hljs-comment">// é‡å†™è·¯å¾„</span>
  <span class="hljs-attr">path</span>: <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(args.<span class="hljs-property">path</span>, args.<span class="hljs-property">importer</span>).<span class="hljs-title function_">toString</span>(),
  <span class="hljs-attr">namespace</span>: <span class="hljs-string">"http-url"</span>,
}));
</code></pre>
<p>åŠ äº†è¿™æ®µé€»è¾‘åï¼ŒEsbuild è·¯å¾„è§£æçš„æµç¨‹å¦‚ä¸‹:</p>
<p><img src="img\b9410f67-ae61-11ed-861f-342eb7027b95.jpg" alt="image.png"></p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¬¡æ‰§è¡Œ<code>node build.js</code>ï¼Œå‘ç°ä¾èµ–å·²ç»æˆåŠŸä¸‹è½½å¹¶æ‰“åŒ…äº†ã€‚</p>
<p><img src="img\b9710629-ae61-11ed-a156-342eb7027b95.jpg" alt="image.png"></p>
<h3>å®æˆ˜ 2: å®ç° HTML æ„å»ºæ’ä»¶</h3>
<p>Esbuild ä½œä¸ºä¸€ä¸ªå‰ç«¯æ‰“åŒ…å·¥å…·ï¼Œæœ¬èº«å¹¶ä¸å…·å¤‡ HTML çš„æ„å»ºèƒ½åŠ›ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å®ƒæŠŠ js/css äº§ç‰©æ‰“åŒ…å‡ºæ¥çš„æ—¶å€™ï¼Œå¹¶ä¸æ„å‘³ç€å‰ç«¯çš„é¡¹ç›®å¯ä»¥ç›´æ¥è¿è¡Œäº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä»½å¯¹åº”çš„å…¥å£ HTML æ–‡ä»¶ã€‚è€Œè¿™ä»½ HTML æ–‡ä»¶å½“ç„¶å¯ä»¥æ‰‹å†™ä¸€ä¸ªï¼Œä½†æ‰‹å†™æ˜¾å¾—æ¯”è¾ƒéº»çƒ¦ï¼Œå°¤å…¶æ˜¯äº§ç‰©åç§°å¸¦å“ˆå¸Œå€¼çš„æ—¶å€™ï¼Œæ¯æ¬¡æ‰“åŒ…å®Œéƒ½è¦æ›¿æ¢è·¯å¾„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡ Esbuild æ’ä»¶çš„æ–¹å¼æ¥è‡ªåŠ¨åŒ–åœ°ç”Ÿæˆ HTML å‘¢ï¼Ÿ</p>
<p>åˆšæ‰æˆ‘ä»¬è¯´äº†ï¼Œåœ¨ Esbuild æ’ä»¶çš„ <code>onEnd</code> é’©å­ä¸­å¯ä»¥æ‹¿åˆ° <code>metafile</code> å¯¹è±¡çš„ä¿¡æ¯ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªå¯¹è±¡ç©¶ç«Ÿä»€ä¹ˆæ ·å‘¢ï¼Ÿ</p>
<pre><code class="hljs language-json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">/* çœç•¥å†…å®¹ */</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dist/index.js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      imports<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      exports<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      entryPoint<span class="hljs-punctuation">:</span> 'src/index.jsx'<span class="hljs-punctuation">,</span>
      inputs<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        'http-url<span class="hljs-punctuation">:</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//cdn.skypack.dev/-/object-assign@v4.1.1-LbCnB3r2y2yFmhmiCfPn/dist=es2019,mode=imports/optimized/object-assign.js': { bytesInOutput: 1792 },</span>
        'http-url<span class="hljs-punctuation">:</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//cdn.skypack.dev/-/react@v17.0.1-yH0aYV1FOvoIPeKBbHxg/dist=es2019,mode=imports/optimized/react.js': { bytesInOutput: 10396 },</span>
        'http-url<span class="hljs-punctuation">:</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//cdn.skypack.dev/-/scheduler@v0.20.2-PAU9F1YosUNPKr7V4s0j/dist=es2019,mode=imports/optimized/scheduler.js': { bytesInOutput: 9084 },</span>
        'http-url<span class="hljs-punctuation">:</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//cdn.skypack.dev/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js': { bytesInOutput: 183229 },</span>
        'http-url<span class="hljs-punctuation">:</span>https<span class="hljs-punctuation">:</span><span class="hljs-comment">//cdn.skypack.dev/react-dom': { bytesInOutput: 0 },</span>
        'src/index.jsx'<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> bytesInOutput<span class="hljs-punctuation">:</span> <span class="hljs-number">178</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      bytes<span class="hljs-punctuation">:</span> <span class="hljs-number">205284</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dist/index.js.map"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">/* çœç•¥å†…å®¹ */</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>ä»<code>outputs</code>å±æ€§ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°äº§ç‰©çš„è·¯å¾„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨æ’ä»¶ä¸­æ‹¿åˆ°æ‰€æœ‰ js å’Œ css äº§ç‰©ï¼Œç„¶åè‡ªå·±ç»„è£…ã€ç”Ÿæˆä¸€ä¸ª HTMLï¼Œå®ç°è‡ªåŠ¨åŒ–ç”Ÿæˆ HTML çš„æ•ˆæœã€‚</p>
<p>æˆ‘ä»¬æ¥ç€æ¥å®ç°ä¸€ä¸‹è¿™ä¸ªæ’ä»¶çš„é€»è¾‘ï¼Œé¦–å…ˆæ–°å»º<code>html-plugin.js</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs/promises"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> { createScript, createLink, generateHTML } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">() =></span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"esbuild:html"</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
      build.<span class="hljs-title function_">onEnd</span>(<span class="hljs-keyword">async</span> (buildResult) => {
        <span class="hljs-keyword">if</span> (buildResult.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span>) {
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">const</span> { metafile } = buildResult;
        <span class="hljs-comment">// 1. æ‹¿åˆ° metafile åè·å–æ‰€æœ‰çš„ js å’Œ css äº§ç‰©è·¯å¾„</span>
        <span class="hljs-keyword">const</span> scripts = [];
        <span class="hljs-keyword">const</span> links = [];
        <span class="hljs-keyword">if</span> (metafile) {
          <span class="hljs-keyword">const</span> { outputs } = metafile;
          <span class="hljs-keyword">const</span> assets = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(outputs);

          assets.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">asset</span>) =></span> {
            <span class="hljs-keyword">if</span> (asset.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">".js"</span>)) {
              scripts.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createScript</span>(asset));
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (asset.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">".css"</span>)) {
              links.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createLink</span>(asset));
            }
          });
        }
        <span class="hljs-comment">// 2. æ‹¼æ¥ HTML å†…å®¹</span>
        <span class="hljs-keyword">const</span> templateContent = <span class="hljs-title function_">generateHTML</span>(scripts, links);
        <span class="hljs-comment">// 3. HTML å†™å…¥ç£ç›˜</span>
        <span class="hljs-keyword">const</span> templatePath = path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">"index.html"</span>);
        <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(templatePath, templateContent);
      });
    },
  };
}
  
<span class="hljs-comment">// util.js</span>
<span class="hljs-comment">// ä¸€äº›å·¥å…·å‡½æ•°çš„å®ç°</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createScript</span> = (<span class="hljs-params">src</span>) => <span class="hljs-string">`&#x3C;script type="module" src="<span class="hljs-subst">${src}</span>">&#x3C;/script>`</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createLink</span> = (<span class="hljs-params">src</span>) => <span class="hljs-string">`&#x3C;link rel="stylesheet" href="<span class="hljs-subst">${src}</span>">&#x3C;/link>`</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateHTML</span> = (<span class="hljs-params">scripts, links</span>) => <span class="hljs-string">`
&#x3C;!DOCTYPE html>
&#x3C;html lang="en">

&#x3C;head>
  &#x3C;meta charset="UTF-8" />
  &#x3C;meta name="viewport" content="width=device-width, initial-scale=1.0" />
  &#x3C;title>Esbuild App&#x3C;/title>
  <span class="hljs-subst">${links.join(<span class="hljs-string">"\n"</span>)}</span>
&#x3C;/head>

&#x3C;body>
  &#x3C;div id="root">&#x3C;/div>
  <span class="hljs-subst">${scripts.join(<span class="hljs-string">"\n"</span>)}</span>
&#x3C;/body>

&#x3C;/html>
`</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { createLink, createScript, generateHTML };
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬åœ¨ <code>build.js</code> ä¸­å¼•å…¥ html æ’ä»¶:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">const</span> html = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./html-plugin"</span>);

<span class="hljs-comment">// esbuild é…ç½®</span>
<span class="hljs-attr">plugins</span>: [
  <span class="hljs-comment">// çœç•¥å…¶å®ƒæ’ä»¶</span>
  <span class="hljs-title function_">html</span>()
],
</code></pre>
<p>ç„¶åæ‰§è¡Œ<code>node build.js</code>å¯¹é¡¹ç›®è¿›è¡Œæ‰“åŒ…ï¼Œä½ å°±å¯ä»¥çœ‹åˆ° <code>index.html</code> å·²ç»æˆåŠŸè¾“å‡ºåˆ°æ ¹ç›®å½•ã€‚æ¥ç€ï¼Œæˆ‘ä»¬é€šè¿‡ <code>serve</code> èµ·ä¸€ä¸ªæœ¬åœ°é™æ€æ–‡ä»¶æœåŠ¡å™¨:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// 1. å…¨å±€å®‰è£… serve</span>
npm i -g serve
<span class="hljs-comment">// 2. åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ</span>
serve .
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ç•Œé¢:</p>
<p><img src="img\b9850934-ae61-11ed-aa20-342eb7027b95.jpg" alt="image.png"></p>
<p>å†è®¿é—®<code>localhost:3000</code>ï¼Œä¼šé»˜è®¤è®¿é—®åˆ° index.html çš„å†…å®¹ï¼š</p>
<p><img src="img\b9b08a3a-ae61-11ed-92b6-342eb7027b95.jpg" alt="image.png"></p>
<p>è¿™æ ·ä¸€æ¥ï¼Œåº”ç”¨çš„å†…å®¹å°±æˆåŠŸæ˜¾ç¤ºäº†ï¼Œä¹Ÿè¯´æ˜ HTML æ’ä»¶æ­£å¸¸ç”Ÿæ•ˆäº†ã€‚å½“ç„¶ï¼Œå¦‚æœè¦åšä¸€ä¸ªè¶³å¤Ÿé€šç”¨çš„ HTML æ’ä»¶ï¼Œè¿˜éœ€è¦è€ƒè™‘è¯¸å¤šçš„å› ç´ ï¼Œæ¯”å¦‚<code>è‡ªå®šä¹‰ HTML å†…å®¹</code>ã€<code>è‡ªå®šä¹‰å…¬å…±å‰ç¼€(publicPath)</code>ã€<code>è‡ªå®šä¹‰ script æ ‡ç­¾ç±»å‹</code>ä»¥åŠ <code>å¤šå…¥å£æ‰“åŒ…</code>ç­‰ç­‰ï¼Œå¤§å®¶æ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªè¡Œæ‰©å±•ã€‚(å¯å‚è€ƒ<a href="https://github.com/sanyuan0704/ewas/blob/main/packages/esbuild-plugin-html/src/index.ts" target="_blank" rel="nofollow noopener noreferrer">è¿™ä¸ªå¼€æºæ’ä»¶</a>)</p>
<h2>å°ç»“</h2>
<p>æ­å–œä½ ï¼Œå­¦ä¹ å®Œäº†æœ¬èŠ‚çš„å†…å®¹ï¼è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬è¦é‡ç‚¹æŒæ¡ Esbuild çš„åŸºç¡€ä½¿ç”¨å’Œæ’ä»¶å¼€å‘ã€‚</p>
<p>é¦–å…ˆä½ å¯ä»¥é€šè¿‡<code>å‘½ä»¤è¡Œæ–¹å¼</code>å’Œ<code>ä»£ç è°ƒç”¨æ–¹å¼</code>ä¸¤ç§æ–¹å¼æ¥ä½¿ç”¨ Esbuildã€‚å¯¹åè€…è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ° Esbuild ä¸­ä¸¤ä¸ªé‡è¦çš„ APIï¼Œåˆ†åˆ«æ˜¯<code>Build API</code>å’Œ<code>Transform API</code>ï¼Œä¸ºäº†é¿å…åŒæ­¥æ–¹æ³•æ‰€å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘æ¨èä½ ä½¿ç”¨å¼‚æ­¥æ–¹å¼è¿›è¡Œè°ƒç”¨ã€‚</p>
<p>å…¶æ¬¡ï¼Œæˆ‘ç”¨ä¸€ä¸ªç®€å•çš„<code>env</code>æ’ä»¶ç¤ºä¾‹å¸¦ä½ å­¦ä¹ äº† Esbuild æ’ä»¶çš„ä»£ç ç»“æ„å’ŒåŸºæœ¬æ¦‚å¿µï¼Œå¹¶è¿›è¡Œäº†æ’ä»¶å¼€å‘å®æˆ˜ï¼Œå¼€å‘äº†ä¸¤ä¸ªå¤æ‚åº¦æ¯”è¾ƒé«˜çš„æ’ä»¶ï¼Œåˆ†åˆ«æ˜¯Â <code>CDN ä¾èµ–æ‹‰å–æ’ä»¶</code>å’Œ<code>HTML æ„å»ºæ’ä»¶</code>ã€‚å¸Œæœ›ä½ èƒ½é€šè¿‡è¿™äº›ç»å…¸çš„ä¾‹å­å¥½å¥½ä½“ä¼šæ’ä»¶çš„ç¼–å†™æ–¹å¼ï¼Œå¹¶å¤šå¤šå®è·µï¼Œæå‡è‡ªå·±å¯¹ Esbuild çš„ç†è§£ã€‚</p>
<p>æœ¬æ–‡çš„å†…å®¹åˆ°æ­¤å°±ç»“æŸäº†ï¼Œæ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œæˆ‘ä»¬ä¸‹ä¸€èŠ‚å†è§ï¼</p>
</div>
</body>
</html>