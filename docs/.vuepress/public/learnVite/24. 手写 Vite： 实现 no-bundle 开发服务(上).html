<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<!--    <title>Title</title>-->
    <style>
        body {
    font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial !important;
}

.markdown-body {
    word-break: break-word;
    line-height: 1.75;
    font-weight: 400;
    font-size: 16px;
    overflow-x: hidden;
    color: #333
}

.markdown-body h1, .markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    line-height: 1.5;
    margin-top: 35px;
    margin-bottom: 10px;
    padding-bottom: 5px
}

.markdown-body h1 {
    font-size: 24px;
    margin-bottom: 5px
}

.markdown-body h2, .markdown-body h3, .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    font-size: 20px
}

.markdown-body h2 {
    padding-bottom: 12px;
    border-bottom: 1px solid #ececec
}

.markdown-body h3 {
    font-size: 18px;
    padding-bottom: 0
}

.markdown-body h6 {
    margin-top: 5px
}

.markdown-body p {
    line-height: inherit;
    margin-top: 22px;
    margin-bottom: 22px
}

.markdown-body img {
    max-width: 100%
}

.markdown-body hr {
    border: none;
    border-top: 1px solid #ddd;
    margin-top: 32px;
    margin-bottom: 32px
}

.markdown-body code {
    word-break: break-word;
    border-radius: 2px;
    overflow-x: auto;
    background-color: #fff5f5;
    color: #ff502c;
    font-size: .87em;
    padding: .065em .4em
}

.markdown-body code, .markdown-body pre {
    font-family: Menlo, Monaco, Consolas, Courier New, monospace
}

.markdown-body pre {
    overflow: auto;
    position: relative;
    line-height: 1.75
}

.markdown-body pre > code {
    font-size: 12px;
    padding: 15px 12px;
    margin: 0;
    word-break: normal;
    display: block;
    overflow-x: auto;
    color: #333;
    background: #f8f8f8
}

.markdown-body a {
    text-decoration: none;
    color: #0269c8;
    border-bottom: 1px solid #d1e9ff
}

.markdown-body a:active, .markdown-body a:hover {
    color: #275b8c
}

.markdown-body table {
    display: inline-block !important;
    font-size: 12px;
    width: auto;
    max-width: 100%;
    overflow: auto;
    border: 1px solid #f6f6f6
}

.markdown-body thead {
    background: #f6f6f6;
    color: #000;
    text-align: left
}

.markdown-body tr:nth-child(2n) {
    background-color: #fcfcfc
}

.markdown-body td, .markdown-body th {
    padding: 12px 7px;
    line-height: 24px
}

.markdown-body td {
    min-width: 120px
}

.markdown-body blockquote {
    color: #666;
    padding: 1px 23px;
    margin: 22px 0;
    border-left: 4px solid #cbcbcb;
    background-color: #f8f8f8
}

.markdown-body blockquote:after {
    display: block;
    content: ""
}

.markdown-body blockquote > p {
    margin: 10px 0
}

.markdown-body ol, .markdown-body ul {
    padding-left: 28px
}

.markdown-body ol li, .markdown-body ul li {
    margin-bottom: 0;
    list-style: inherit
}

.markdown-body ol li .task-list-item, .markdown-body ul li .task-list-item {
    list-style: none
}

.markdown-body ol li .task-list-item ol, .markdown-body ol li .task-list-item ul, .markdown-body ul li .task-list-item ol, .markdown-body ul li .task-list-item ul {
    margin-top: 0
}

.markdown-body ol ol, .markdown-body ol ul, .markdown-body ul ol, .markdown-body ul ul {
    margin-top: 3px
}

.markdown-body ol li {
    padding-left: 6px
}

.markdown-body .contains-task-list {
    padding-left: 0
}

.markdown-body .task-list-item {
    list-style: none
}

@media (max-width: 720px) {
    .markdown-body h1 {
        font-size: 24px
    }

    .markdown-body h2 {
        font-size: 20px
    }

    .markdown-body h3 {
        font-size: 18px
    }
}
    </style>
</head>
<body>
<div class="markdown-body">
    <p>åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·ç³»ç»Ÿå­¦ä¹ äº† Vite çš„å®ç°æºç ï¼Œä»é…ç½®è§£æã€ä¾èµ–é¢„æ„å»ºã€æ’ä»¶æµæ°´çº¿å’Œ HMR è¿™å‡ ä¸ªæ–¹é¢å¸¦ä½ å®Œæ•´çš„æ¢³ç†äº† Vite çš„åº•å±‚åŸç†ï¼Œé‚£ä¹ˆï¼Œåœ¨æœ¬å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¿›ä¸€æ­¥ï¼Œç”¨å®é™…çš„ä»£ç æ¥å†™ä¸€ä¸ªè¿·ä½ ç‰ˆçš„ Viteï¼Œä¸»è¦å®ç° Vite æœ€æ ¸å¿ƒçš„ no-bundle æ„å»ºæœåŠ¡ã€‚åœ¨å­¦å®Œæœ¬èŠ‚ä¹‹åï¼Œä½ ä¸ä»…èƒ½å¤Ÿå¤ä¹ ä¹‹å‰æ‰€ä»‹ç»çš„å„ç§åŸç†ï¼Œä¹Ÿèƒ½æ·±å…¥åœ°ç†è§£ä»£ç å±‚é¢çš„å®ç°ç»†èŠ‚ï¼Œæ‹¥æœ‰ç‹¬ç«‹å¼€å‘ä¸€ä¸ª no-bundle æ„å»ºå·¥å…·çš„èƒ½åŠ›ã€‚</p>
<h2>å®æˆ˜æ¦‚è§ˆ</h2>
<p>ç›¸è¾ƒäºå‰é¢çš„å°èŠ‚ï¼Œæœ¬å°èŠ‚(ä»¥åŠä¸‹ä¸€å°èŠ‚)çš„å†…å®¹ä¼šæ¯”è¾ƒéš¾ï¼Œæ‰‹å†™çš„ä»£ç é‡ä¹Ÿæ¯”è¾ƒå¤š(æ€»å…±è¿‘ä¸€åƒè¡Œ)ã€‚å› æ­¤ï¼Œåœ¨å¼€å§‹ä»£ç å®æˆ˜ä¹‹å‰ï¼Œæˆ‘å…ˆç»™å¤§å®¶æ¢³ç†ä¸€ä¸‹éœ€è¦å®Œæˆçš„æ¨¡å—å’ŒåŠŸèƒ½ï¼Œè®©å¤§å®¶æœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤çŸ¥:</p>
<ol>
<li>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œå¼€å‘ç¯å¢ƒçš„æ­å»ºï¼Œå®‰è£…å¿…è¦çš„ä¾èµ–ï¼Œå¹¶æ­å»ºé¡¹ç›®çš„æ„å»ºè„šæœ¬ï¼ŒåŒæ—¶å®Œæˆ cli å·¥å…·çš„åˆå§‹åŒ–ä»£ç ã€‚</p>
</li>
<li>
<p>ç„¶åæˆ‘ä»¬æ­£å¼å¼€å§‹å®ç°<code>ä¾èµ–é¢„æ„å»º</code>çš„åŠŸèƒ½ï¼Œé€šè¿‡ Esbuild å®ç°ä¾èµ–æ‰«æå’Œä¾èµ–æ„å»ºçš„åŠŸèƒ½ã€‚</p>
</li>
<li>
<p>æ¥ç€å¼€å§‹æ­å»º Vite çš„æ’ä»¶æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯å¼€å‘ <code>PluginContainer</code> å’Œ <code>PluginContext</code> ä¸¤ä¸ªä¸»è¦çš„å¯¹è±¡ã€‚</p>
</li>
<li>
<p>æ­å»ºå®Œæ’ä»¶æœºåˆ¶ä¹‹åï¼Œæˆ‘ä»¬å°†ä¼šå¼€å‘ä¸€ç³»åˆ—çš„æ’ä»¶æ¥å®ç° no-bundle æœåŠ¡çš„ç¼–è¯‘æ„å»ºèƒ½åŠ›ï¼ŒåŒ…æ‹¬å…¥å£ HTML å¤„ç†ã€ TS/TSX/JS/TSX ç¼–è¯‘ã€CSS ç¼–è¯‘å’Œé™æ€èµ„æºå¤„ç†ã€‚</p>
</li>
<li>
<p>æœ€åï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€å¥—ç³»ç»ŸåŒ–çš„æ¨¡å—çƒ­æ›´æ–°çš„èƒ½åŠ›ï¼Œä»æ­å»ºæ¨¡å—ä¾èµ–å›¾å¼€å§‹ï¼Œé€æ­¥å®ç° HMR æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„å¼€å‘ã€‚</p>
</li>
</ol>
<p><img src="img\ca4eaedb-ae61-11ed-bbb0-342eb7027b95.jpg" alt="image.png"></p>
<h2>æ­å»ºå¼€å‘ç¯å¢ƒ</h2>
<blockquote>
<p>æ³¨: æ‰‹å†™ Vite é¡¹ç›®çš„æ‰€æœ‰ä»£ç ï¼Œæˆ‘å·²ç»æ”¾åˆ°äº†å°å†Œçš„ Github ä»“åº“ä¸­ï¼Œ<a href="https://github.com/sanyuan0704/juejin-book-vite/tree/main/mini-vite" target="_blank" rel="nofollow noopener noreferrer">ç‚¹å‡»æŸ¥çœ‹</a>ã€‚</p>
</blockquote>
<p>é¦–å…ˆï¼Œä½ å¯ä»¥æ‰§è¡Œ<code>pnpm init -y</code>æ¥åˆå§‹åŒ–é¡¹ç›®ï¼Œç„¶åå®‰è£…ä¸€äº›å¿…è¦çš„ä¾èµ–ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹:</p>
<blockquote>
<p>å¯¹äºå„ä¸ªä¾èµ–çš„å…·ä½“ä½œç”¨ï¼Œå¤§å®¶å…ˆä¸ç”¨çº ç»“ï¼Œæˆ‘å°†ä¼šåœ¨åé¢ä½¿ç”¨åˆ°ä¾èµ–çš„æ—¶å€™ä»‹ç»ã€‚</p>
</blockquote>
<pre><code class="hljs language-ts"><span class="hljs-comment">// è¿è¡Œæ—¶ä¾èµ–</span>
pnpm i cac chokidar connect debug es-<span class="hljs-variable language_">module</span>-lexer esbuild fs-extra magic-<span class="hljs-built_in">string</span> picocolors resolve rollup sirv ws -S

<span class="hljs-comment">// å¼€å‘ç¯å¢ƒä¾èµ–</span>
pnpm i <span class="hljs-meta">@types</span>/connect <span class="hljs-meta">@types</span>/debug <span class="hljs-meta">@types</span>/fs-extra <span class="hljs-meta">@types</span>/resolve <span class="hljs-meta">@types</span>/ws tsup
</code></pre>
<p>Vite æœ¬èº«ä½¿ç”¨çš„æ˜¯ Rollup è¿›è¡Œè‡ªèº«çš„æ‰“åŒ…ï¼Œä½†ä¹‹å‰ç»™å¤§å®¶ä»‹ç»çš„ tsup ä¹Ÿèƒ½å¤Ÿå®ç°åº“æ‰“åŒ…çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å†…ç½® esbuild è¿›è¡Œæé€Ÿï¼Œæ€§èƒ½ä¸Šæ›´åŠ å¼ºæ‚ï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ tsup è¿›è¡Œé¡¹ç›®çš„æ„å»ºã€‚</p>
<p>ä¸ºäº†æ¥å…¥ tsup æ‰“åŒ…åŠŸèƒ½ï¼Œä½ éœ€è¦åœ¨ package.json ä¸­åŠ å…¥è¿™äº›å‘½ä»¤:</p>
<pre><code class="hljs language-ts"><span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"tsup --watch"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsup --minify"</span>
},
</code></pre>
<p>åŒæ—¶ï¼Œä½ éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•æ–°å»º<code>tsconfig.json</code>å’Œ<code>tsup.config.ts</code>è¿™ä¸¤ä»½é…ç½®æ–‡ä»¶ï¼Œå†…å®¹åˆ†åˆ«å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// tsconfig.json</span>
{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-comment">// æ”¯æŒ commonjs æ¨¡å—çš„ default importï¼Œå¦‚ import path from 'path'</span>
    <span class="hljs-comment">// å¦åˆ™åªèƒ½é€šè¿‡ import * as path from 'path' è¿›è¡Œå¯¼å…¥</span>
    <span class="hljs-string">"esModuleInterop"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">"target"</span>: <span class="hljs-string">"ES2020"</span>,
    <span class="hljs-string">"moduleResolution"</span>: <span class="hljs-string">"node"</span>,
    <span class="hljs-string">"module"</span>: <span class="hljs-string">"ES2020"</span>,
    <span class="hljs-string">"strict"</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<pre><code class="hljs language-ts"><span class="hljs-comment">// tsup.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"tsup"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// åç»­ä¼šå¢åŠ  entry</span>
  <span class="hljs-attr">entry</span>: {
    <span class="hljs-attr">index</span>: <span class="hljs-string">"src/node/cli.ts"</span>,
  },
  <span class="hljs-comment">// äº§ç‰©æ ¼å¼ï¼ŒåŒ…å« esm å’Œ cjs æ ¼å¼</span>
  <span class="hljs-attr">format</span>: [<span class="hljs-string">"esm"</span>, <span class="hljs-string">"cjs"</span>],
  <span class="hljs-comment">// ç›®æ ‡è¯­æ³•</span>
  <span class="hljs-attr">target</span>: <span class="hljs-string">"es2020"</span>,
  <span class="hljs-comment">// ç”Ÿæˆ sourcemap</span>
  <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// æ²¡æœ‰æ‹†åŒ…çš„éœ€æ±‚ï¼Œå…³é—­æ‹†åŒ…èƒ½åŠ›</span>
  <span class="hljs-attr">splitting</span>: <span class="hljs-literal">false</span>,
});
</code></pre>
<p>æ¥ç€æ–°å»º <code>src/node/cli.ts</code>æ–‡ä»¶ï¼Œæˆ‘ä»¬è¿›è¡Œ cli çš„åˆå§‹åŒ–:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/cli.ts</span>
<span class="hljs-keyword">import</span> cac <span class="hljs-keyword">from</span> <span class="hljs-string">"cac"</span>;

<span class="hljs-keyword">const</span> cli = <span class="hljs-title function_">cac</span>();

<span class="hljs-comment">// [] ä¸­çš„å†…å®¹ä¸ºå¯é€‰å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…è¾“å…¥ `vite` å‘½ä»¤ä¸‹ä¼šæ‰§è¡Œä¸‹é¢çš„é€»è¾‘</span>
cli
  .<span class="hljs-title function_">command</span>(<span class="hljs-string">"[root]"</span>, <span class="hljs-string">"Run the development server"</span>)
  .<span class="hljs-title function_">alias</span>(<span class="hljs-string">"serve"</span>)
  .<span class="hljs-title function_">alias</span>(<span class="hljs-string">"dev"</span>)
  .<span class="hljs-title function_">action</span>(<span class="hljs-keyword">async</span> () => {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'æµ‹è¯• cli~'</span>);
  });

cli.<span class="hljs-title function_">help</span>();

cli.<span class="hljs-title function_">parse</span>();
</code></pre>
<p>ç°åœ¨ä½ å¯ä»¥æ‰§è¡Œ <code>pnpm start</code> æ¥ç¼–è¯‘è¿™ä¸ª<code>mini-vite</code>é¡¹ç›®ï¼Œtsup ä¼šç”Ÿæˆäº§ç‰©ç›®å½•<code>dist</code>ï¼Œç„¶åä½ å¯ä»¥æ–°å»º<code>bin/mini-vite</code>æ–‡ä»¶æ¥å¼•ç”¨äº§ç‰©:</p>
<pre><code class="hljs language-ts"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-built_in">require</span>(<span class="hljs-string">"../dist/index.js"</span>);
</code></pre>
<p>åŒæ—¶ï¼Œä½ éœ€è¦åœ¨ package.json ä¸­æ³¨å†Œ<code>mini-vite</code>å‘½ä»¤ï¼Œé…ç½®å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-string">"bin"</span>: {
    <span class="hljs-string">"mini-vite"</span>: <span class="hljs-string">"bin/mini-vite"</span>
  }
}
</code></pre>
<p>å¦‚æ­¤ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸šåŠ¡é¡¹ç›®ä¸­ä½¿ç”¨ <code>mini-vite</code> è¿™ä¸ªå‘½ä»¤äº†ã€‚åœ¨å°å†Œçš„ Github ä»“åº“ä¸­æˆ‘ä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªç¤ºä¾‹çš„ <code>playground</code> é¡¹ç›®ï¼Œä½ å¯ä»¥æ‹¿æ¥è¿›è¡Œæµ‹è¯•ï¼Œ<a href="https://github.com/sanyuan0704/juejin-book-vite/tree/main/mini-vite/playground" target="_blank" rel="nofollow noopener noreferrer">ç‚¹å‡»æŸ¥çœ‹é¡¹ç›®</a>ã€‚</p>
<p>å°† <code>playground</code> é¡¹ç›®æ”¾åœ¨ <code>mini-vite</code> ç›®å½•ä¸­ï¼Œç„¶åæ‰§è¡Œ <code>pnpm i</code>ï¼Œç”±äºé¡¹ç›®çš„<code>dependencies</code>ä¸­å·²ç»å£°æ˜äº†<code>mini-vite</code>:</p>
<pre><code class="hljs language-ts">{
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"mini-vite"</span>: <span class="hljs-string">'../'</span>
  }
}
</code></pre>
<p>é‚£ä¹ˆ<code>mini-vite</code>å‘½ä»¤ä¼šè‡ªåŠ¨å®‰è£…åˆ°æµ‹è¯•é¡¹ç›®çš„<code>node_modules/.bin</code>ç›®å½•ä¸­:</p>
<p><img src="img\ca7efd7b-ae61-11ed-89cc-342eb7027b95.jpg" alt="image.png"></p>
<p>æ¥ç€æˆ‘ä»¬åœ¨<code>playground</code>é¡¹ç›®ä¸­æ‰§è¡Œ<code>pnpm dev</code>å‘½ä»¤(å†…éƒ¨æ‰§è¡Œ<code>mini-vite</code>)ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„ log ä¿¡æ¯:</p>
<pre><code class="hljs">æµ‹è¯• cli~
</code></pre>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æŠŠ<code>console.log</code>è¯­å¥æ¢æˆæœåŠ¡å¯åŠ¨çš„é€»è¾‘:</p>
<pre><code class="hljs language-diff">import cac from "cac";
<span class="hljs-addition">+ import { startDevServer } from "./server";</span>

const cli = cac();

cli
  .command("[root]", "Run the development server")
  .alias("serve")
  .alias("dev")
  .action(async () => {
<span class="hljs-deletion">-    console.log('æµ‹è¯• cli~');</span>
<span class="hljs-addition">+    await startDevServer();</span>
  });
</code></pre>
<p>ç°åœ¨ä½ éœ€è¦æ–°å»º<code>src/node/server/index.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// connect æ˜¯ä¸€ä¸ªå…·æœ‰ä¸­é—´ä»¶æœºåˆ¶çš„è½»é‡çº§ Node.js æ¡†æ¶ã€‚</span>
<span class="hljs-comment">// æ—¢å¯ä»¥å•ç‹¬ä½œä¸ºæœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ¥å…¥åˆ°ä»»ä½•å…·æœ‰ä¸­é—´ä»¶æœºåˆ¶çš„æ¡†æ¶ä¸­ï¼Œå¦‚ Koaã€Express</span>
<span class="hljs-keyword">import</span> connect <span class="hljs-keyword">from</span> <span class="hljs-string">"connect"</span>;
<span class="hljs-comment">// picocolors æ˜¯ä¸€ä¸ªç”¨æ¥åœ¨å‘½ä»¤è¡Œæ˜¾ç¤ºä¸åŒé¢œè‰²æ–‡æœ¬çš„å·¥å…·</span>
<span class="hljs-keyword">import</span> { blue, green } <span class="hljs-keyword">from</span> <span class="hljs-string">"picocolors"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startDevServer</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">connect</span>();
  <span class="hljs-keyword">const</span> root = process.<span class="hljs-title function_">cwd</span>();
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-keyword">async</span> () => {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
      <span class="hljs-title function_">green</span>(<span class="hljs-string">"ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!"</span>),
      <span class="hljs-string">`è€—æ—¶: <span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - startTime}</span>ms`</span>
    );
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`> æœ¬åœ°è®¿é—®è·¯å¾„: <span class="hljs-subst">${blue(<span class="hljs-string">"http://localhost:3000"</span>)}</span>`</span>);
  });
}
</code></pre>
<p>å†æ¬¡æ‰§è¡Œ<code>pnpm dev</code>ï¼Œä½ å¯ä»¥å‘ç°ç»ˆç«¯å‡ºç°å¦‚ä¸‹çš„å¯åŠ¨æ—¥å¿—:</p>
<p><img src="img\caa3d8f6-ae61-11ed-bc7b-342eb7027b95.jpg" alt="image.png"></p>
<p>OKï¼Œ<code>mini-vite</code> çš„ cli åŠŸèƒ½å’ŒæœåŠ¡å¯åŠ¨çš„é€»è¾‘ç›®å‰å°±å·²ç»æˆåŠŸæ­å»ºèµ·æ¥äº†ã€‚</p>
<h2>ä¾èµ–é¢„æ„å»º</h2>
<p>ç°åœ¨æˆ‘ä»¬æ¥è¿›å…¥ä¾èµ–é¢„æ„å»ºé˜¶æ®µçš„å¼€å‘ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æ–°å»º<code>src/node/optimizer/index.ts</code>æ¥å­˜æ”¾ä¾èµ–é¢„æ„å»ºçš„é€»è¾‘:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params">root: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. ç¡®å®šå…¥å£</span>
  <span class="hljs-comment">// 2. ä»å…¥å£å¤„æ‰«æä¾èµ–</span>
  <span class="hljs-comment">// 3. é¢„æ„å»ºä¾èµ–</span>
}
</code></pre>
<p>ç„¶ååœ¨æœåŠ¡å…¥å£ä¸­å¼•å…¥é¢„æ„å»ºçš„é€»è¾‘:</p>
<pre><code class="hljs language-diff">// src/node/server/index.ts
import connect from "connect";
import { blue, green } from "picocolors";
<span class="hljs-addition">+ import { optimize } from "../optimizer/index";</span>

export async function startDevServer() {
  const app = connect();
  const root = process.cwd();
  const startTime = Date.now();
  app.listen(3000, async () => {
<span class="hljs-addition">+   await optimize(root);</span>

    console.log(
      green("ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!"),
      `è€—æ—¶: ${Date.now() - startTime}ms`
    );
    console.log(`> æœ¬åœ°è®¿é—®è·¯å¾„: ${blue("http://localhost:3000")}`);
  });
}
</code></pre>
<p>æ¥ç€æˆ‘ä»¬æ¥å¼€å‘ä¾èµ–é¢„æ„å»ºçš„åŠŸèƒ½ï¼Œä»ä¸Šé¢çš„ä»£ç æ³¨é‡Šä½ ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬éœ€è¦å®Œæˆä¸‰éƒ¨åˆ†çš„é€»è¾‘:</p>
<ul>
<li>ç¡®å®šé¢„æ„å»ºå…¥å£</li>
<li>ä»å…¥å£å¼€å§‹æ‰«æå‡ºç”¨åˆ°çš„ä¾èµ–</li>
<li>å¯¹ä¾èµ–è¿›è¡Œé¢„æ„å»º</li>
</ul>
<p>é¦–å…ˆæ˜¯ç¡®å®šå…¥å£ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œæˆ‘ç›´æ¥çº¦å®šä¸º src ç›®å½•ä¸‹çš„<code>main.tsx</code>æ–‡ä»¶:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// éœ€è¦å¼•å…¥çš„ä¾èµ–</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;

<span class="hljs-comment">// 1. ç¡®å®šå…¥å£</span>
<span class="hljs-keyword">const</span> entry = path.<span class="hljs-title function_">resolve</span>(root, <span class="hljs-string">"src/main.tsx"</span>);
</code></pre>
<p>ç¬¬äºŒæ­¥æ˜¯æ‰«æä¾èµ–:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// éœ€è¦å¼•å…¥çš„ä¾èµ– </span>
<span class="hljs-keyword">import</span> { build } <span class="hljs-keyword">from</span> <span class="hljs-string">"esbuild"</span>;
<span class="hljs-keyword">import</span> { green } <span class="hljs-keyword">from</span> <span class="hljs-string">"picocolors"</span>;
<span class="hljs-keyword">import</span> { scanPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./scanPlugin"</span>;

<span class="hljs-comment">// 2. ä»å…¥å£å¤„æ‰«æä¾èµ–</span>
<span class="hljs-keyword">const</span> deps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&#x3C;<span class="hljs-built_in">string</span>>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">build</span>({
  <span class="hljs-attr">entryPoints</span>: [entry],
  <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">write</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">scanPlugin</span>(deps)],
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
<span class="hljs-string">`<span class="hljs-subst">${green(<span class="hljs-string">"éœ€è¦é¢„æ„å»ºçš„ä¾èµ–"</span>)}</span>:\n<span class="hljs-subst">${[...deps]
  .map(green)
  .map((item) => <span class="hljs-string">`  <span class="hljs-subst">${item}</span>`</span>)
  .join(<span class="hljs-string">"\n"</span>)}</span>`</span>
);
</code></pre>
<p>ä¾èµ–æ‰«æéœ€è¦æˆ‘ä»¬å€ŸåŠ© Esbuild æ’ä»¶æ¥å®Œæˆï¼Œæœ€åä¼šè®°å½•åˆ° deps è¿™ä¸ªé›†åˆä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ¼äº Esbuild ä¾èµ–æ‰«ææ’ä»¶çš„å¼€å‘ï¼Œä½ éœ€è¦åœ¨<code>optimzier</code>ç›®å½•ä¸­æ–°å»º<code>scanPlguin.ts</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/optimizer/scanPlugin.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"esbuild"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">BARE_IMPORT_RE</span>, <span class="hljs-variable constant_">EXTERNAL_TYPES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../constants"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">scanPlugin</span>(<span class="hljs-params">deps: <span class="hljs-built_in">Set</span>&#x3C;<span class="hljs-built_in">string</span>></span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"esbuild:scan-deps"</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
      <span class="hljs-comment">// å¿½ç•¥çš„æ–‡ä»¶ç±»å‹</span>
      build.<span class="hljs-title function_">onResolve</span>(
        { <span class="hljs-attr">filter</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`\\.(<span class="hljs-subst">${EXTERNAL_TYPES.join(<span class="hljs-string">"|"</span>)}</span>)$`</span>) },
        <span class="hljs-function">(<span class="hljs-params">resolveInfo</span>) =></span> {
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">path</span>: resolveInfo.<span class="hljs-property">path</span>,
            <span class="hljs-comment">// æ‰“ä¸Š external æ ‡è®°</span>
            <span class="hljs-attr">external</span>: <span class="hljs-literal">true</span>,
          };
        }
      );
      <span class="hljs-comment">// è®°å½•ä¾èµ–</span>
      build.<span class="hljs-title function_">onResolve</span>(
        {
          <span class="hljs-attr">filter</span>: <span class="hljs-variable constant_">BARE_IMPORT_RE</span>,
        },
        <span class="hljs-function">(<span class="hljs-params">resolveInfo</span>) =></span> {
          <span class="hljs-keyword">const</span> { <span class="hljs-attr">path</span>: id } = resolveInfo;
          <span class="hljs-comment">// æ¨å…¥ deps é›†åˆä¸­</span>
          deps.<span class="hljs-title function_">add</span>(id);
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">path</span>: id,
            <span class="hljs-attr">external</span>: <span class="hljs-literal">true</span>,
          };
        }
      );
    },
  };
}
</code></pre>
<p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ–‡ä»¶ä¸­ç”¨åˆ°äº†ä¸€äº›å¸¸é‡ï¼Œåœ¨<code>src/node/constants.ts</code>ä¸­å®šä¹‰ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EXTERNAL_TYPES</span> = [
  <span class="hljs-string">"css"</span>,
  <span class="hljs-string">"less"</span>,
  <span class="hljs-string">"sass"</span>,
  <span class="hljs-string">"scss"</span>,
  <span class="hljs-string">"styl"</span>,
  <span class="hljs-string">"stylus"</span>,
  <span class="hljs-string">"pcss"</span>,
  <span class="hljs-string">"postcss"</span>,
  <span class="hljs-string">"vue"</span>,
  <span class="hljs-string">"svelte"</span>,
  <span class="hljs-string">"marko"</span>,
  <span class="hljs-string">"astro"</span>,
  <span class="hljs-string">"png"</span>,
  <span class="hljs-string">"jpe?g"</span>,
  <span class="hljs-string">"gif"</span>,
  <span class="hljs-string">"svg"</span>,
  <span class="hljs-string">"ico"</span>,
  <span class="hljs-string">"webp"</span>,
  <span class="hljs-string">"avif"</span>,
];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BARE_IMPORT_RE</span> = <span class="hljs-regexp">/^[\w@][^:]/</span>;
</code></pre>
<p>æ’ä»¶çš„é€»è¾‘éå¸¸ç®€å•ï¼Œå³æŠŠä¸€äº›æ— å…³çš„èµ„æºè¿›è¡Œ externalï¼Œä¸è®© esbuild å¤„ç†ï¼Œé˜²æ­¢ Esbuild æŠ¥é”™ï¼ŒåŒæ—¶å°†<code>bare import</code>çš„è·¯å¾„è§†ä½œç¬¬ä¸‰æ–¹åŒ…ï¼Œæ¨å…¥ deps é›†åˆä¸­ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨<code>playground</code>é¡¹ç›®æ ¹è·¯å¾„ä¸­æ‰§è¡Œ<code>pnpm dev</code>ï¼Œå¯ä»¥å‘ç°ä¾èµ–æ‰«æå·²ç»æˆåŠŸæ‰§è¡Œ:</p>
<p><img src="img\cac0b262-ae61-11ed-a0e2-342eb7027b95.jpg" alt="image.png"></p>
<p>å½“æˆ‘ä»¬æ”¶é›†åˆ°æ‰€æœ‰çš„ä¾èµ–ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥å¯¹æ¯ä¸ªä¾èµ–è¿›è¡Œæ‰“åŒ…ï¼Œå®Œæˆä¾èµ–é¢„æ„å»ºäº†:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/optimizer/index.ts</span>
<span class="hljs-comment">// éœ€è¦å¼•å…¥çš„ä¾èµ–</span>
<span class="hljs-keyword">import</span> { preBundlePlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./preBundlePlugin"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PRE_BUNDLE_DIR</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../constants"</span>;

<span class="hljs-comment">// 3. é¢„æ„å»ºä¾èµ–</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">build</span>({
  <span class="hljs-attr">entryPoints</span>: [...deps],
  <span class="hljs-attr">write</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">format</span>: <span class="hljs-string">"esm"</span>,
  <span class="hljs-attr">splitting</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">outdir</span>: path.<span class="hljs-title function_">resolve</span>(root, <span class="hljs-variable constant_">PRE_BUNDLE_DIR</span>),
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">preBundlePlugin</span>(deps)],
});
</code></pre>
<p>åœ¨æ­¤ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å¸¸é‡<code>PRE_BUNDLE_DIR</code>ï¼Œå®šä¹‰å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/constants.ts</span>
<span class="hljs-comment">// å¢åŠ å¦‚ä¸‹ä»£ç </span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;

<span class="hljs-comment">// é¢„æ„å»ºäº§ç‰©é»˜è®¤å­˜æ”¾åœ¨ node_modules ä¸­çš„ .m-vite ç›®å½•ä¸­</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRE_BUNDLE_DIR</span> = path.<span class="hljs-title function_">join</span>(<span class="hljs-string">"node_modules"</span>, <span class="hljs-string">".m-vite"</span>);
</code></pre>
<p>æ¥ç€ï¼Œæˆ‘ä»¬ç»§ç»­å¼€å‘é¢„æ„å»ºçš„ Esbuild æ’ä»¶ã€‚é¦–å…ˆï¼Œè€ƒè™‘åˆ°å…¼å®¹ Windows ç³»ç»Ÿï¼Œæˆ‘ä»¬å…ˆåŠ å…¥ä¸€æ®µå·¥å…·å‡½æ•°çš„ä»£ç :</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/utils.ts</span>
<span class="hljs-keyword">import</span> os <span class="hljs-keyword">from</span> <span class="hljs-string">"os"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slash</span>(<span class="hljs-params">p: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> p.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\\/g</span>, <span class="hljs-string">"/"</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isWindows = os.<span class="hljs-title function_">platform</span>() === <span class="hljs-string">"win32"</span>;


<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizePath</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> path.<span class="hljs-property">posix</span>.<span class="hljs-title function_">normalize</span>(isWindows ? <span class="hljs-title function_">slash</span>(id) : id);
}
</code></pre>
<p>ç„¶åå®Œå–„é¢„æ„å»ºçš„ä»£ç :</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Loader</span>, <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"esbuild"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">BARE_IMPORT_RE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../constants"</span>;
<span class="hljs-comment">// ç”¨æ¥åˆ†æ es æ¨¡å— import/export è¯­å¥çš„åº“</span>
<span class="hljs-keyword">import</span> { init, parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"es-module-lexer"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-comment">// ä¸€ä¸ªå®ç°äº† node è·¯å¾„è§£æç®—æ³•çš„åº“</span>
<span class="hljs-keyword">import</span> resolve <span class="hljs-keyword">from</span> <span class="hljs-string">"resolve"</span>;
<span class="hljs-comment">// ä¸€ä¸ªæ›´åŠ å¥½ç”¨çš„æ–‡ä»¶æ“ä½œåº“</span>
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs-extra"</span>;
<span class="hljs-comment">// ç”¨æ¥å¼€å‘æ‰“å° debug æ—¥å¿—çš„åº“</span>
<span class="hljs-keyword">import</span> createDebug <span class="hljs-keyword">from</span> <span class="hljs-string">"debug"</span>;
<span class="hljs-keyword">import</span> { normalizePath } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils"</span>;

<span class="hljs-keyword">const</span> debug = <span class="hljs-title function_">createDebug</span>(<span class="hljs-string">"dev"</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">preBundlePlugin</span>(<span class="hljs-params">deps: <span class="hljs-built_in">Set</span>&#x3C;<span class="hljs-built_in">string</span>></span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"esbuild:pre-bundle"</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params">build</span>) {
      build.<span class="hljs-title function_">onResolve</span>(
        {
          <span class="hljs-attr">filter</span>: <span class="hljs-variable constant_">BARE_IMPORT_RE</span>,
        },
        <span class="hljs-function">(<span class="hljs-params">resolveInfo</span>) =></span> {
          <span class="hljs-keyword">const</span> { <span class="hljs-attr">path</span>: id, importer } = resolveInfo;
          <span class="hljs-keyword">const</span> isEntry = !importer;
          <span class="hljs-comment">// å‘½ä¸­éœ€è¦é¢„ç¼–è¯‘çš„ä¾èµ–</span>
          <span class="hljs-keyword">if</span> (deps.<span class="hljs-title function_">has</span>(id)) {
            <span class="hljs-comment">// è‹¥ä¸ºå…¥å£ï¼Œåˆ™æ ‡è®° dep çš„ namespace</span>
            <span class="hljs-keyword">return</span> isEntry
              ? {
                  <span class="hljs-attr">path</span>: id,
                  <span class="hljs-attr">namespace</span>: <span class="hljs-string">"dep"</span>,
                }
              : {
                  <span class="hljs-comment">// å› ä¸ºèµ°åˆ° onResolve äº†ï¼Œæ‰€ä»¥è¿™é‡Œçš„ path å°±æ˜¯ç»å¯¹è·¯å¾„äº†</span>
                  <span class="hljs-attr">path</span>: resolve.<span class="hljs-title function_">sync</span>(id, { <span class="hljs-attr">basedir</span>: process.<span class="hljs-title function_">cwd</span>() }),
                };
          }
        }
      );

      <span class="hljs-comment">// æ‹¿åˆ°æ ‡è®°åçš„ä¾èµ–ï¼Œæ„é€ ä»£ç†æ¨¡å—ï¼Œäº¤ç»™ esbuild æ‰“åŒ…</span>
      build.<span class="hljs-title function_">onLoad</span>(
        {
          <span class="hljs-attr">filter</span>: <span class="hljs-regexp">/.*/</span>,
          <span class="hljs-attr">namespace</span>: <span class="hljs-string">"dep"</span>,
        },
        <span class="hljs-keyword">async</span> (loadInfo) => {
          <span class="hljs-keyword">await</span> init;
          <span class="hljs-keyword">const</span> id = loadInfo.<span class="hljs-property">path</span>;
          <span class="hljs-keyword">const</span> root = process.<span class="hljs-title function_">cwd</span>();
          <span class="hljs-keyword">const</span> entryPath = <span class="hljs-title function_">normalizePath</span>(resolve.<span class="hljs-title function_">sync</span>(id, { <span class="hljs-attr">basedir</span>: root }));
          <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(entryPath, <span class="hljs-string">"utf-8"</span>);
          <span class="hljs-keyword">const</span> [imports, <span class="hljs-built_in">exports</span>] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">parse</span>(code);
          <span class="hljs-keyword">let</span> proxyModule = [];
          <span class="hljs-comment">// cjs</span>
          <span class="hljs-keyword">if</span> (!imports.<span class="hljs-property">length</span> &#x26;&#x26; !<span class="hljs-built_in">exports</span>.<span class="hljs-property">length</span>) {
            <span class="hljs-comment">// æ„é€ ä»£ç†æ¨¡å—</span>
            <span class="hljs-comment">// ä¸‹é¢çš„ä»£ç åé¢ä¼šè§£é‡Š</span>
            <span class="hljs-keyword">const</span> res = <span class="hljs-built_in">require</span>(entryPath);
            <span class="hljs-keyword">const</span> specifiers = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(res);
            proxyModule.<span class="hljs-title function_">push</span>(
              <span class="hljs-string">`export { <span class="hljs-subst">${specifiers.join(<span class="hljs-string">","</span>)}</span> } from "<span class="hljs-subst">${entryPath}</span>"`</span>,
              <span class="hljs-string">`export default require("<span class="hljs-subst">${entryPath}</span>")`</span>
            );
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// esm æ ¼å¼æ¯”è¾ƒå¥½å¤„ç†ï¼Œexport * æˆ–è€… export default å³å¯</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">exports</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"default"</span>)) {
              proxyModule.<span class="hljs-title function_">push</span>(<span class="hljs-string">`import d from "<span class="hljs-subst">${entryPath}</span>";export default d`</span>);
            }
            proxyModule.<span class="hljs-title function_">push</span>(<span class="hljs-string">`export * from "<span class="hljs-subst">${entryPath}</span>"`</span>);
          }
          <span class="hljs-title function_">debug</span>(<span class="hljs-string">"ä»£ç†æ¨¡å—å†…å®¹: %o"</span>, proxyModule.<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));
          <span class="hljs-keyword">const</span> loader = path.<span class="hljs-title function_">extname</span>(entryPath).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">loader</span>: loader <span class="hljs-keyword">as</span> <span class="hljs-title class_">Loader</span>,
            <span class="hljs-attr">contents</span>: proxyModule.<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>),
            <span class="hljs-attr">resolveDir</span>: root,
          };
        }
      );
    },
  };
}
</code></pre>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå¯¹äº CommonJS æ ¼å¼çš„ä¾èµ–ï¼Œå•çº¯ç”¨ <code>export default require('å…¥å£è·¯å¾„')</code> æ˜¯æœ‰å±€é™æ€§çš„ï¼Œæ¯”å¦‚å¯¹äº React è€Œè¨€ï¼Œç”¨è¿™æ ·çš„æ–¹å¼ç”Ÿæˆçš„äº§ç‰©æœ€ååªæœ‰ default å¯¼å‡º:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// esbuild çš„æ‰“åŒ…äº§ç‰©</span>
<span class="hljs-comment">// çœç•¥å¤§éƒ¨åˆ†ä»£ç </span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> react_default;
</code></pre>
<p>é‚£ä¹ˆç”¨æˆ·åœ¨ä½¿ç”¨è¿™ä¸ªä¾èµ–çš„æ—¶å€™ï¼Œå¿…é¡»è¿™ä¹ˆä½¿ç”¨:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// âœ… æ­£ç¡®</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> { useState } = <span class="hljs-title class_">React</span>;

<span class="hljs-comment">// âŒ æŠ¥é”™</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<p>é‚£ä¸ºä»€ä¹ˆä¸Šè¿°ä¼šæŠ¥é”™çš„è¯­æ³•åœ¨ Vite æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„å‘¢ï¼ŸåŸå› æ˜¯ Vite åœ¨åš import è¯­å¥åˆ†æçš„æ—¶å€™ï¼Œè‡ªåŠ¨å°†ä½ çš„ä»£ç è¿›è¡Œæ”¹å†™äº†:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// åŸæ¥çš„å†™æ³•</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// Vite çš„ importAnalysis æ’ä»¶è½¬æ¢åçš„å†™æ³•ç±»ä¼¼ä¸‹é¢è¿™æ ·</span>
<span class="hljs-keyword">import</span> react_default <span class="hljs-keyword">from</span> <span class="hljs-string">'/node_modules/.vite/react.js'</span>;

<span class="hljs-keyword">const</span> { useState } = react_default;
</code></pre>
<p>é‚£ä¹ˆï¼Œè¿˜æœ‰æ²¡æœ‰åˆ«çš„æ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿæ²¡é”™ï¼Œä¸Šè¿°çš„æ’ä»¶ä»£ç ä¸­å·²ç»ç”¨å¦ä¸€ä¸ªæ–¹æ¡ˆè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠç›®å…‰é›†ä¸­åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­:</p>
<pre><code class="hljs language-ts">  <span class="hljs-keyword">if</span> (!imports.<span class="hljs-property">length</span> &#x26;&#x26; !<span class="hljs-built_in">exports</span>.<span class="hljs-property">length</span>) {
    <span class="hljs-comment">// æ„é€ ä»£ç†æ¨¡å—</span>
    <span class="hljs-comment">// é€šè¿‡ require æ‹¿åˆ°æ¨¡å—çš„å¯¼å‡ºå¯¹è±¡</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-built_in">require</span>(entryPath);
    <span class="hljs-comment">// ç”¨ Object.keys æ‹¿åˆ°æ‰€æœ‰çš„å…·åå¯¼å‡º</span>
    <span class="hljs-keyword">const</span> specifiers = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(res);
    <span class="hljs-comment">// æ„é€  export è¯­å¥äº¤ç»™ Esbuild æ‰“åŒ…</span>
    proxyModule.<span class="hljs-title function_">push</span>(
      <span class="hljs-string">`export { <span class="hljs-subst">${specifiers.join(<span class="hljs-string">","</span>)}</span> } from "<span class="hljs-subst">${entryPath}</span>"`</span>,
      <span class="hljs-string">`export default require("<span class="hljs-subst">${entryPath}</span>")`</span>
    );
  }
</code></pre>
<p>å¦‚æ­¤ä¸€æ¥ï¼ŒEsbuild é¢„æ„å»ºçš„äº§ç‰©ä¸­ä¾¿ä¼šåŒ…å« CommonJS æ¨¡å—ä¸­æ‰€æœ‰çš„å¯¼å‡ºä¿¡æ¯:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// é¢„æ„å»ºäº§ç‰©å¯¼å‡ºä»£ç </span>
<span class="hljs-keyword">export</span> {
  react_default <span class="hljs-keyword">as</span> <span class="hljs-keyword">default</span>,
  useState,
  useEffect,
  <span class="hljs-comment">// çœç•¥å…¶å®ƒå¯¼å‡º</span>
}
</code></pre>
<p>OKï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹é¢„æ„å»ºæ•´ä½“çš„åŠŸèƒ½ã€‚åœ¨ <code>playground</code> é¡¹ç›®ä¸­æ‰§è¡Œ <code>pnpm dev</code>ï¼Œæ¥ç€å»é¡¹ç›®çš„ <code>node_modules</code> ç›®å½•ä¸­ï¼Œå¯ä»¥å‘ç°æ–°å¢äº†<code>.m-vite</code> ç›®å½•åŠ<code>react</code>ã€<code>react-dom</code>çš„é¢„æ„å»ºäº§ç‰©:</p>
<p><img src="img\cada8e80-ae61-11ed-a129-342eb7027b95.jpg" alt="image.png"></p>
<h2>æ’ä»¶æœºåˆ¶å¼€å‘</h2>
<p>åœ¨å®Œæˆäº†ä¾èµ–é¢„æ„å»ºçš„åŠŸèƒ½ä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹æ­å»º Vite çš„æ’ä»¶æœºåˆ¶ï¼Œå®ç°æ’ä»¶å®¹å™¨å’Œæ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡ã€‚</p>
<p>é¦–å…ˆï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/pluginContainer.ts</code>æ–‡ä»¶ï¼Œå¢åŠ å¦‚ä¸‹çš„ç±»å‹å®šä¹‰:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">LoadResult</span>,
  <span class="hljs-title class_">PartialResolvedId</span>,
  <span class="hljs-title class_">SourceDescription</span>,
  <span class="hljs-title class_">PluginContext</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RollupPluginContext</span>,
  <span class="hljs-title class_">ResolvedId</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"rollup"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PluginContainer</span> {
  <span class="hljs-title function_">resolveId</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, importer?: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">PartialResolvedId</span> | <span class="hljs-literal">null</span>>;
  <span class="hljs-title function_">load</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">LoadResult</span> | <span class="hljs-literal">null</span>>;
  <span class="hljs-title function_">transform</span>(<span class="hljs-attr">code</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">SourceDescription</span> | <span class="hljs-literal">null</span>>;
}
</code></pre>
<p>å¦å¤–ï¼Œç”±äºæ’ä»¶å®¹å™¨éœ€è¦æ¥æ”¶ Vite æ’ä»¶ä½œä¸ºåˆå§‹åŒ–å‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æå‰å£°æ˜æ’ä»¶çš„ç±»å‹ï¼Œä½ å¯ä»¥ç»§ç»­æ–°å»º<code>src/node/plugin.ts</code>æ¥å£°æ˜å¦‚ä¸‹çš„æ’ä»¶ç±»å‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LoadResult</span>, <span class="hljs-title class_">PartialResolvedId</span>, <span class="hljs-title class_">SourceDescription</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"rollup"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./server"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerHook</span> = <span class="hljs-function">(<span class="hljs-params">
  server: ServerContext
</span>) =></span> (<span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>) | <span class="hljs-built_in">void</span> | <span class="hljs-title class_">Promise</span>&#x3C;(<span class="hljs-function">() =></span> <span class="hljs-built_in">void</span>) | <span class="hljs-built_in">void</span>>;

<span class="hljs-comment">// åªå®ç°ä»¥ä¸‹è¿™å‡ ä¸ªé’©å­</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  configureServer?: <span class="hljs-title class_">ServerHook</span>;
  resolveId?: <span class="hljs-function">(<span class="hljs-params">
    id: <span class="hljs-built_in">string</span>,
    importer?: <span class="hljs-built_in">string</span>
  </span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">PartialResolvedId</span> | <span class="hljs-literal">null</span>> | <span class="hljs-title class_">PartialResolvedId</span> | <span class="hljs-literal">null</span>;
  load?: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">LoadResult</span> | <span class="hljs-literal">null</span>> | <span class="hljs-title class_">LoadResult</span> | <span class="hljs-literal">null</span>;
  transform?: <span class="hljs-function">(<span class="hljs-params">
    code: <span class="hljs-built_in">string</span>,
    id: <span class="hljs-built_in">string</span>
  </span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-title class_">SourceDescription</span> | <span class="hljs-literal">null</span>> | <span class="hljs-title class_">SourceDescription</span> | <span class="hljs-literal">null</span>;
  transformIndexHtml?: <span class="hljs-function">(<span class="hljs-params">raw: <span class="hljs-built_in">string</span></span>) =></span> <span class="hljs-title class_">Promise</span>&#x3C;<span class="hljs-built_in">string</span>> | <span class="hljs-built_in">string</span>;
}
</code></pre>
<p>å¯¹äºå…¶ä¸­çš„ ServerContextï¼Œä½ æš‚æ—¶ä¸ç”¨è¿‡äºå…³å¿ƒï¼Œåªéœ€è¦åœ¨<code>server/index.ts</code>ä¸­ç®€å•å£°æ˜ä¸€ä¸‹ç±»å‹å³å¯:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/server/index.ts</span>
<span class="hljs-comment">// å¢åŠ å¦‚ä¸‹ç±»å‹å£°æ˜</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ServerContext</span> {}
</code></pre>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥å®ç°æ’ä»¶æœºåˆ¶çš„å…·ä½“é€»è¾‘ï¼Œä¸»è¦é›†ä¸­åœ¨<code>createPluginContainer</code>å‡½æ•°ä¸­:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/pluginContainer.ts</span>
<span class="hljs-comment">// æ¨¡æ‹Ÿ Rollup çš„æ’ä»¶æœºåˆ¶</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createPluginContainer = (<span class="hljs-attr">plugins</span>: <span class="hljs-title class_">Plugin</span>[]): <span class="hljs-function"><span class="hljs-params">PluginContainer</span> =></span> {
  <span class="hljs-comment">// æ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡</span>
  <span class="hljs-comment">// @ts-ignore è¿™é‡Œä»…å®ç°ä¸Šä¸‹æ–‡å¯¹è±¡çš„ resolve æ–¹æ³•</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RollupPluginContext</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, importer?: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-keyword">let</span> out = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">resolveId</span>(id, importer);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> out === <span class="hljs-string">"string"</span>) out = { <span class="hljs-attr">id</span>: out };
      <span class="hljs-keyword">return</span> out <span class="hljs-keyword">as</span> <span class="hljs-title class_">ResolvedId</span> | <span class="hljs-literal">null</span>;
    }
  }
  <span class="hljs-comment">// æ’ä»¶å®¹å™¨</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">pluginContainer</span>: <span class="hljs-title class_">PluginContainer</span> = {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, importer?: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> plugins) {
        <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">resolveId</span>) {
          <span class="hljs-keyword">const</span> newId = <span class="hljs-keyword">await</span> plugin.<span class="hljs-property">resolveId</span>.<span class="hljs-title function_">call</span>(ctx <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, id, importer);
          <span class="hljs-keyword">if</span> (newId) {
            id = <span class="hljs-keyword">typeof</span> newId === <span class="hljs-string">"string"</span> ? newId : newId.<span class="hljs-property">id</span>;
            <span class="hljs-keyword">return</span> { id };
          }
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> plugins) {
        <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">load</span>) {
          <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> plugin.<span class="hljs-property">load</span>.<span class="hljs-title function_">call</span>(ctx, id);
          <span class="hljs-keyword">if</span> (result) {
            <span class="hljs-keyword">return</span> result;
          }
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> plugins) {
        <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">transform</span>) {
          <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> plugin.<span class="hljs-property">transform</span>.<span class="hljs-title function_">call</span>(ctx, code, id);
          <span class="hljs-keyword">if</span> (!result) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"string"</span>) {
            code = result;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span>) {
            code = result.<span class="hljs-property">code</span>;
          }
        }
      }
      <span class="hljs-keyword">return</span> { code };
    },
  };

  <span class="hljs-keyword">return</span> pluginContainer;
};
</code></pre>
<p>ä¸Šé¢çš„ä»£ç æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå¹¶ä¸”å…³äºæ’ä»¶é’©å­çš„æ‰§è¡ŒåŸç†å’Œæ’ä»¶ä¸Šä¸‹æ–‡å¯¹è±¡çš„ä½œç”¨ï¼Œåœ¨å°å†Œç¬¬ 22 èŠ‚ä¸­ä¹Ÿæœ‰è¯¦ç»†çš„åˆ†æï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<p>æ¥ç€ï¼Œæˆ‘ä»¬æ¥å®Œå–„ä¸€ä¸‹ä¹‹å‰çš„æœåŠ¡å™¨é€»è¾‘:</p>
<pre><code class="hljs language-diff">// src/node/server/index.ts
import connect from "connect";
import { blue, green } from "picocolors";
import { optimize } from "../optimizer/index";
<span class="hljs-addition">+ import { resolvePlugins } from "../plugins";</span>
<span class="hljs-addition">+ import { createPluginContainer, PluginContainer } from "../pluginContainer";</span>

export interface ServerContext {
<span class="hljs-addition">+  root: string;</span>
<span class="hljs-addition">+  pluginContainer: PluginContainer;</span>
<span class="hljs-addition">+  app: connect.Server;</span>
<span class="hljs-addition">+  plugins: Plugin[];</span>
}

export async function startDevServer() {
  const app = connect();
  const root = process.cwd();
  const startTime = Date.now();
<span class="hljs-addition">+  const plugins = resolvePlugins();</span>
<span class="hljs-addition">+  const pluginContainer = createPluginContainer(plugins);</span>

<span class="hljs-addition">+  const serverContext: ServerContext = {</span>
<span class="hljs-addition">+    root: process.cwd(),</span>
<span class="hljs-addition">+    app,</span>
<span class="hljs-addition">+    pluginContainer,</span>
<span class="hljs-addition">+    plugins,</span>
<span class="hljs-addition">+  };</span>

<span class="hljs-addition">+  for (const plugin of plugins) {</span>
<span class="hljs-addition">+    if (plugin.configureServer) {</span>
<span class="hljs-addition">+      await plugin.configureServer(serverContext);</span>
<span class="hljs-addition">+    }</span>
<span class="hljs-addition">+  }</span>

  app.listen(3000, async () => {
    await optimize(root);
    console.log(
      green("ğŸš€ No-Bundle æœåŠ¡å·²ç»æˆåŠŸå¯åŠ¨!"),
      `è€—æ—¶: ${Date.now() - startTime}ms`
    );
    console.log(`> æœ¬åœ°è®¿é—®è·¯å¾„: ${blue("http://localhost:3000")}`);
  });
}
</code></pre>
<p>å…¶ä¸­ <code>resolvePlugins</code> æ–¹æ³•æˆ‘ä»¬è¿˜æœªå®šä¹‰ï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/plugins/index.ts</code> æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../plugin"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePlugins</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Plugin</span>[] {
  <span class="hljs-comment">// ä¸‹ä¸€éƒ¨åˆ†ä¼šé€ä¸ªè¡¥å……æ’ä»¶é€»è¾‘</span>
  <span class="hljs-keyword">return</span> [];
}
</code></pre>
<h2>å…¥å£ HTML åŠ è½½</h2>
<p>ç°åœ¨æˆ‘ä»¬åŸºäºå¦‚ä¸Šçš„æ’ä»¶æœºåˆ¶ï¼Œæ¥å®ç° Vite çš„æ ¸å¿ƒç¼–è¯‘èƒ½åŠ›ã€‚</p>
<p>é¦–å…ˆè¦è€ƒè™‘çš„å°±æ˜¯å…¥å£ HTML å¦‚ä½•ç¼–è¯‘å’ŒåŠ è½½çš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªæœåŠ¡ä¸­é—´ä»¶ï¼Œé…åˆæ’ä»¶æœºåˆ¶æ¥å®ç°ã€‚å…·ä½“è€Œè¨€ï¼Œä½ å¯ä»¥æ–°å»º<code>src/node/server/middlewares/indexHtml.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextHandleFunction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"connect"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../index"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { pathExists, readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs-extra"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">indexHtmlMiddware</span>(<span class="hljs-params">
  serverContext: ServerContext
</span>): <span class="hljs-title class_">NextHandleFunction</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) => {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">"/"</span>) {
      <span class="hljs-keyword">const</span> { root } = serverContext;
      <span class="hljs-comment">// é»˜è®¤ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ index.html</span>
      <span class="hljs-keyword">const</span> indexHtmlPath = path.<span class="hljs-title function_">join</span>(root, <span class="hljs-string">"index.html"</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(indexHtmlPath)) {
        <span class="hljs-keyword">const</span> rawHtml = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(indexHtmlPath, <span class="hljs-string">"utf8"</span>);
        <span class="hljs-keyword">let</span> html = rawHtml;
        <span class="hljs-comment">// é€šè¿‡æ‰§è¡Œæ’ä»¶çš„ transformIndexHtml æ–¹æ³•æ¥å¯¹ HTML è¿›è¡Œè‡ªå®šä¹‰çš„ä¿®æ”¹</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> plugin <span class="hljs-keyword">of</span> serverContext.<span class="hljs-property">plugins</span>) {
          <span class="hljs-keyword">if</span> (plugin.<span class="hljs-property">transformIndexHtml</span>) {
            html = <span class="hljs-keyword">await</span> plugin.<span class="hljs-title function_">transformIndexHtml</span>(html);
          }
        }

        res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/html"</span>);
        <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(html);
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();
  };
}
</code></pre>
<p>ç„¶ååœ¨æœåŠ¡ä¸­åº”ç”¨è¿™ä¸ªä¸­é—´ä»¶:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/server/index.ts</span>
<span class="hljs-comment">// éœ€è¦å¢åŠ çš„å¼•å…¥è¯­å¥</span>
<span class="hljs-keyword">import</span> { indexHtmlMiddware } <span class="hljs-keyword">from</span> <span class="hljs-string">"./middlewares/indexHtml"</span>;

<span class="hljs-comment">// çœç•¥ä¸­é—´çš„ä»£ç </span>

<span class="hljs-comment">// å¤„ç†å…¥å£ HTML èµ„æº</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">indexHtmlMiddware</span>(serverContext));

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-keyword">async</span> () => {
  <span class="hljs-comment">// çœç•¥</span>
});
</code></pre>
<p>æ¥ä¸‹æ¥é€šè¿‡<code>pnpm dev</code>å¯åŠ¨é¡¹ç›®ï¼Œç„¶åè®¿é—®<code>http://localhost:3000</code>ï¼Œä»ç½‘ç»œé¢æ¿ä¸­ä½ å¯ä»¥æŸ¥çœ‹åˆ° HTML çš„å†…å®¹å·²ç»æˆåŠŸè¿”å›:</p>
<p><img src="img\caf8a03a-ae61-11ed-afe8-342eb7027b95.jpg" alt="image.png"></p>
<p>ä¸è¿‡å½“å‰çš„é¡µé¢å¹¶æ²¡æœ‰ä»»ä½•å†…å®¹ï¼Œå› ä¸º HTML ä¸­å¼•å…¥çš„ TSX æ–‡ä»¶å¹¶æ²¡æœ‰è¢«æ­£ç¡®ç¼–è¯‘ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥å¤„ç† TSX æ–‡ä»¶çš„ç¼–è¯‘å·¥ä½œã€‚</p>
<h2>JS/TS/JSX/TSX ç¼–è¯‘èƒ½åŠ›</h2>
<p>é¦–å…ˆæ–°å¢ä¸€ä¸ªä¸­é—´ä»¶<code>src/node/server/middlewares/transform.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextHandleFunction</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"connect"</span>;
<span class="hljs-keyword">import</span> {
  isJSRequest,
  cleanUrl,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"../../utils"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../index"</span>;
<span class="hljs-keyword">import</span> createDebug <span class="hljs-keyword">from</span> <span class="hljs-string">"debug"</span>;

<span class="hljs-keyword">const</span> debug = <span class="hljs-title function_">createDebug</span>(<span class="hljs-string">"dev"</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformRequest</span>(<span class="hljs-params">
  url: <span class="hljs-built_in">string</span>,
  serverContext: ServerContext
</span>) {
  <span class="hljs-keyword">const</span> { pluginContainer } = serverContext;
  url = <span class="hljs-title function_">cleanUrl</span>(url);
  <span class="hljs-comment">// ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¾æ¬¡è°ƒç”¨æ’ä»¶å®¹å™¨çš„ resolveIdã€loadã€transform æ–¹æ³•</span>
  <span class="hljs-keyword">const</span> resolvedResult = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">resolveId</span>(url);
  <span class="hljs-keyword">let</span> transformResult;
  <span class="hljs-keyword">if</span> (resolvedResult?.<span class="hljs-property">id</span>) {
    <span class="hljs-keyword">let</span> code = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">load</span>(resolvedResult.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> code === <span class="hljs-string">"object"</span> &#x26;&#x26; code !== <span class="hljs-literal">null</span>) {
      code = code.<span class="hljs-property">code</span>;
    }
    <span class="hljs-keyword">if</span> (code) {
      transformResult = <span class="hljs-keyword">await</span> pluginContainer.<span class="hljs-title function_">transform</span>(
        code <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>,
        resolvedResult?.<span class="hljs-property">id</span>
      );
    }
  }
  <span class="hljs-keyword">return</span> transformResult;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMiddleware</span>(<span class="hljs-params">
  serverContext: ServerContext
</span>): <span class="hljs-title class_">NextHandleFunction</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (req, res, next) => {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">method</span> !== <span class="hljs-string">"GET"</span> || !req.<span class="hljs-property">url</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();
    }
    <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">url</span>;
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">"transformMiddleware: %s"</span>, url);
    <span class="hljs-comment">// transform JS request</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isJSRequest</span>(url)) {
      <span class="hljs-comment">// æ ¸å¿ƒç¼–è¯‘å‡½æ•°</span>
      <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">transformRequest</span>(url, serverContext);
      <span class="hljs-keyword">if</span> (!result) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>();
      }
      <span class="hljs-keyword">if</span> (result &#x26;&#x26; <span class="hljs-keyword">typeof</span> result !== <span class="hljs-string">"string"</span>) {
        result = result.<span class="hljs-property">code</span>;
      }
      <span class="hljs-comment">// ç¼–è¯‘å®Œæˆï¼Œè¿”å›å“åº”ç»™æµè§ˆå™¨</span>
      res.<span class="hljs-property">statusCode</span> = <span class="hljs-number">200</span>;
      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/javascript"</span>);
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">end</span>(result);
    }

    <span class="hljs-title function_">next</span>();
  };
}
</code></pre>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦è¡¥å……å¦‚ä¸‹çš„å·¥å…·å‡½æ•°å’Œå¸¸é‡å®šä¹‰:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/utils.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">JS_TYPES_RE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants.ts'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isJSRequest = (<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">boolean</span> =></span> {
  id = <span class="hljs-title function_">cleanUrl</span>(id);
  <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">JS_TYPES_RE</span>.<span class="hljs-title function_">test</span>(id)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">if</span> (!path.<span class="hljs-title function_">extname</span>(id) &#x26;&#x26; !id.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">"/"</span>)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> cleanUrl = (<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">string</span> =></span>
  url.<span class="hljs-title function_">replace</span>(<span class="hljs-variable constant_">HASH_RE</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-variable constant_">QEURY_RE</span>, <span class="hljs-string">""</span>);
  
<span class="hljs-comment">// src/node/constants.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">JS_TYPES_RE</span> = <span class="hljs-regexp">/\.(?:j|t)sx?$|\.mjs$/</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">QEURY_RE</span> = <span class="hljs-regexp">/\?.*$/</span>s;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HASH_RE</span> = <span class="hljs-regexp">/#.*$/</span>s;
</code></pre>
<p>ä»å¦‚ä¸Šçš„æ ¸å¿ƒç¼–è¯‘å‡½æ•°<code>transformRequest</code>å¯ä»¥çœ‹å‡ºï¼ŒVite å¯¹äº JS/TS/JSX/TSX æ–‡ä»¶çš„ç¼–è¯‘æµç¨‹ä¸»è¦æ˜¯ä¾æ¬¡è°ƒç”¨æ’ä»¶å®¹å™¨çš„å¦‚ä¸‹æ–¹æ³•:</p>
<ul>
<li>resolveId</li>
<li>load</li>
<li>transform</li>
</ul>
<p>å…¶ä¸­ä¼šç»å†ä¼—å¤šæ’ä»¶çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆï¼Œå¯¹äº TSX æ–‡ä»¶çš„ç¼–è¯‘é€»è¾‘ï¼Œä¹Ÿåˆ†æ•£åˆ°äº†å„ä¸ªæ’ä»¶å½“ä¸­ï¼Œå…·ä½“æ¥è¯´ä¸»è¦åŒ…å«ä»¥ä¸‹çš„æ’ä»¶:</p>
<ul>
<li>è·¯å¾„è§£ææ’ä»¶</li>
<li>Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶</li>
<li>import åˆ†ææ’ä»¶</li>
</ul>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¼€å§‹ä¾æ¬¡å®ç°è¿™äº›æ’ä»¶ã€‚</p>
<h3>1. è·¯å¾„è§£ææ’ä»¶</h3>
<p>å½“æµè§ˆå™¨è§£æåˆ°å¦‚ä¸‹çš„æ ‡ç­¾æ—¶:</p>
<pre><code class="hljs language-html"><span class="hljs-tag">&#x3C;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.tsx"</span>></span><span class="hljs-tag">&#x3C;/<span class="hljs-name">script</span>></span>
</code></pre>
<p>ä¼šè‡ªåŠ¨å‘é€ä¸€ä¸ªè·¯å¾„ä¸º<code>/src/main.tsx</code>çš„è¯·æ±‚ï¼Œä½†å¦‚æœæœåŠ¡ç«¯ä¸åšä»»ä½•å¤„ç†ï¼Œæ˜¯æ— æ³•å®šä½åˆ°æºæ–‡ä»¶çš„ï¼Œéšä¹‹ä¼šè¿”å› 404 çŠ¶æ€ç :</p>
<p><img src="img\cb0db38c-ae61-11ed-8a2a-342eb7027b95.jpg" alt="image.png"></p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å‘ä¸€ä¸ªè·¯å¾„è§£ææ’ä»¶ï¼Œå¯¹è¯·æ±‚çš„è·¯å¾„è¿›è¡Œå¤„ç†ï¼Œä½¿ä¹‹èƒ½è½¬æ¢çœŸå®æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ã€‚ä½ å¯ä»¥æ–°å»ºæ–‡ä»¶<code>src/node/plugins/resolve.ts</code>ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> resolve <span class="hljs-keyword">from</span> <span class="hljs-string">"resolve"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../plugin"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../server/index"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { pathExists } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs-extra"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_EXTERSIONS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../constants"</span>;
<span class="hljs-keyword">import</span> { cleanUrl, normalizePath } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePlugin</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverContext</span>: <span class="hljs-title class_">ServerContext</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"m-vite:resolve"</span>,
    <span class="hljs-title function_">configureServer</span>(<span class="hljs-params">s</span>) {
      <span class="hljs-comment">// ä¿å­˜æœåŠ¡ç«¯ä¸Šä¸‹æ–‡</span>
      serverContext = s;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">resolveId</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, importer?: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-comment">// 1. ç»å¯¹è·¯å¾„</span>
      <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">isAbsolute</span>(id)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(id)) {
          <span class="hljs-keyword">return</span> { id };
        }
        <span class="hljs-comment">// åŠ ä¸Š root è·¯å¾„å‰ç¼€ï¼Œå¤„ç† /src/main.tsx çš„æƒ…å†µ</span>
        id = path.<span class="hljs-title function_">join</span>(serverContext.<span class="hljs-property">root</span>, id);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(id)) {
          <span class="hljs-keyword">return</span> { id };
        }
      }
      <span class="hljs-comment">// 2. ç›¸å¯¹è·¯å¾„</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"."</span>)) {
        <span class="hljs-keyword">if</span> (!importer) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"`importer` should not be undefined"</span>);
        }
        <span class="hljs-keyword">const</span> hasExtension = path.<span class="hljs-title function_">extname</span>(id).<span class="hljs-property">length</span> > <span class="hljs-number">1</span>;
        <span class="hljs-keyword">let</span> <span class="hljs-attr">resolvedId</span>: <span class="hljs-built_in">string</span>;
        <span class="hljs-comment">// 2.1 åŒ…å«æ–‡ä»¶ååç¼€</span>
        <span class="hljs-comment">// å¦‚ ./App.tsx</span>
        <span class="hljs-keyword">if</span> (hasExtension) {
          resolvedId = <span class="hljs-title function_">normalizePath</span>(resolve.<span class="hljs-title function_">sync</span>(id, { <span class="hljs-attr">basedir</span>: path.<span class="hljs-title function_">dirname</span>(importer) }));
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(resolvedId)) {
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: resolvedId };
          }
        } 
        <span class="hljs-comment">// 2.2 ä¸åŒ…å«æ–‡ä»¶ååç¼€</span>
        <span class="hljs-comment">// å¦‚ ./App</span>
        <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// ./App -> ./App.tsx</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> extname <span class="hljs-keyword">of</span> <span class="hljs-variable constant_">DEFAULT_EXTERSIONS</span>) {
            <span class="hljs-keyword">try</span> {
              <span class="hljs-keyword">const</span> withExtension = <span class="hljs-string">`<span class="hljs-subst">${id}</span><span class="hljs-subst">${extname}</span>`</span>;
              resolvedId = <span class="hljs-title function_">normalizePath</span>(resolve.<span class="hljs-title function_">sync</span>(withExtension, {
                <span class="hljs-attr">basedir</span>: path.<span class="hljs-title function_">dirname</span>(importer),
              }));
              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> <span class="hljs-title function_">pathExists</span>(resolvedId)) {
                <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: resolvedId };
              }
            } <span class="hljs-keyword">catch</span> (e) {
              <span class="hljs-keyword">continue</span>;
            }
          }
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
  };
}
</code></pre>
<p>è¿™æ ·å¯¹äº <code>/src/main.tsx</code>ï¼Œåœ¨æ’ä»¶ä¸­ä¼šè½¬æ¢ä¸ºæ–‡ä»¶ç³»ç»Ÿä¸­çš„çœŸå®è·¯å¾„ï¼Œä»è€Œè®©æ¨¡å—åœ¨ load é’©å­ä¸­èƒ½å¤Ÿæ­£å¸¸åŠ è½½(åŠ è½½é€»è¾‘åœ¨ Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶å®ç°)ã€‚</p>
<p>æ¥ç€æˆ‘ä»¬æ¥è¡¥å……ä¸€ä¸‹ç›®å‰ç¼ºå°‘çš„å¸¸é‡:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/constants.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_EXTERSIONS</span> = [<span class="hljs-string">".tsx"</span>, <span class="hljs-string">".ts"</span>, <span class="hljs-string">".jsx"</span>, <span class="hljs-string">"js"</span>];
</code></pre>
<h3>2. Esbuild è¯­æ³•ç¼–è¯‘æ’ä»¶</h3>
<p>è¿™ä¸ªæ’ä»¶çš„ä½œç”¨æ¯”è¾ƒå¥½ç†è§£ï¼Œå°±æ˜¯å°† JS/TS/JSX/TSX ç¼–è¯‘æˆæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„ JS è¯­æ³•ï¼Œå¯ä»¥åˆ©ç”¨ Esbuild çš„ Transform API æ¥å®ç°ã€‚ä½ å¯ä»¥æ–°å»º<code>src/node/plugins/esbuild.ts</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts"><span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs-extra"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../plugin"</span>;
<span class="hljs-keyword">import</span> { isJSRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils"</span>;
<span class="hljs-keyword">import</span> esbuild <span class="hljs-keyword">from</span> <span class="hljs-string">"esbuild"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">esbuildTransformPlugin</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"m-vite:esbuild-transform"</span>,
    <span class="hljs-comment">// åŠ è½½æ¨¡å—</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">id</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isJSRequest</span>(id)) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> code = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(id, <span class="hljs-string">"utf-8"</span>);
          <span class="hljs-keyword">return</span> code;
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
      }
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, id</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isJSRequest</span>(id)) {
        <span class="hljs-keyword">const</span> extname = path.<span class="hljs-title function_">extname</span>(id).<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">code</span>: transformedCode, map } = <span class="hljs-keyword">await</span> esbuild.<span class="hljs-title function_">transform</span>(code, {
          <span class="hljs-attr">target</span>: <span class="hljs-string">"esnext"</span>,
          <span class="hljs-attr">format</span>: <span class="hljs-string">"esm"</span>,
          <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">loader</span>: extname <span class="hljs-keyword">as</span> <span class="hljs-string">"js"</span> | <span class="hljs-string">"ts"</span> | <span class="hljs-string">"jsx"</span> | <span class="hljs-string">"tsx"</span>,
        });
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">code</span>: transformedCode,
          map,
        };
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },
  };
}
</code></pre>
<h3>3. import åˆ†ææ’ä»¶</h3>
<p>åœ¨å°† TSX è½¬æ¢ä¸ºæµè§ˆå™¨å¯ä»¥è¯†åˆ«çš„è¯­æ³•ä¹‹åï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥ç›´æ¥è¿”å›ç»™æµè§ˆå™¨æ‰§è¡Œäº†å‘¢ï¼Ÿ</p>
<p>æ˜¾ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬è¿˜è€ƒè™‘å¦‚ä¸‹çš„ä¸€äº›é—®é¢˜:</p>
<ul>
<li>å¯¹äºç¬¬ä¸‰æ–¹ä¾èµ–è·¯å¾„(bare import)ï¼Œéœ€è¦é‡å†™ä¸ºé¢„æ„å»ºäº§ç‰©è·¯å¾„ï¼›</li>
<li>å¯¹äºç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦å€ŸåŠ©ä¹‹å‰çš„è·¯å¾„è§£ææ’ä»¶è¿›è¡Œè§£æã€‚</li>
</ul>
<p>å¥½ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±åœ¨ import åˆ†ææ’ä»¶ä¸­ä¸€ä¸€è§£å†³è¿™äº›é—®é¢˜:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// æ–°å»º src/node/plugins/importAnalysis.ts</span>
<span class="hljs-keyword">import</span> { init, parse } <span class="hljs-keyword">from</span> <span class="hljs-string">"es-module-lexer"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-variable constant_">BARE_IMPORT_RE</span>,
  <span class="hljs-variable constant_">DEFAULT_EXTERSIONS</span>,
  <span class="hljs-variable constant_">PRE_BUNDLE_DIR</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"../constants"</span>;
<span class="hljs-keyword">import</span> {
  cleanUrl,
  isJSRequest,
  normalizePath
} <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils"</span>;
<span class="hljs-comment">// magic-string ç”¨æ¥ä½œå­—ç¬¦ä¸²ç¼–è¾‘</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MagicString</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"magic-string"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../plugin"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ServerContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../server/index"</span>;
<span class="hljs-keyword">import</span> { pathExists } <span class="hljs-keyword">from</span> <span class="hljs-string">"fs-extra"</span>;
<span class="hljs-keyword">import</span> resolve <span class="hljs-keyword">from</span> <span class="hljs-string">"resolve"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">importAnalysisPlugin</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Plugin</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">serverContext</span>: <span class="hljs-title class_">ServerContext</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"m-vite:import-analysis"</span>,
    <span class="hljs-title function_">configureServer</span>(<span class="hljs-params">s</span>) {
      <span class="hljs-comment">// ä¿å­˜æœåŠ¡ç«¯ä¸Šä¸‹æ–‡</span>
      serverContext = s;
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-comment">// åªå¤„ç† JS ç›¸å…³çš„è¯·æ±‚</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isJSRequest</span>(id)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      }
      <span class="hljs-keyword">await</span> init;
      <span class="hljs-comment">// è§£æ import è¯­å¥</span>
      <span class="hljs-keyword">const</span> [imports] = <span class="hljs-title function_">parse</span>(code);
      <span class="hljs-keyword">const</span> ms = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MagicString</span>(code);
      <span class="hljs-comment">// å¯¹æ¯ä¸€ä¸ª import è¯­å¥ä¾æ¬¡è¿›è¡Œåˆ†æ</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> importInfo <span class="hljs-keyword">of</span> imports) {
        <span class="hljs-comment">// ä¸¾ä¾‹è¯´æ˜: const str = `import React from 'react'`</span>
        <span class="hljs-comment">// str.slice(s, e) => 'react'</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">s</span>: modStart, <span class="hljs-attr">e</span>: modEnd, <span class="hljs-attr">n</span>: modSource } = importInfo;
        <span class="hljs-keyword">if</span> (!modSource) <span class="hljs-keyword">continue</span>;
        <span class="hljs-comment">// ç¬¬ä¸‰æ–¹åº“: è·¯å¾„é‡å†™åˆ°é¢„æ„å»ºäº§ç‰©çš„è·¯å¾„</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">BARE_IMPORT_RE</span>.<span class="hljs-title function_">test</span>(modSource)) {
           <span class="hljs-keyword">const</span> bundlePath = <span class="hljs-title function_">normalizePath</span>(
            path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'/'</span>, <span class="hljs-variable constant_">PRE_BUNDLE_DIR</span>, <span class="hljs-string">`<span class="hljs-subst">${modSource}</span>.js`</span>)
          );
          ms.<span class="hljs-title function_">overwrite</span>(modStart, modEnd, bundlePath);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (modSource.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"."</span>) || modSource.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/"</span>)) {
          <span class="hljs-comment">// ç›´æ¥è°ƒç”¨æ’ä»¶ä¸Šä¸‹æ–‡çš„ resolve æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ç»è¿‡è·¯å¾„è§£ææ’ä»¶çš„å¤„ç†</span>
          <span class="hljs-keyword">const</span> resolved = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolve</span>(modSource, id);
          <span class="hljs-keyword">if</span> (resolved) {
            ms.<span class="hljs-title function_">overwrite</span>(modStart, modEnd, resolved.<span class="hljs-property">id</span>);
          }
        }
      }

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: ms.<span class="hljs-title function_">toString</span>(),
        <span class="hljs-comment">// ç”Ÿæˆ SourceMap</span>
        <span class="hljs-attr">map</span>: ms.<span class="hljs-title function_">generateMap</span>(),
      };
    },
  };
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¾¿å®Œæˆäº† JS ä»£ç çš„ import åˆ†æå·¥ä½œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠä¸Šé¢å®ç°çš„ä¸‰ä¸ªæ’ä»¶è¿›è¡Œæ³¨å†Œ:</p>
<pre><code class="hljs language-ts"><span class="hljs-comment">// src/node/plugin/index.ts</span>
<span class="hljs-keyword">import</span> { esbuildTransformPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./esbuild"</span>;
<span class="hljs-keyword">import</span> { importAnalysisPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./importAnalysis"</span>;
<span class="hljs-keyword">import</span> { resolvePlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">"./resolve"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../plugin"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">resolvePlugins</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Plugin</span>[] {
  <span class="hljs-keyword">return</span> [<span class="hljs-title function_">resolvePlugin</span>(), <span class="hljs-title function_">esbuildTransformPlugin</span>(), <span class="hljs-title function_">importAnalysisPlugin</span>()];
}

</code></pre>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨å†Œ transformMiddleware ä¸­é—´ä»¶ï¼Œåœ¨<code>src/node/server/index.ts</code>ä¸­å¢åŠ ä»£ç å¦‚ä¸‹:</p>
<pre><code class="hljs language-ts">app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">transformMiddleware</span>(serverContext));
</code></pre>
<p>ç„¶ååœ¨<code>playground</code>é¡¹ç›®ä¸‹æ‰§è¡Œ<code>pnpm dev</code>ï¼Œåœ¨æµè§ˆå™¨é‡Œé¢è®¿é—®<code>http://localhost:3000</code>ï¼Œä½ å¯ä»¥åœ¨ç½‘ç»œé¢æ¿ä¸­å‘ç° <code>main.tsx</code> çš„å†…å®¹ä»¥åŠè¢«ç¼–è¯‘ä¸ºä¸‹é¢è¿™æ ·:</p>
<p><img src="img\cb29d381-ae61-11ed-8057-342eb7027b95.jpg" alt="image.png"></p>
<p>åŒæ—¶ï¼Œé¡µé¢å†…å®¹ä¹Ÿèƒ½è¢«æ¸²æŸ“å‡ºæ¥äº†:</p>
<p><img src="img\cb4041b7-ae61-11ed-a9df-342eb7027b95.jpg" alt="image.png"></p>
<p>OKï¼Œç›®å‰ä¸ºæ­¢æˆ‘ä»¬å°±åŸºæœ¬ä¸Šå®Œæˆ JS/TS/JSX/TSX æ–‡ä»¶çš„ç¼–è¯‘ã€‚</p>
<h2>å°ç»“</h2>
<p>æœ¬å°èŠ‚çš„å†…å®¹å°±åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¦‚æœèƒ½ä¸€ç›´è·Ÿç€åšåˆ°è¿™é‡Œï¼Œä¹Ÿå·²ç»æ”¶è·æ»¡æ»¡äº†ã€‚æˆ‘ä»¬æœ€åæ¥å›é¡¾å’Œå°ç»“ä¸€ä¸‹ï¼Œè¿™ä¸€èŠ‚æˆ‘ä»¬ä¸»è¦æ¥æ‰‹å†™ Vite çš„ no-bundle æœåŠ¡ï¼Œå®Œæˆäº†<strong>å¼€å‘ç¯å¢ƒæ­å»º</strong>ã€<strong>é¢„æ„å»ºåŠŸèƒ½çš„å¼€å‘</strong>ã€<strong>æ’ä»¶æœºåˆ¶çš„æ­å»º</strong>ã€<strong>å…¥å£ HTML åŠ è½½</strong>å’Œ <strong>JS/TS/JSX/TSX çš„ç¼–è¯‘åŠŸèƒ½</strong>ã€‚</p>
<p>åœ¨ä¸‹ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°†ç»§ç»­å®Œå–„å½“å‰çš„ no-bundle æœåŠ¡å™¨ï¼Œå®Œæˆ CSS ç¼–è¯‘ã€é™æ€èµ„æºåŠ è½½å’Œ HMR ç³»ç»Ÿçš„å®ç°ï¼Œè®©æˆ‘ä»¬ä¸‹ä¸€èŠ‚å†è§ğŸ‘‹ğŸ»</p>
</div>
</body>
</html>